# 8.3 Railway PostgreSQL Deployment

## Overview

This system uses **Railway PostgreSQL** as the managed database hosting solution. Railway provides automatic backups, connection pooling, and seamless integration with the FastAPI backend.

---

## 8.3.1 Railway PostgreSQL Setup

### Step-by-Step Deployment

#### 1. Add PostgreSQL Service

```bash
# Railway Dashboard
1. Navigate to your project: "My-board-of-ideators"
2. Click "New" → "Database" → "Add PostgreSQL"
3. Railway auto-provisions database and generates credentials
```

#### 2. Auto-Generated Environment Variables

Railway automatically creates these environment variables:

| Variable | Example Value | Purpose |
|----------|---------------|---------|
| `DATABASE_URL` | `postgresql://postgres:password@containers-us-west-123.railway.app:5432/railway` | Full connection string |
| `POSTGRES_USER` | `postgres` | Database user |
| `POSTGRES_PASSWORD` | `generated_password` | Auto-generated password |
| `POSTGRES_DB` | `railway` | Database name |
| `POSTGRES_HOST` | `containers-us-west-123.railway.app` | Database host |
| `POSTGRES_PORT` | `5432` | Database port |

#### 3. Reference Variables in Backend Service

```bash
# Railway Backend Service (FastAPI)
# Variables are automatically available to connected services

DATABASE_URL=${{Postgres.DATABASE_URL}}
```

---

## 8.3.2 Connection String Configuration

### Vercel Frontend (with PgBouncer)

```bash
# Vercel Environment Variables
DATABASE_URL="postgresql://postgres:password@containers-us-west-123.railway.app:5432/railway?pgbouncer=true&connection_limit=1"
```

**Query Parameters:**
- `pgbouncer=true` - Enable PgBouncer connection pooling
- `connection_limit=1` - Limit to 1 connection per serverless function

### Railway Backend (Direct Connection)

```bash
# Railway Backend Service
DATABASE_URL="postgresql://postgres:password@containers-us-west-123.railway.app:5432/railway"
```

**No PgBouncer:** Long-running FastAPI process manages its own asyncpg connection pool.

### Local Development

```bash
# .env (local)
DATABASE_URL="postgresql://postgres:password@localhost:5432/innovation_dev"
```

---

## 8.3.3 Connection Pooling Strategy

### Comparison Table

| Environment | Connection String | Pool Type | Pool Size | Reasoning |
|-------------|-------------------|-----------|-----------|-----------|
| **Vercel (Prisma)** | `?pgbouncer=true&connection_limit=1` | PgBouncer | 1 per function | Serverless functions are short-lived |
| **Railway (asyncpg)** | Direct connection | asyncpg Pool | 5-20 | Long-running process, high write load |
| **Local Dev (Prisma)** | Direct connection | Prisma Pool | 1-5 | Single developer, minimal load |

### Why PgBouncer for Vercel?

**Problem:**
- Serverless functions spawn 10-100 instances during traffic spikes
- Each Prisma Client instance wants its own connection
- PostgreSQL has connection limit (~100 by default)

**Solution:**
- PgBouncer connection pooling prevents "too many connections" error
- Each serverless function gets 1 connection via pool
- Prisma singleton pattern reuses connection across hot reloads

---

## 8.3.4 Prisma Migration Deployment

### Development Workflow

```bash
# 1. Make schema changes in prisma/schema.prisma
# 2. Create migration locally
npx prisma migrate dev --name add_user_run_management

# Prisma generates:
#   - prisma/migrations/20250121_add_user_run_management/migration.sql
#   - Updates Prisma Client types
#   - Applies migration to local database

# 3. Commit migration to Git
git add prisma/migrations
git commit -m "feat: add user run management schema"

# 4. Push to repository
git push origin main
```

### Production Deployment (Automatic via Railway)

**package.json Build Script:**

```json
{
  "scripts": {
    "build": "prisma generate && prisma migrate deploy && next build",
    "start": "next start",
    "migrate": "prisma migrate deploy"
  }
}
```

**Railway Build Process:**

```bash
# 1. npm install
# Installs Prisma CLI and @prisma/client

# 2. npx prisma generate
# Generates Prisma Client from schema.prisma

# 3. npx prisma migrate deploy
# Applies pending migrations to Railway PostgreSQL

# 4. npm run build (or next build)
# Builds Next.js application
```

**Vercel Build Process:**

```bash
# 1. npm install
# 2. npx prisma generate  (Prisma Client only, NO migrations)
# 3. npm run build (next build)
```

**Important:** Migrations are run **ONLY** on Railway deployment, not Vercel.

---

## 8.3.5 Migration Rollback Strategy

### View Migration History

```bash
npx prisma migrate status

# Output:
# Status:
#   ✔️ 20250121000000_init
#   ✔️ 20250121120000_add_user_run_management
#   ✔️ 20250121150000_add_starred_field
```

### Development Rollback (Destructive)

```bash
# WARNING: Deletes all data and reapplies migrations
npx prisma migrate reset

# Use only in development, never production
```

### Production Rollback (Manual)

```bash
# 1. Identify migration to rollback
npx prisma migrate status

# 2. Create reverse migration
npx prisma migrate dev --name rollback_starred_field

# 3. Manually write reverse SQL in migration file
# prisma/migrations/20250121160000_rollback_starred_field/migration.sql

-- Reverse changes from add_starred_field migration
ALTER TABLE "OpportunityCard" DROP COLUMN starred;

# 4. Apply migration
npx prisma migrate deploy

# 5. Commit and push
git add prisma/migrations
git commit -m "rollback: remove starred field"
git push origin main
```

---

## 8.3.6 Environment Variable Management

### Vercel Environment Variables

```bash
# Vercel Dashboard → innovation-web → Settings → Environment Variables

# Database (with PgBouncer)
DATABASE_URL="postgresql://postgres:abc123@containers-us-west-123.railway.app:5432/railway?pgbouncer=true&connection_limit=1"

# Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# File Storage
BLOB_READ_WRITE_TOKEN=vercel_blob_...

# Backend URL
NEXT_PUBLIC_BACKEND_URL=https://my-board-of-ideators.railway.app
```

### Railway Backend Environment Variables

```bash
# Railway Dashboard → My-board-of-ideators → Variables

# Database (direct connection, auto-set by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# LLM
OPENROUTER_API_KEY=sk-or-v1-...
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
LLM_MODEL=anthropic/claude-sonnet-4.5

# File Storage (to download PDFs from Vercel Blob)
VERCEL_BLOB_READ_WRITE_TOKEN=vercel_blob_...

# Port (auto-set by Railway)
PORT=8000
```

---

## 8.3.7 Database Backup & Recovery

### Automatic Backups (Railway)

**Railway Starter Plan:**
- Daily automatic backups
- 7-day retention
- Point-in-time recovery

**Access Backups:**

```bash
# Railway Dashboard
1. Navigate to PostgreSQL service
2. Click "Backups" tab
3. Select backup to restore
4. Click "Restore" to create new database from backup
```

### Manual Backups (pg_dump)

```bash
# Export database schema and data
pg_dump $DATABASE_URL > backup.sql

# Restore from backup
psql $DATABASE_URL < backup.sql
```

### Export via Prisma Studio

```bash
# Open Prisma Studio
npx prisma studio

# Manually export data:
# 1. Select table
# 2. Filter rows
# 3. Export as CSV/JSON (browser dev tools)
```

---

## 8.3.8 Database Monitoring

### Railway Dashboard Metrics

**Available Metrics:**
- CPU usage
- Memory usage
- Disk usage
- Active connections
- Query performance

**Alerts:**
- Configure alerts for high connection count
- Email notifications for downtime

### Prisma Query Logging (Development)

```typescript
// lib/prisma.ts (development mode)
export const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },
    { level: 'error', emit: 'stdout' },
  ],
})

prisma.$on('query', (e) => {
  console.log('Query: ' + e.query)
  console.log('Duration: ' + e.duration + 'ms')
})
```

### asyncpg Connection Pool Monitoring

```python
# backend/app/services/database_service.py

async def get_pool_stats(self) -> Dict:
    """Monitor connection pool health."""
    if not self._pool:
        return {"status": "not_initialized"}

    return {
        "size": self._pool.get_size(),           # Current connections
        "min_size": self._pool.get_min_size(),   # Min pool size
        "max_size": self._pool.get_max_size(),   # Max pool size
        "idle": self._pool.get_idle_size()       # Idle connections
    }

# Expose via health check endpoint
@router.get("/health")
async def health_check():
    db = DatabaseService()
    pool_stats = await db.get_pool_stats()

    return {
        "status": "healthy",
        "database": pool_stats
    }
```

---

## 8.3.9 Performance Optimization

### Database Indexes (Prisma Schema)

```prisma
// Automatically created during migration

model User {
  @@index([clerkId])    // Fast auth lookup
  @@index([email])      // Fast email search
}

model Run {
  @@index([userId, createdAt])  // Fast paginated queries
  @@index([status])             // Filter by status
  @@index([companyId])          // Filter by company
}

model OpportunityCard {
  @@index([userId, starred])    // Fast starred card lookup
  @@index([userId, createdAt])  // User's cards by date
  @@index([runId, number])      // Cards for specific run
}
```

### Query Optimization Tips

**✅ Use Prisma's include for Relations:**

```typescript
// Efficient: Single query with joins
const run = await prisma.run.findUnique({
  where: { id: runId },
  include: {
    opportunityCards: true,
    inspirationReport: true
  }
})
```

**❌ Avoid N+1 Queries:**

```typescript
// Inefficient: N+1 queries (1 for runs, N for cards)
const runs = await prisma.run.findMany()
for (const run of runs) {
  const cards = await prisma.opportunityCard.findMany({
    where: { runId: run.id }
  })
}
```

### Connection Pool Limits

**Railway PostgreSQL Default Limits:**
- Max connections: 100
- Recommended usage: <80% (80 connections)

**Current Architecture Usage:**
- Vercel (PgBouncer): ~5-10 connections
- Railway (asyncpg): ~5-20 connections
- **Headroom:** 70-90 connections available

---

## 8.3.10 Security Best Practices

### Connection String Security

**✅ DO:**
- Store `DATABASE_URL` in environment variables only
- Never commit `.env` files to Git
- Use different credentials for development/production
- Rotate passwords every 90 days

**❌ DON'T:**
- Hardcode connection strings in code
- Share production credentials in Slack/email
- Use same credentials across environments

### SSL/TLS Encryption

```bash
# Railway PostgreSQL uses SSL by default
DATABASE_URL="postgresql://...?sslmode=require"
```

### Row-Level Security

**Implemented via Clerk User ID:**

```typescript
// EVERY Prisma query filters by authenticated user
const runs = await prisma.run.findMany({
  where: {
    user: { clerkId: userId }  // From auth()
  }
})
```

---

## 8.3.11 Troubleshooting

### Common Issues

#### "Too many connections"

**Symptoms:**
- Error: `FATAL: sorry, too many clients already`
- Occurs during traffic spikes

**Solution:**
- Verify PgBouncer is enabled in Vercel's `DATABASE_URL`
- Check connection pool size in asyncpg (should be 5-20)
- Monitor active connections in Railway dashboard

#### "Connection timeout"

**Symptoms:**
- Error: `connection timed out`
- Slow query performance

**Solution:**
- Check Railway database status (may be restarting)
- Verify network connectivity
- Increase `command_timeout` in asyncpg pool

#### "Migration failed"

**Symptoms:**
- Error: `P3009: migrate found failed migration`
- Migration stuck in "failed" state

**Solution:**

```bash
# Mark migration as applied manually
npx prisma migrate resolve --applied 20250121_migration_name

# OR: rollback and retry
npx prisma migrate resolve --rolled-back 20250121_migration_name
npx prisma migrate deploy
```

---

## 8.3.12 Cost Estimation

### Railway Pricing (as of 2025)

| Plan | Price | Included | Database Specs |
|------|-------|----------|----------------|
| **Starter** | $5/month | 5GB storage, 100 connections | PostgreSQL 15 |
| **Developer** | $20/month | 10GB storage, 200 connections | + point-in-time recovery |
| **Team** | $50/month | 25GB storage, 500 connections | + read replicas |

**Current Project:** Starter plan is sufficient for MVP (5GB storage, 100 connections)

**Scaling Triggers:**
- Storage > 5GB → Upgrade to Developer ($20/month)
- Connections > 100 → Upgrade to Developer ($20/month)
- Need read replicas → Upgrade to Team ($50/month)

---

## Summary

### Key Configuration

| Component | Connection String | Pool Type | Purpose |
|-----------|-------------------|-----------|---------|
| **Vercel Frontend** | `?pgbouncer=true&connection_limit=1` | PgBouncer | Serverless read queries |
| **Railway Backend** | Direct connection | asyncpg Pool (5-20) | Pipeline write operations |
| **Local Dev** | Direct connection | Prisma Pool (1-5) | Development testing |

### Deployment Checklist

- ✅ Add PostgreSQL service in Railway
- ✅ Copy `DATABASE_URL` to Vercel (with `?pgbouncer=true`)
- ✅ Set `DATABASE_URL` in Railway backend (auto-set)
- ✅ Add `prisma migrate deploy` to build script
- ✅ Commit migrations to Git before deploying
- ✅ Monitor connection pool usage in Railway dashboard
- ✅ Enable automatic backups (included in Starter plan)

---
