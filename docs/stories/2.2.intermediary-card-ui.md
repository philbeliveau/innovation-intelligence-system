# Story 2.2: Intermediary Card UI with Track Display

---

## Status

**Draft**

---

## Story

**As a** Innovation Manager,
**I want** to view a visually compelling intermediary card showing the analyzed document summary and ideation tracks after upload,
**so that** I can review the LLM's understanding before launching the full pipeline.

---

## Acceptance Criteria

1. **Intermediary Card Display**
   - Create `/app/analyze/[uploadId]/page.tsx` route with dynamic parameter
   - Display loading state with spinner and "Analyzing document..." message during LLM processing (30-60 seconds)
   - Render document analysis data in card layout matching reference design (`docs/image/intermediary-card.png`)

2. **Left Card - Document Summary Section**
   - Display LLM-generated title (10-15 words, prominent heading)
   - Show hero image placeholder (gradient or generic image)
   - Render source badges as dark gray pills
   - Show industry badge as orange pill
   - Show theme badge as red pill
   - Display 2-3 sentence summary (~50 words)
   - Include 3-dot pagination indicator at bottom

3. **Right Section - Ideation Tracks Display**
   - Display 2 ideation tracks side-by-side (matching `docs/image/track-division.png` UI)
   - Each track shows: checkmark/selected indicator, icon placeholder, title, 2-3 sentence summary
   - Both tracks displayed as pre-selected (no toggle interaction required for MVP)

4. **Launch Action**
   - Center-aligned "Launch" button below track cards
   - On click: POST to `/api/run` with `blob_url`, `upload_id`, and `selected_tracks: [1, 2]`
   - Show loading spinner on button during API call
   - Transition with animation from vertical card to horizontal pipeline view
   - Redirect to `/pipeline/{runId}` on successful API response

5. **API Integration with Story 2.1**
   - Retrieve `blob_url` from `sessionStorage` using `upload_${uploadId}` key (set in Story 1.2)
   - Call `/api/analyze-document` endpoint on page load
   - Parse response containing: `{ analysis: { title, summary, industry, theme, sources, tracks } }`

6. **Navigation Flow Continuity**
   - Maintain company context from cookie throughout flow
   - Pass `blob_url` and `upload_id` to `/api/run` endpoint
   - Preserve run state for pipeline viewer handoff

7. **Error Handling**
   - Display user-friendly error if analysis API fails
   - Show "Try Again" button to retry analysis
   - Redirect to homepage if `blob_url` not found in session

8. **UI/UX Standards**
   - Visual fidelity to reference designs: 90%+ match to `docs/image/intermediary-card.png`
   - Responsive layout using Tailwind responsive classes (desktop-first for MVP)
   - Accessible button states (disabled, loading, default)
   - Smooth loading transitions with skeleton states

9. **Code Quality**
   - TypeScript strict mode with proper typing
   - Client component with `'use client'` directive
   - Proper error boundaries for API failures
   - Clean separation of UI components

10. **Testing Coverage**
    - Manual test: Upload file → verify card displays correctly
    - Manual test: Click Launch → verify redirect to pipeline viewer
    - Manual test: Refresh page → verify graceful error handling

---

## Tasks / Subtasks

- [ ] **Task 1: Create Analyze Page Route** (AC: 1, 5, 6, 7)
  - [ ] Create `/app/analyze/[uploadId]/page.tsx` as client component
  - [ ] Add `'use client'` directive
  - [ ] Implement `useParams()` hook to get `uploadId` from route
  - [ ] Set up state management: `analysis`, `loading`, `error`, `launching`, `blobUrl`
  - [ ] Implement `useEffect()` to fetch blob URL from sessionStorage on mount
  - [ ] Add sessionStorage fallback with error handling for missing blob URL
  - [ ] Implement API call to `/api/analyze-document` with POST request
  - [ ] Add loading state display with spinner and "Analyzing document..." text
  - [ ] Add error state display with "Try Again" button
  - [ ] Implement TypeScript interfaces for `AnalysisData` type

- [ ] **Task 2: Build Document Summary Card Component** (AC: 2, 8)
  - [ ] Create `components/DocumentCard.tsx` component
  - [ ] Add hero image placeholder div with gradient (amber-200 to amber-400)
  - [ ] Display analysis title as `text-xl font-semibold`
  - [ ] Render source badges using shadcn/ui Badge component (variant="secondary")
  - [ ] Add logic to show first source + count of others (e.g., "8 others")
  - [ ] Render industry badge with `bg-orange-500` class
  - [ ] Render theme badge with `bg-red-600` class
  - [ ] Display summary paragraph with `text-sm text-gray-700`
  - [ ] Add 3-dot pagination indicator at bottom (3 gray circles)
  - [ ] Match layout from reference design `docs/image/intermediary-card.png`

- [ ] **Task 3: Build Ideation Tracks Display** (AC: 3, 8)
  - [ ] Create `components/TrackCard.tsx` component
  - [ ] Implement grid layout: `grid grid-cols-2 gap-4` for side-by-side tracks
  - [ ] Add checkmark icon (✓) with green color
  - [ ] Display "Track {N} (Selected)" label with font-semibold
  - [ ] Show track title as `font-medium`
  - [ ] Display track summary as `text-sm text-gray-600`
  - [ ] Add icon placeholder area
  - [ ] Match reference design `docs/image/track-division.png`
  - [ ] Map over `analysis.tracks` array to render both tracks

- [ ] **Task 4: Implement Launch Button with API Integration** (AC: 4, 6)
  - [ ] Add "Launch" button at bottom with full width
  - [ ] Implement `handleLaunch` async function
  - [ ] Set `launching` state to true on click
  - [ ] POST to `/api/run` with JSON body: `{ blob_url, upload_id, selected_tracks: [1, 2] }`
  - [ ] Parse response to extract `run_id`
  - [ ] Use `useRouter().push()` to navigate to `/pipeline/{run_id}`
  - [ ] Add error handling for failed API call
  - [ ] Display loading spinner on button when `launching === true`
  - [ ] Disable button during launch process
  - [ ] Update button text: "Launching Pipeline..." when loading

- [ ] **Task 5: Add Skeleton Loading States** (AC: 8)
  - [ ] Import shadcn/ui Skeleton component
  - [ ] Create skeleton layout for loading state
  - [ ] Add skeleton for hero image (w-full h-48)
  - [ ] Add skeleton for title (w-3/4 h-6)
  - [ ] Add skeleton for summary (w-full h-4)
  - [ ] Display skeleton during initial `loading === true` state

- [ ] **Task 6: Install Required shadcn/ui Components** (AC: 8, 9)
  - [ ] Run `npx shadcn-ui@latest add card`
  - [ ] Run `npx shadcn-ui@latest add badge`
  - [ ] Run `npx shadcn-ui@latest add button`
  - [ ] Run `npx shadcn-ui@latest add skeleton`
  - [ ] Verify imports work correctly

- [ ] **Task 7: Manual Testing & Validation** (AC: 10)
  - [ ] Test happy path: Upload file → verify intermediary card displays
  - [ ] Verify all badges render with correct colors (sources=gray, industry=orange, theme=red)
  - [ ] Verify both tracks display side-by-side with checkmarks
  - [ ] Test Launch button: Click → verify redirect to `/pipeline/{runId}`
  - [ ] Test error handling: Refresh page before analysis completes → verify error message
  - [ ] Test missing blob URL: Clear sessionStorage → verify redirect/error
  - [ ] Verify UI matches reference designs at 90%+ visual fidelity
  - [ ] Test responsive layout on different desktop screen sizes

---

## Dev Notes

### Context from Previous Stories

**Story 1.2 (File Upload to Vercel Blob):**
- Upload endpoint returns: `{ upload_id, blob_url, file_name, file_size, uploaded_at }`
- `blob_url` is stored in `sessionStorage` with key `upload_${upload_id}` by Story 1.3
- Session storage set in Story 1.3's upload handler after successful API response

**Story 2.1 (LLM Document Analysis API):**
- API endpoint: `POST /api/analyze-document`
- Request body: `{ blob_url: string }`
- Response format:
  ```typescript
  {
    upload_id: string,
    analysis: {
      title: string,         // "Ad-generating QR codes incorporated into..."
      summary: string,       // "Most people only wear a fraction..."
      industry: string,      // "fashion"
      theme: string,         // "marketing strategies"
      sources: string[],     // ["trendwatching.com", "8 others"]
      tracks: Array<{
        title: string,
        summary: string,
        icon_url?: string
      }>
    },
    blob_url: string,
    analyzed_at: string
  }
  ```
- Processing time: 30-60 seconds (LLM extraction)

### Relevant Source Tree

```
innovation-web/
├── app/
│   ├── analyze/
│   │   └── [uploadId]/
│   │       └── page.tsx          # CREATE THIS - Main intermediary card page
│   ├── api/
│   │   ├── analyze-document/
│   │   │   └── route.ts          # EXISTS from Story 2.1
│   │   └── run/
│   │       └── route.ts          # Will be created in Story 2.3/Epic 3
│   ├── upload/
│   │   └── page.tsx              # EXISTS from Story 1.3
│   └── page.tsx                  # EXISTS from Story 1.1 (root landing)
├── components/
│   ├── ui/                       # shadcn/ui components
│   │   ├── card.tsx
│   │   ├── badge.tsx
│   │   ├── button.tsx
│   │   └── skeleton.tsx
│   ├── DocumentCard.tsx          # CREATE THIS - Left card with summary
│   └── TrackCard.tsx             # CREATE THIS - Track display component
└── lib/
    └── utils.ts                  # shadcn/ui utilities
```

### Architecture References

**PRD Section 4.2 (Intermediary Card Page):**
- Visual reference: `docs/image/intermediary-card.png`, `docs/image/track-division.png`
- Layout: Left card (document summary) + Right section (2 tracks side-by-side)
- Navigation flow: Upload → Analyze → Pipeline Viewer
- Launch action triggers pipeline execution via `/api/run` endpoint

**Tech Stack:**
- Next.js 15 App Router with React Server Components
- TypeScript strict mode
- Tailwind CSS for styling
- shadcn/ui component library
- Client-side data fetching with `fetch()` API

**Component Patterns:**
- Use `'use client'` directive for interactive components
- Implement loading states with shadcn/ui Skeleton
- Error boundaries for graceful failure handling
- TypeScript interfaces for type safety

**Styling Conventions:**
- Badge colors: Sources (secondary/gray), Industry (orange-500), Theme (red-600)
- Card padding: `p-6` with `mb-6` spacing
- Button sizing: `size="lg"` for primary actions
- Responsive classes: Desktop-first with basic mobile support

### Important Implementation Notes

1. **Session Storage Key Format:** `upload_${uploadId}` (must match Story 1.3's storage pattern)
2. **Track Selection Logic:** For MVP, both tracks are always selected (hardcoded `[1, 2]`)
3. **Hero Image:** Use gradient only - no actual image upload/display in MVP
4. **API Error Handling:** Display user-friendly messages, avoid technical jargon
5. **Loading Spinner:** Use shadcn/ui Button's loading state (built-in spinner support)
6. **Navigation:** Use Next.js `useRouter()` from `next/navigation` (App Router, not Pages Router)

### Testing

**Manual Testing Checklist:**

1. **Happy Path Test:**
   - Upload PDF file via Story 1.3
   - Verify redirect to `/analyze/{uploadId}`
   - Wait 30-60 seconds for LLM analysis
   - Verify all UI elements render correctly
   - Click "Launch" button
   - Verify redirect to `/pipeline/{runId}`

2. **Error Scenarios:**
   - Test missing blob URL: Clear sessionStorage → verify error message + retry option
   - Test API failure: Mock 500 error → verify graceful error handling
   - Test network timeout: Slow connection → verify loading state persists

3. **UI Validation:**
   - Verify badge colors match specification (gray, orange, red)
   - Verify track cards display side-by-side
   - Verify checkmarks appear on both tracks
   - Verify button states: default, loading, disabled
   - Compare UI to reference images at 90%+ similarity

**Test File Location:**
- No automated tests required for MVP (manual testing only)
- Future: `app/analyze/[uploadId]/__tests__/page.test.tsx`

**Testing Standards:**
- Manual testing during development
- Visual comparison with reference designs
- Error scenario coverage (missing data, API failures)
- Cross-browser testing (Chrome, Safari, Firefox - latest versions)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation from brownfield-create-story task | John (PM Agent) |

---

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes List

*To be populated by dev agent*

### File List

*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent after implementation review*
