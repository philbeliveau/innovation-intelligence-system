# Story 8.9: Error Handling & Fallbacks

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P2
**Estimated Time:** 3-4 hours

---

## Status

**Approved**

---

## Story

**As a** CPG Innovation Manager using the Innovation Intelligence Pipeline,
**I want** clear error messages and graceful fallbacks when issues occur,
**so that** I understand what went wrong and can take appropriate action without losing my work or getting stuck.

---

## Acceptance Criteria

### 1. Network Error Handling (API Polling Failures)
- Polling endpoint: `GET /api/pipeline/[runId]/status`
- Network timeout (>10s): Show "Connection lost, retrying..." message
- Retry strategy: Exponential backoff (5s → 10s → 20s → 40s, max 5 retries)
- After 5 failed retries: Show error state with "Retry Now" button
- Error message: "Unable to connect. Check your internet connection."
- User action: Click "Retry Now" → Immediately restart polling
- Preserve pipeline state: Don't reset currentStage or status

### 2. Pipeline Failure State Handling
- Backend status response: `{ status: "FAILED", error: "Stage 3 timeout" }`
- UI state: Show red banner at top: "Pipeline failed during Stage 3"
- Error details: Expandable accordion with full error message
- User actions: "View Debug Logs" (opens logs in new tab), "Start New Pipeline"
- No polling: Stop polling when status === "FAILED"
- Data preservation: Keep partial results visible (Stages 1-2 if completed)
- Analytics: Log failure event with stage number and error type

### 3. Missing or Malformed Data Handling
- Missing opportunity cards: Show "No sparks generated yet" placeholder in State 3
- Malformed JSON: Log error, show fallback UI with "Data format error"
- Missing hero images: Show placeholder image (teal gradient or generic icon)
- Missing markdown content: Show "Content unavailable" message
- Partial data: Render available fields, hide missing fields gracefully
- Type validation: Use Zod schemas to validate API responses

### 4. Stage-Specific Error States
- **State 1 (Extraction)**: Timeout after 5 minutes → "Extraction taking longer than expected"
- **State 2 (Processing)**: Stuck on same stage for 10 minutes → "Processing delayed, please wait"
- **State 3 (Grid)**: Empty sparks array → "No sparks generated, please try a different document"
- **State 4 (Detail)**: Spark not found → Redirect to State 3 with toast "Spark not found"
- Show appropriate messaging per stage
- Provide stage-specific recovery actions

### 5. Graceful Degradation for Missing Features
- If download API fails: Hide download buttons, show "Download unavailable"
- If images fail to load: Show text-only version of sparks
- If animations fail: Fall back to instant state transitions
- If polling fails repeatedly: Offer manual refresh button
- If sidebar thumbnails fail: Show list view instead
- Progressive enhancement: Core functionality works without JavaScript (server-rendered)

### 6. User-Facing Error Messages (UX Copy)
- All error messages: Plain language, no technical jargon
- Avoid: "500 Internal Server Error", "Network timeout", "Null pointer exception"
- Use: "Something went wrong", "Connection lost", "Unable to load data"
- Action-oriented: Always provide next step ("Try again", "Go back", "Contact support")
- Empathetic tone: "We're having trouble...", "Please try again in a moment"
- Include timestamp: "Error occurred at 2:34 PM"

### 7. Error Logging and Monitoring
- Frontend: Log errors to console with context (runId, stage, action)
- Frontend: Send errors to backend logging endpoint (optional)
- Backend: Log errors with stack traces to Railway logs
- Sentry integration (optional): Track error frequency and user impact
- Error metadata: User agent, viewport size, network type
- Privacy: Don't log sensitive data (user emails, document content)

---

## Tasks / Subtasks

- [ ] Create error state components (AC: #2, #3, #4)
  - [ ] Create `innovation-web/components/error/ErrorBanner.tsx` (red banner, top)
  - [ ] Create `innovation-web/components/error/ErrorPlaceholder.tsx` (generic error UI)
  - [ ] Create `innovation-web/components/error/EmptyState.tsx` (no data placeholder)
  - [ ] Create `innovation-web/components/error/RetryButton.tsx` (retry action)
  - [ ] Style with Tailwind: Red (#EF4444), amber (#F59E0B), gray (#9CA3AF)

- [ ] Implement network error handling (AC: #1)
  - [ ] Update polling logic in `app/pipeline/[runId]/page.tsx`
  - [ ] Add timeout detection (>10s)
  - [ ] Add exponential backoff retry (5s, 10s, 20s, 40s)
  - [ ] Add max retry limit (5 attempts)
  - [ ] Show "Connection lost, retrying..." toast
  - [ ] Show "Retry Now" button after max retries
  - [ ] Test with throttled network (DevTools: Offline, Slow 3G)

- [ ] Handle pipeline failure state (AC: #2)
  - [ ] Detect `status === "FAILED"` in polling response
  - [ ] Stop polling when failed
  - [ ] Show `<ErrorBanner>` with error message
  - [ ] Add expandable accordion for full error details
  - [ ] Add "View Debug Logs" button → `/api/pipeline/[runId]/logs`
  - [ ] Add "Start New Pipeline" button → Navigate to upload page
  - [ ] Preserve partial results (show completed stages)

- [ ] Add type validation with Zod (AC: #3)
  - [ ] Install `zod` package: `npm install zod`
  - [ ] Create `innovation-web/lib/schemas.ts`
  - [ ] Define schemas: `PipelineStatusSchema`, `OpportunityCardSchema`, `StageSchema`
  - [ ] Validate API responses: `PipelineStatusSchema.safeParse(data)`
  - [ ] On validation error: Log error, show fallback UI
  - [ ] Example: Missing `heroImageUrl` → Use placeholder image

- [ ] Implement stage-specific error states (AC: #4)
  - [ ] State 1: Timeout after 5 minutes → Show "Extraction delayed" message
  - [ ] State 2: Stuck on same stage 10+ minutes → Show "Processing delayed" message
  - [ ] State 3: Empty sparks array → Show `<EmptyState>` with "No sparks generated"
  - [ ] State 4: Spark not found → Redirect to State 3 + toast notification
  - [ ] Add timer tracking: `useEffect` to detect stage duration
  - [ ] Test each state timeout scenario

- [ ] Add graceful degradation (AC: #5)
  - [ ] Download API fails → Hide download buttons
  - [ ] Hero images fail to load → Show placeholder image (teal gradient)
  - [ ] Animations fail → Set `prefers-reduced-motion` fallback
  - [ ] Polling fails repeatedly → Show manual refresh button
  - [ ] Sidebar thumbnails fail → Fallback to list view
  - [ ] Test with images blocked (DevTools: Disable cache + Block images)

- [ ] Write user-friendly error copy (AC: #6)
  - [ ] Create `innovation-web/lib/errorMessages.ts`
  - [ ] Map error codes to user-friendly messages
  - [ ] Examples:
    - `NETWORK_ERROR` → "Connection lost. Check your internet."
    - `PIPELINE_TIMEOUT` → "Processing is taking longer than expected."
    - `DATA_NOT_FOUND` → "We couldn't find the data you're looking for."
  - [ ] Include action buttons with each message
  - [ ] Add timestamp to errors: `new Date().toLocaleTimeString()`

- [ ] Implement error logging (AC: #7)
  - [ ] Create frontend error logger: `innovation-web/lib/logger.ts`
  - [ ] Log to console: `console.error('[Pipeline Error]', context)`
  - [ ] Log to backend (optional): `POST /api/logs/error`
  - [ ] Include metadata: runId, stage, userAgent, timestamp
  - [ ] Backend: Create `app/api/logs/error/route.ts` (save to Prisma or file)
  - [ ] Privacy: Sanitize error messages (remove PII)
  - [ ] Test logging: Trigger error, verify log appears in Railway

- [ ] Add error recovery actions (AC: #1, #2, #4)
  - [ ] Retry button: Restart polling from last known state
  - [ ] Refresh button: Reload page data without full refresh
  - [ ] Go back button: Navigate to previous state or upload page
  - [ ] Contact support button: Open mailto link or support form
  - [ ] Clear session button: Reset pipeline state (localStorage)
  - [ ] Test each action: Verify expected behavior

- [ ] Create error state tests (AC: #1-7)
  - [ ] Test network timeout → Shows retry message
  - [ ] Test pipeline failure → Shows error banner
  - [ ] Test malformed data → Shows fallback UI
  - [ ] Test missing images → Shows placeholder
  - [ ] Test empty sparks → Shows empty state
  - [ ] Test retry button → Restarts polling
  - [ ] Test error logging → Logs sent correctly

- [ ] Integration testing with error scenarios (AC: #1-7)
  - [ ] Simulate network timeout (DevTools: Offline)
  - [ ] Simulate 500 error (mock API response)
  - [ ] Simulate malformed JSON (mock API response)
  - [ ] Simulate missing sparks (empty array)
  - [ ] Simulate slow network (DevTools: Slow 3G)
  - [ ] Verify error messages are user-friendly
  - [ ] Verify recovery actions work

---

## Dev Notes

### Integration Points

**Components to Update:**
- `innovation-web/app/pipeline/[runId]/page.tsx` - Polling error handling
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Error state rendering
- `innovation-web/components/pipeline/SparksGrid.tsx` - Empty state handling
- `innovation-web/components/pipeline/ExpandedSparkDetail.tsx` - Missing spark handling

**New Files to Create:**
- `innovation-web/components/error/ErrorBanner.tsx` - Red banner for failures
- `innovation-web/components/error/ErrorPlaceholder.tsx` - Generic error UI
- `innovation-web/components/error/EmptyState.tsx` - No data placeholder
- `innovation-web/components/error/RetryButton.tsx` - Retry action button
- `innovation-web/lib/schemas.ts` - Zod validation schemas
- `innovation-web/lib/errorMessages.ts` - User-friendly error copy
- `innovation-web/lib/logger.ts` - Frontend error logger
- `innovation-web/app/api/logs/error/route.ts` - Backend error logging (optional)

**No Changes to Python Backend**

### Technical Details

**Zod Validation Schemas:**
```typescript
// lib/schemas.ts
import { z } from 'zod'

export const OpportunityCardSchema = z.object({
  id: z.string(),
  runId: z.string(),
  title: z.string(),
  heroImageUrl: z.string().url().optional(),
  summary: z.string().optional(),
  fullContent: z.string(),
  createdAt: z.string().datetime()
})

export const StageSchema = z.object({
  stageNumber: z.number().int().min(1).max(5),
  stageName: z.string(),
  status: z.enum(['PENDING', 'PROCESSING', 'COMPLETED', 'FAILED']),
  startedAt: z.string().datetime().nullable(),
  completedAt: z.string().datetime().nullable(),
  error: z.string().nullable()
})

export const PipelineStatusSchema = z.object({
  runId: z.string(),
  status: z.enum(['PROCESSING', 'COMPLETED', 'FAILED', 'CANCELLED']),
  currentStage: z.number().int().min(1).max(5),
  stages: z.array(StageSchema),
  error: z.string().nullable()
})

// Usage
const result = PipelineStatusSchema.safeParse(apiResponse)
if (!result.success) {
  console.error('Validation error:', result.error)
  // Show fallback UI
} else {
  const validData = result.data
  // Use validated data
}
```

**Error Logger:**
```typescript
// lib/logger.ts
interface ErrorContext {
  runId?: string
  stage?: number
  action?: string
  errorCode?: string
  userAgent?: string
}

export const logError = (message: string, context?: ErrorContext) => {
  const timestamp = new Date().toISOString()

  // Console logging (always)
  console.error('[Pipeline Error]', {
    timestamp,
    message,
    ...context
  })

  // Backend logging (optional, only in production)
  if (process.env.NODE_ENV === 'production') {
    fetch('/api/logs/error', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        timestamp,
        message,
        context: {
          ...context,
          userAgent: navigator.userAgent,
          url: window.location.href
        }
      })
    }).catch((err) => {
      // Silent fail - don't want logging to break app
      console.warn('Failed to send error log:', err)
    })
  }
}

// Usage
logError('Pipeline polling timeout', {
  runId: 'abc123',
  stage: 3,
  action: 'polling',
  errorCode: 'NETWORK_TIMEOUT'
})
```

**Error Messages:**
```typescript
// lib/errorMessages.ts
export const ERROR_MESSAGES = {
  NETWORK_TIMEOUT: {
    title: 'Connection Lost',
    message: 'We're having trouble connecting. Check your internet connection.',
    action: 'Retry Now'
  },
  PIPELINE_FAILED: {
    title: 'Pipeline Failed',
    message: 'Something went wrong during processing.',
    action: 'View Details'
  },
  DATA_NOT_FOUND: {
    title: 'Data Not Found',
    message: 'We couldn't find the data you're looking for.',
    action: 'Go Back'
  },
  EXTRACTION_TIMEOUT: {
    title: 'Processing Delayed',
    message: 'Extraction is taking longer than expected. Please wait a moment.',
    action: 'Continue Waiting'
  },
  NO_SPARKS_GENERATED: {
    title: 'No Sparks Generated',
    message: 'The pipeline didn't generate any opportunity cards. Try a different document.',
    action: 'Upload New Document'
  },
  DOWNLOAD_FAILED: {
    title: 'Download Failed',
    message: 'We couldn't generate the PDF. Please try again.',
    action: 'Retry Download'
  }
} as const

export type ErrorCode = keyof typeof ERROR_MESSAGES

export const getErrorMessage = (code: ErrorCode) => ERROR_MESSAGES[code]
```

**ErrorBanner Component:**
```typescript
// components/error/ErrorBanner.tsx
import { AlertCircle, ChevronDown } from 'lucide-react'
import { useState } from 'react'

interface Props {
  title: string
  message: string
  details?: string
  onAction?: () => void
  actionLabel?: string
}

export const ErrorBanner = ({ title, message, details, onAction, actionLabel }: Props) => {
  const [isExpanded, setIsExpanded] = useState(false)

  return (
    <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
      <div className="flex items-start">
        <AlertCircle className="w-5 h-5 text-red-500 mr-3 mt-0.5" />
        <div className="flex-1">
          <h3 className="text-lg font-semibold text-red-900">{title}</h3>
          <p className="text-sm text-red-700 mt-1">{message}</p>

          {details && (
            <button
              onClick={() => setIsExpanded(!isExpanded)}
              className="text-sm text-red-600 underline mt-2 flex items-center"
            >
              {isExpanded ? 'Hide' : 'Show'} Details
              <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
          )}

          {isExpanded && details && (
            <pre className="mt-2 p-2 bg-red-100 rounded text-xs text-red-900 overflow-x-auto">
              {details}
            </pre>
          )}

          {onAction && actionLabel && (
            <button
              onClick={onAction}
              className="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            >
              {actionLabel}
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
```

**EmptyState Component:**
```typescript
// components/error/EmptyState.tsx
import { FileX } from 'lucide-react'

interface Props {
  icon?: React.ReactNode
  title: string
  message: string
  actionLabel?: string
  onAction?: () => void
}

export const EmptyState = ({ icon, title, message, actionLabel, onAction }: Props) => {
  return (
    <div className="flex flex-col items-center justify-center py-16 px-4">
      <div className="text-gray-400 mb-4">
        {icon || <FileX className="w-16 h-16" />}
      </div>
      <h3 className="text-xl font-semibold text-gray-700 mb-2">{title}</h3>
      <p className="text-gray-500 text-center max-w-md mb-6">{message}</p>
      {onAction && actionLabel && (
        <button
          onClick={onAction}
          className="px-6 py-3 bg-[#5B9A99] text-white rounded-lg hover:bg-[#4A7F7E] transition-colors"
        >
          {actionLabel}
        </button>
      )}
    </div>
  )
}
```

**Network Error Handling in Polling:**
```typescript
// In app/pipeline/[runId]/page.tsx
const [retryCount, setRetryCount] = useState(0)
const [isRetrying, setIsRetrying] = useState(false)

useEffect(() => {
  if (status === 'COMPLETED' || status === 'FAILED') {
    return
  }

  const pollStatus = async () => {
    try {
      const controller = new AbortController()
      const timeoutId = setTimeout(() => controller.abort(), 10000) // 10s timeout

      const response = await fetch(`/api/pipeline/${runId}/status`, {
        signal: controller.signal
      })

      clearTimeout(timeoutId)

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data = await response.json()

      // Validate with Zod
      const result = PipelineStatusSchema.safeParse(data)
      if (!result.success) {
        throw new Error('Invalid data format')
      }

      setPipelineData(result.data)
      setRetryCount(0) // Reset on success
      setIsRetrying(false)

    } catch (error) {
      if (error.name === 'AbortError') {
        logError('Network timeout', { runId, stage: currentStage, errorCode: 'NETWORK_TIMEOUT' })
      }

      if (retryCount < 5) {
        setRetryCount(prev => prev + 1)
        setIsRetrying(true)
        const delay = 5000 * Math.pow(2, retryCount) // Exponential backoff
        setTimeout(pollStatus, delay)
      } else {
        // Max retries reached
        toast.error('Unable to connect. Check your internet connection.', {
          action: {
            label: 'Retry Now',
            onClick: () => {
              setRetryCount(0)
              pollStatus()
            }
          }
        })
      }
    }
  }

  pollStatus()
}, [runId, status, retryCount])
```

### Files Referenced

- `docs/front-end-spec.md` (lines 1050-1065) - Polling logic with retry
- `innovation-web/app/pipeline/[runId]/page.tsx` - Main pipeline page

### Dependencies

**NPM Packages:**
- `zod` (v3.x) - Runtime type validation
- `react-hot-toast` (v2.x) - Toast notifications (already in Story 8.8)
- `lucide-react` (v0.x) - Icons (AlertCircle, FileX, etc.)

**Depends On:**
- Story 8.1: Pipeline State Machine Foundation
- Story 8.3: State 2 (for stage timeout detection)
- Story 8.4: State 3 (for empty state handling)
- Story 8.5: State 4 (for missing spark handling)

### Testing

#### Test File Location
- `innovation-web/__tests__/error/error-banner.test.tsx`
- `innovation-web/__tests__/error/empty-state.test.tsx`
- `innovation-web/__tests__/api/polling-errors.test.ts`
- `innovation-web/__tests__/validation/schemas.test.ts`

#### Testing Standards

**1. Network Error Tests:**
- Mock timeout (>10s) → Shows "Connection lost" toast
- Mock 5 failed retries → Shows "Retry Now" button
- Click "Retry Now" → Restarts polling
- Exponential backoff delays: 5s, 10s, 20s, 40s

**2. Pipeline Failure Tests:**
- Mock `status: "FAILED"` → Shows ErrorBanner
- ErrorBanner displays error message
- Click "View Details" → Expands accordion
- Click "Start New Pipeline" → Navigates to upload

**3. Validation Tests:**
- Invalid JSON → Shows fallback UI
- Missing required field → Uses default/placeholder
- Wrong data type → Logs error, shows error state
- Zod validation fails → Graceful degradation

**4. Stage Timeout Tests:**
- State 1 stuck 5+ minutes → Shows "Extraction delayed"
- State 2 stuck 10+ minutes → Shows "Processing delayed"
- Timer resets on stage change

**5. Empty State Tests:**
- Empty sparks array → Shows EmptyState component
- EmptyState shows correct icon + message
- Click action button → Navigates correctly

**6. Error Copy Tests:**
- All error messages are plain language (no jargon)
- All errors include action buttons
- Timestamps are formatted correctly

**7. Error Logging Tests:**
- Error logged to console with context
- Error sent to backend (in production)
- Privacy: No PII in logs

#### Testing Framework
- Jest + React Testing Library for components
- Mock Service Worker (MSW) for API mocking
- Playwright for end-to-end error scenarios

#### Specific Testing Requirements

**Test: Network Timeout**
```typescript
test('shows retry message after network timeout', async () => {
  // Mock timeout
  global.fetch = jest.fn().mockImplementation(() =>
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('AbortError')), 100)
    )
  )

  render(<PipelinePage params={{ runId: 'test-run' }} />)

  await waitFor(() => {
    expect(screen.getByText(/Connection lost/i)).toBeInTheDocument()
  }, { timeout: 15000 })
})
```

**Test: Pipeline Failure Banner**
```typescript
test('shows error banner when pipeline fails', async () => {
  server.use(
    rest.get('/api/pipeline/:runId/status', (req, res, ctx) => {
      return res(
        ctx.json({
          status: 'FAILED',
          error: 'Stage 3 timeout',
          currentStage: 3
        })
      )
    })
  )

  render(<PipelinePage params={{ runId: 'test-run' }} />)

  await waitFor(() => {
    expect(screen.getByText('Pipeline Failed')).toBeInTheDocument()
    expect(screen.getByText(/Stage 3/i)).toBeInTheDocument()
  })
})
```

**Test: Zod Validation**
```typescript
test('validates API response with Zod schema', () => {
  const invalidData = {
    runId: 'test',
    status: 'INVALID_STATUS', // Invalid enum value
    currentStage: 3
  }

  const result = PipelineStatusSchema.safeParse(invalidData)

  expect(result.success).toBe(false)
  if (!result.success) {
    expect(result.error.issues[0].path).toContain('status')
  }
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 polish phase | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
