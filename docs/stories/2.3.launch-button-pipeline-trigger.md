# Story 2.3: Launch Button UI Integration

---

## Status

**Draft**

---

## Story

**As a** Innovation Manager,
**I want** to click a "Launch" button on the intermediary card to start the innovation pipeline execution,
**so that** the system begins processing the analyzed document through all 5 pipeline stages and generates brand-specific opportunities.

---

## Acceptance Criteria

### Frontend Integration (Story 2.3 Scope)

1. **Launch Button Implementation**
   - "Launch" button displays below track cards on intermediary page
   - Button uses shadcn/ui Button component with primary styling
   - Button shows loading state during API call (spinner + "Launching Pipeline..." text)
   - Button disabled during launch to prevent duplicate submissions

2. **API Integration**
   - Call `POST /api/run` endpoint when button clicked (endpoint created in Story 3.1)
   - Send request body: `{ blob_url, upload_id, selected_tracks: [1, 2] }`
   - Retrieve `blob_url` from intermediary page state (received from Story 2.1)
   - Retrieve `upload_id` from page URL parameter

3. **Response Handling**
   - Parse response JSON: `{ run_id, status }`
   - Display success state briefly (checkmark icon, 500ms duration)
   - Handle API errors gracefully (network failure, 400/500 status codes)
   - Display error message in alert component if launch fails

4. **Navigation After Launch**
   - Redirect to `/pipeline/{run_id}` on successful API response
   - Use Next.js `useRouter().push()` for client-side navigation
   - Preserve company context during navigation

5. **Error States**
   - Network error: "Failed to connect. Please check your connection."
   - API error (400): "Invalid request. Please try uploading again."
   - API error (500): "Pipeline failed to start. Please contact support."
   - Display "Try Again" button that re-enables launch button

6. **Loading States**
   - Disable launch button immediately on click
   - Show spinner inside button
   - Update button text: "Launch" → "Launching Pipeline..."
   - Prevent multiple clicks during launch

### Backend Integration (Story 3.1 Dependency)

**Note:** This story only implements the frontend button. The `POST /api/run` endpoint is implemented in **Story 3.1: API Routes for Pipeline Execution**.

7. **Dependency Requirement**
   - Story 3.1 must be completed first (provides `/api/run` endpoint)
   - This story consumes the API created in Story 3.1
   - Integration testing requires both stories complete

---

## Tasks / Subtasks

- [ ] **Task 1: Update Intermediary Card Page** (AC: 1, 2)
  - [ ] Open `app/analyze/[uploadId]/page.tsx` from Story 2.2
  - [ ] Add state: `const [launching, setLaunching] = useState(false)`
  - [ ] Add state: `const [launchError, setLaunchError] = useState('')`
  - [ ] Import `useRouter` from `next/navigation`

- [ ] **Task 2: Implement Launch Handler** (AC: 2, 3, 4)
  - [ ] Create async function: `handleLaunch()`
  - [ ] Set launching state: `setLaunching(true)`
  - [ ] Clear previous errors: `setLaunchError('')`
  - [ ] Prepare request body:
    ```typescript
    const requestBody = {
      blob_url: blobUrl,  // from page state (Story 2.1 response)
      upload_id: uploadId,  // from URL params
      selected_tracks: [1, 2]  // hardcoded for MVP
    }
    ```
  - [ ] Call API:
    ```typescript
    const response = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    })
    ```
  - [ ] Handle response parsing and errors

- [ ] **Task 3: Handle Success Response** (AC: 3, 4)
  - [ ] Parse JSON: `const { run_id, status } = await response.json()`
  - [ ] Wait 500ms to show success state
  - [ ] Navigate: `router.push(\`/pipeline/\${run_id}\`)`

- [ ] **Task 4: Handle Error Responses** (AC: 5)
  - [ ] Check `response.ok` - if false, extract error
  - [ ] Map status codes to user messages:
    - Network error: "Failed to connect. Please check your connection."
    - 400: "Invalid request. Please try uploading again."
    - 500: "Pipeline failed to start. Please contact support."
  - [ ] Set error state: `setLaunchError(errorMessage)`
  - [ ] Reset launching state: `setLaunching(false)`

- [ ] **Task 5: Create Launch Button UI** (AC: 1, 6)
  - [ ] Add Button component below track cards
  - [ ] Set variant: `variant="default"` (primary styling)
  - [ ] Set size: `size="lg"`
  - [ ] Set disabled: `disabled={launching}`
  - [ ] Conditional text:
    ```typescript
    {launching ? 'Launching Pipeline...' : 'Launch'}
    ```
  - [ ] Add loading spinner when `launching === true`
  - [ ] Add onClick handler: `onClick={handleLaunch}`

- [ ] **Task 6: Create Error Display** (AC: 5)
  - [ ] Import shadcn/ui Alert component
  - [ ] Conditionally render when `launchError !== ''`
  - [ ] Display error message with `role="alert"`
  - [ ] Add "Try Again" button that clears error and re-enables launch

- [ ] **Task 7: Manual Testing** (AC: 7)
  - [ ] **Prerequisite:** Story 3.1 must be completed (provides `/api/run` endpoint)
  - [ ] Test happy path:
    - Complete upload and analysis flow (Stories 1.1 → 1.3 → 2.1 → 2.2)
    - Click "Launch" button
    - Verify button shows loading state
    - Verify redirect to `/pipeline/{run_id}` after 500ms
  - [ ] Test error scenarios:
    - Simulate network error (disconnect internet) → verify error message
    - Test with invalid blob_url → verify error handling
  - [ ] Test multiple clicks:
    - Click "Launch" button rapidly
    - Verify only one API call made (button disabled after first click)

---

## Dev Notes

### Context from Previous Stories

**Story 2.1 (LLM Document Analysis API):**
- Returns analysis data including `blob_url`
- Analysis response stored in page state

**Story 2.2 (Intermediary Card UI):**
- Displays analysis results and track cards
- This story adds the Launch button to Story 2.2's page
- Page already has `blob_url` in state from Story 2.1 response
- Page URL contains `uploadId` parameter

**Story 3.1 (API Routes for Pipeline Execution):**
- **DEPENDENCY:** Must be completed before Story 2.3
- Provides `POST /api/run` endpoint
- Endpoint signature: `{ blob_url, upload_id, selected_tracks }`
- Returns: `{ run_id, status: "running" }`

### Relevant Source Tree

**Files to Modify:**
- `app/analyze/[uploadId]/page.tsx` - Add launch button and handler (created in Story 2.2)

**API Dependency:**
- `app/api/run/route.ts` - Pipeline trigger endpoint (created in Story 3.1)

**Navigation Target:**
- `app/pipeline/[runId]/page.tsx` - Pipeline viewer page (created in Story 3.3)

### Component Architecture

```typescript
// app/analyze/[uploadId]/page.tsx (Story 2.2 - modified in Story 2.3)
'use client'

export default function AnalyzePage({ params }) {
  const router = useRouter()
  const [launching, setLaunching] = useState(false)
  const [launchError, setLaunchError] = useState('')
  const [analysis, setAnalysis] = useState(null)  // from Story 2.2
  const [blobUrl, setBlobUrl] = useState('')      // from Story 2.2

  const handleLaunch = async () => {
    setLaunching(true)
    setLaunchError('')

    try {
      const response = await fetch('/api/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          blob_url: blobUrl,
          upload_id: params.uploadId,
          selected_tracks: [1, 2]
        })
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.error || 'Launch failed')
      }

      const { run_id } = await response.json()

      // Brief success state
      await new Promise(resolve => setTimeout(resolve, 500))

      // Redirect to pipeline viewer
      router.push(`/pipeline/${run_id}`)
    } catch (error) {
      setLaunchError(error.message)
      setLaunching(false)
    }
  }

  return (
    <>
      {/* Analysis display from Story 2.2 */}
      <DocumentCard analysis={analysis} />
      <TrackCards tracks={analysis?.tracks} />

      {/* NEW: Launch button */}
      <Button
        size="lg"
        disabled={launching}
        onClick={handleLaunch}
      >
        {launching ? 'Launching Pipeline...' : 'Launch'}
      </Button>

      {/* NEW: Error display */}
      {launchError && (
        <Alert variant="destructive">
          {launchError}
          <Button onClick={() => setLaunchError('')}>Try Again</Button>
        </Alert>
      )}
    </>
  )
}
```

### Implementation Patterns

**Button Loading State:**
```typescript
<Button
  size="lg"
  disabled={launching}
  onClick={handleLaunch}
>
  {launching && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
  {launching ? 'Launching Pipeline...' : 'Launch'}
</Button>
```

**Error Mapping:**
```typescript
const getErrorMessage = (status: number, defaultMessage: string) => {
  const errorMap: Record<number, string> = {
    400: 'Invalid request. Please try uploading again.',
    404: 'Brand profile not found. Please select a company.',
    500: 'Pipeline failed to start. Please contact support.',
  }
  return errorMap[status] || defaultMessage
}
```

### shadcn/ui Components

**Required Components:**
- `Button` - Launch button with loading state
- `Alert` - Error message display
- `Loader2` (from lucide-react) - Loading spinner icon

### Tech Stack

- Next.js 15 (App Router)
- React client component (`'use client'`)
- TypeScript for type safety
- shadcn/ui for components
- fetch API for network requests

### Testing

**Test File Location:**
- Manual testing only for hackathon scope
- Future: `app/analyze/[uploadId]/__tests__/launch-button.test.tsx`

**Testing Standards:**
- Browser-based manual testing
- Test all button states (default, loading, disabled, error)
- Test navigation flow
- Test error handling

**Specific Testing Requirements:**

1. **Happy Path Test:**
   - Complete upload flow (Stories 1.1 → 1.3)
   - Complete analysis flow (Story 2.1)
   - Navigate to intermediary card (Story 2.2)
   - Click "Launch" button
   - Verify button shows loading state
   - Verify redirect to `/pipeline/{run_id}`

2. **Error Handling Test:**
   - Disconnect internet, click "Launch"
   - Verify network error message displays
   - Click "Try Again" button
   - Verify error clears and button re-enables

3. **Multiple Click Prevention:**
   - Click "Launch" button multiple times rapidly
   - Verify button disables after first click
   - Verify only one API call made (check Network tab)

4. **Integration Test (requires Story 3.1):**
   - Complete full flow from onboarding to pipeline launch
   - Verify `/api/run` endpoint returns valid `run_id`
   - Verify redirect to pipeline viewer page

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation from brownfield-create-story task | John (PM Agent) |

---

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes List

*To be populated by dev agent*

### File List

*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent after implementation review*
