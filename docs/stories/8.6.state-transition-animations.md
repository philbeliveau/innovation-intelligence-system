# Story 8.6: State Transition Animations

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P2
**Estimated Time:** 2-3 hours

---

## Status

**Draft**

---

## Story

**As a** CPG Innovation Manager using the Innovation Intelligence Pipeline,
**I want** smooth, visually polished transitions between the 4 progressive UI states,
**so that** the pipeline evolution feels natural and professional rather than jarring or disruptive.

---

## Acceptance Criteria

### 1. State Transition Timings Defined
- State 1 → State 2: 600ms fade transition
- State 2 → State 3: 800ms slide-up + fade transition
- State 3 → State 4: 400ms sidebar collapse + detail expand
- State 4 → State 3: 400ms reverse transition (collapse detail, expand grid)
- All transitions use `ease-in-out` timing function
- Transitions respect `prefers-reduced-motion` media query

### 2. GPU-Accelerated Animations Only
- Animations use `transform` and `opacity` properties only (no layout-triggering properties)
- No animations on `width`, `height`, `top`, `left`, `margin`, `padding`
- All animated elements use `will-change: transform, opacity` sparingly
- `will-change` removed after animation completes
- No janky frame drops on 60Hz displays

### 3. Fade Transitions for Content Swaps
- Outgoing state: Opacity 1 → 0 (first half of transition)
- Incoming state: Opacity 0 → 1 (second half of transition)
- Content swap occurs at 50% mark (when old content fully faded)
- Z-index stacking prevents flickering during crossfade
- Loading states show skeleton screens during data fetch

### 4. Slide Transitions for Stage Progression
- State 2 → State 3: Content slides up 20px while fading in
- Implemented via `transform: translateY(20px)` → `translateY(0)`
- Combined with opacity 0 → 1
- Stagger effect: Cards appear sequentially (100ms delay per card)
- Maximum 6 cards stagger, then batch remaining

### 5. Sidebar Collapse Animation (State 3 → State 4)
- Collapsed sidebar width: 120px (thumbnail strip)
- Expanded grid width: Full width minus 120px
- Transition: `transform: translateX(-80%)` for sidebar collapse
- Detail panel: `transform: translateX(120px)` → `translateX(0)` + fade in
- Thumbnail cards: Shrink + darken during collapse (200ms)
- Selected card: Highlight with teal border (2px solid #5B9A99)

### 6. Reduced Motion Fallback
- Detect `prefers-reduced-motion: reduce` media query
- When active: Instant state changes (no animations)
- Alternative feedback: Brief color pulse (teal background flash, 150ms)
- Focus management: Move keyboard focus to new primary content
- Announce state changes to screen readers via `aria-live="polite"`

### 7. Performance Monitoring
- All transitions maintain 60fps (16.67ms per frame)
- Use `requestAnimationFrame` for JavaScript-driven animations
- Monitor with Chrome DevTools Performance panel during QA
- No layout thrashing (avoid reading layout properties during animation)
- Measure Cumulative Layout Shift (CLS) < 0.1

---

## Tasks / Subtasks

- [ ] Define transition configuration constants (AC: #1)
  - [ ] Create `innovation-web/lib/transitions.ts`
  - [ ] Export transition duration constants (600ms, 800ms, 400ms)
  - [ ] Export easing function: `cubic-bezier(0.4, 0.0, 0.2, 1)`
  - [ ] Export `prefers-reduced-motion` hook: `useReducedMotion()`
  - [ ] Document timing values with comments

- [ ] Implement GPU-accelerated animation utilities (AC: #2)
  - [ ] Create `useWillChange` hook for temporary `will-change` application
  - [ ] Add TypeScript interfaces for animation configs
  - [ ] Create helper function: `applyGPUOptimizations(element)`
  - [ ] Test on low-end devices (throttled CPU in DevTools)
  - [ ] Verify no layout recalculations during animations

- [ ] Build fade transition component wrapper (AC: #3)
  - [ ] Create `innovation-web/components/animations/FadeTransition.tsx`
  - [ ] Accept props: `isVisible`, `duration`, `children`
  - [ ] Implement opacity 0 ↔ 1 transition
  - [ ] Handle `onTransitionEnd` callback for content swap
  - [ ] Add z-index management for smooth crossfade
  - [ ] Test with State 1 ↔ State 2 transition

- [ ] Build slide-up transition for State 2 → 3 (AC: #4)
  - [ ] Create `innovation-web/components/animations/SlideUpTransition.tsx`
  - [ ] Implement `translateY(20px)` → `translateY(0)` + opacity
  - [ ] Add stagger effect for multiple children (100ms delay)
  - [ ] Cap stagger at 6 items max (batch remaining)
  - [ ] Accept `staggerDelay` prop (default 100ms)
  - [ ] Test with 2, 6, 10, 20 cards

- [ ] Implement sidebar collapse animation (AC: #5)
  - [ ] Update `CollapsedSidebar.tsx` with transform transitions
  - [ ] Add `isCollapsed` state (default: false in State 3, true in State 4)
  - [ ] Implement width transition: 100% → 120px
  - [ ] Add thumbnail shrink animation (scale: 1 → 0.8)
  - [ ] Highlight selected card with teal border
  - [ ] Sync with detail panel slide-in animation

- [ ] Create detail panel slide-in animation (AC: #5)
  - [ ] Update `ExpandedSparkDetail.tsx` with entrance animation
  - [ ] Implement `translateX(120px)` → `translateX(0)` + fade
  - [ ] Duration: 400ms to match sidebar collapse
  - [ ] Add `onAnimationComplete` callback
  - [ ] Test with keyboard navigation (arrow keys)

- [ ] Add reduced motion fallback (AC: #6)
  - [ ] Create `useReducedMotion()` hook using `matchMedia`
  - [ ] When true: Set all transition durations to 0ms
  - [ ] Implement color pulse alternative (teal background flash)
  - [ ] Add `aria-live="polite"` announcements for state changes
  - [ ] Manage focus to new content (use `useEffect` + `ref.focus()`)
  - [ ] Test with macOS "Reduce Motion" setting enabled

- [ ] Performance optimization pass (AC: #7)
  - [ ] Wrap animations in `requestAnimationFrame`
  - [ ] Remove `will-change` after animation completes
  - [ ] Test with Chrome DevTools Performance panel
  - [ ] Record 10-second animation sequence
  - [ ] Verify no layout recalculations (green bars only)
  - [ ] Measure CLS score with Lighthouse (<0.1 target)

- [ ] Integration with PipelineStateMachine (AC: #1-7)
  - [ ] Import transition components into `PipelineStateMachine.tsx`
  - [ ] Wrap state components with appropriate transitions
  - [ ] Test State 1 → 2 → 3 → 4 full sequence
  - [ ] Test reverse: State 4 → 3 (back to grid)
  - [ ] Verify no visual glitches or flickering
  - [ ] Test on throttled CPU (DevTools: 4x slowdown)

- [ ] Cross-browser testing (AC: #7)
  - [ ] Test in Chrome (latest)
  - [ ] Test in Safari (latest)
  - [ ] Test in Firefox (latest)
  - [ ] Test in Edge (latest)
  - [ ] Test on iOS Safari (mobile device)
  - [ ] Test on Chrome Android (mobile device)

- [ ] Accessibility testing (AC: #6)
  - [ ] Verify `aria-live` announcements work with NVDA/JAWS
  - [ ] Test keyboard focus management during transitions
  - [ ] Verify reduced motion fallback with screen reader
  - [ ] Check color contrast on teal flash (≥4.5:1)
  - [ ] Test with keyboard-only navigation (no mouse)

---

## Dev Notes

### Integration Points

**Components to Update:**
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Add transition wrappers
- `innovation-web/components/pipeline/CollapsedSidebar.tsx` - Add collapse animation
- `innovation-web/components/pipeline/ExpandedSparkDetail.tsx` - Add slide-in animation
- `innovation-web/components/pipeline/SparksGrid.tsx` - Add stagger animation

**New Files to Create:**
- `innovation-web/lib/transitions.ts` - Transition constants and utilities
- `innovation-web/hooks/useReducedMotion.ts` - Prefers-reduced-motion hook
- `innovation-web/hooks/useWillChange.ts` - Temporary will-change hook
- `innovation-web/components/animations/FadeTransition.tsx` - Fade wrapper
- `innovation-web/components/animations/SlideUpTransition.tsx` - Slide-up wrapper

**No Backend Changes Required**

### Technical Details

**Transition Configuration:**
```typescript
// lib/transitions.ts
export const TRANSITIONS = {
  STATE_1_TO_2: {
    duration: 600,
    easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)',
    type: 'fade'
  },
  STATE_2_TO_3: {
    duration: 800,
    easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)',
    type: 'slide-up',
    stagger: 100
  },
  STATE_3_TO_4: {
    duration: 400,
    easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)',
    type: 'sidebar-collapse'
  },
  STATE_4_TO_3: {
    duration: 400,
    easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)',
    type: 'sidebar-expand'
  }
} as const
```

**GPU-Accelerated Animation Utility:**
```typescript
// hooks/useWillChange.ts
import { useEffect, useRef } from 'react'

export const useWillChange = (isAnimating: boolean) => {
  const ref = useRef<HTMLElement>(null)

  useEffect(() => {
    const el = ref.current
    if (!el) return

    if (isAnimating) {
      el.style.willChange = 'transform, opacity'
    } else {
      // Remove after animation completes
      const timeout = setTimeout(() => {
        el.style.willChange = 'auto'
      }, 50)
      return () => clearTimeout(timeout)
    }
  }, [isAnimating])

  return ref
}
```

**Reduced Motion Hook:**
```typescript
// hooks/useReducedMotion.ts
import { useEffect, useState } from 'react'

export const useReducedMotion = () => {
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(false)

  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)')
    setPrefersReducedMotion(mediaQuery.matches)

    const handleChange = (e: MediaQueryListEvent) => {
      setPrefersReducedMotion(e.matches)
    }

    mediaQuery.addEventListener('change', handleChange)
    return () => mediaQuery.removeEventListener('change', handleChange)
  }, [])

  return prefersReducedMotion
}
```

**FadeTransition Component:**
```typescript
// components/animations/FadeTransition.tsx
import { ReactNode } from 'react'
import { useReducedMotion } from '@/hooks/useReducedMotion'

interface FadeTransitionProps {
  isVisible: boolean
  duration?: number
  children: ReactNode
  onTransitionEnd?: () => void
}

export const FadeTransition = ({
  isVisible,
  duration = 600,
  children,
  onTransitionEnd
}: FadeTransitionProps) => {
  const reducedMotion = useReducedMotion()
  const actualDuration = reducedMotion ? 0 : duration

  return (
    <div
      className="transition-opacity"
      style={{
        opacity: isVisible ? 1 : 0,
        transitionDuration: `${actualDuration}ms`,
        transitionTimingFunction: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
      }}
      onTransitionEnd={onTransitionEnd}
    >
      {children}
    </div>
  )
}
```

**SlideUpTransition Component:**
```typescript
// components/animations/SlideUpTransition.tsx
import { ReactNode } from 'react'
import { useReducedMotion } from '@/hooks/useReducedMotion'
import { useWillChange } from '@/hooks/useWillChange'

interface SlideUpTransitionProps {
  isVisible: boolean
  duration?: number
  staggerDelay?: number
  index?: number
  children: ReactNode
}

export const SlideUpTransition = ({
  isVisible,
  duration = 800,
  staggerDelay = 100,
  index = 0,
  children
}: SlideUpTransitionProps) => {
  const reducedMotion = useReducedMotion()
  const ref = useWillChange(isVisible)

  const actualDuration = reducedMotion ? 0 : duration
  const delay = reducedMotion ? 0 : Math.min(index * staggerDelay, 600)

  return (
    <div
      ref={ref as any}
      className="transition-all"
      style={{
        opacity: isVisible ? 1 : 0,
        transform: isVisible ? 'translateY(0)' : 'translateY(20px)',
        transitionDuration: `${actualDuration}ms`,
        transitionDelay: `${delay}ms`,
        transitionTimingFunction: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
      }}
    >
      {children}
    </div>
  )
}
```

**Sidebar Collapse Animation:**
```typescript
// In CollapsedSidebar.tsx
const sidebarVariants = {
  expanded: {
    width: '100%',
    transform: 'translateX(0)',
    transition: { duration: 0.4, ease: [0.4, 0.0, 0.2, 1] }
  },
  collapsed: {
    width: '120px',
    transform: 'translateX(0)',
    transition: { duration: 0.4, ease: [0.4, 0.0, 0.2, 1] }
  }
}

// Usage
<motion.div
  variants={sidebarVariants}
  animate={isState4 ? 'collapsed' : 'expanded'}
>
  {thumbnails}
</motion.div>
```

**Reduced Motion Fallback:**
```typescript
// Alternative color pulse for reduced motion
const ColorPulse = () => {
  const [isPulsing, setIsPulsing] = useState(false)

  useEffect(() => {
    setIsPulsing(true)
    const timeout = setTimeout(() => setIsPulsing(false), 150)
    return () => clearTimeout(timeout)
  }, [])

  return (
    <div
      className="absolute inset-0 pointer-events-none"
      style={{
        backgroundColor: isPulsing ? 'rgba(91, 154, 153, 0.1)' : 'transparent',
        transition: 'background-color 150ms'
      }}
    />
  )
}
```

### Files Referenced

- `docs/front-end-spec.md` (lines 1075-1100, 1190-1200) - Performance and accessibility requirements
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - State orchestrator
- `docs/image/MyBOI Mockup v2_compressed.pdf` - Visual reference for transitions

### Dependencies

**NPM Packages (Optional):**
- `framer-motion` (optional) - For complex animation sequencing
  - Can be avoided by using native CSS transitions + React hooks
  - Recommended for cleaner API if already in project

**Depends On:**
- Story 8.1: Pipeline State Machine Foundation (must be complete)
- Story 8.2-8.5: All state components (must exist to animate)

### Testing

#### Test File Location
- `innovation-web/__tests__/animations/transitions.test.tsx`
- `innovation-web/__tests__/animations/reduced-motion.test.tsx`
- `innovation-web/__tests__/performance/animation-fps.test.tsx`

#### Testing Standards

**1. Transition Timing Tests:**
- State 1 → 2 completes in 600ms (±50ms tolerance)
- State 2 → 3 completes in 800ms (±50ms tolerance)
- State 3 → 4 completes in 400ms (±50ms tolerance)
- Stagger delay between cards is 100ms (±20ms)

**2. GPU Acceleration Tests:**
- Verify `will-change: transform, opacity` applied during animation
- Verify `will-change: auto` restored after animation
- No layout/paint operations during animation (only composite)
- Chrome DevTools Performance: Green bars only, no purple/yellow

**3. Reduced Motion Tests:**
- Mock `prefers-reduced-motion: reduce` media query
- Verify transitions set to 0ms duration
- Verify color pulse fallback appears
- Verify `aria-live` announcements triggered

**4. Cross-Browser Compatibility:**
- Chrome 90+: All transitions smooth
- Safari 14+: All transitions smooth (test CSS prefix if needed)
- Firefox 88+: All transitions smooth
- Edge 90+: All transitions smooth

**5. Performance Benchmarks:**
- Record with Chrome DevTools Performance
- Verify 60fps (16.67ms per frame) maintained
- Measure CLS with Lighthouse (<0.1 target)
- Test on throttled CPU (4x slowdown): 30fps minimum

**6. Accessibility Tests:**
- Keyboard focus moves to new content after transition
- NVDA/JAWS announce state changes via `aria-live`
- Reduced motion works with screen readers
- Color contrast ≥4.5:1 on teal flash

**7. Animation Correctness:**
- Fade: Opacity transitions 0 ↔ 1
- Slide-up: translateY(20px) → 0 + opacity
- Sidebar collapse: Width 100% → 120px
- Detail slide-in: translateX(120px) → 0

**8. Edge Cases:**
- Rapid state changes (don't queue animations)
- Animation interrupted mid-transition (clean state reset)
- Low-end device performance (throttled CPU)
- Browser tab backgrounded (pause animations)

#### Testing Framework
- Jest + React Testing Library for unit tests
- Playwright for end-to-end animation testing
- Chrome DevTools Performance API for FPS monitoring

#### Specific Testing Requirements

**Test: State Transition Timing**
```typescript
test('State 1 to 2 transition completes in 600ms', async () => {
  const { container } = render(<PipelineStateMachine currentStage={1} status="PROCESSING" />)

  const startTime = performance.now()

  // Trigger state change
  fireEvent.click(screen.getByTestId('trigger-state-2'))

  await waitFor(() => {
    expect(screen.getByTestId('state-2')).toBeVisible()
  })

  const elapsed = performance.now() - startTime
  expect(elapsed).toBeGreaterThanOrEqual(550) // 600ms - 50ms tolerance
  expect(elapsed).toBeLessThanOrEqual(650) // 600ms + 50ms tolerance
})
```

**Test: GPU Acceleration**
```typescript
test('applies will-change during animation, removes after', async () => {
  const { container } = render(<FadeTransition isVisible={true} />)
  const element = container.firstChild as HTMLElement

  // During animation
  expect(element.style.willChange).toBe('transform, opacity')

  // After animation (wait for cleanup)
  await waitFor(() => {
    expect(element.style.willChange).toBe('auto')
  }, { timeout: 1000 })
})
```

**Test: Reduced Motion Fallback**
```typescript
test('disables animations when prefers-reduced-motion is set', () => {
  // Mock media query
  Object.defineProperty(window, 'matchMedia', {
    writable: true,
    value: jest.fn().mockImplementation(query => ({
      matches: query === '(prefers-reduced-motion: reduce)',
      media: query,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn()
    }))
  })

  const { container } = render(<SlideUpTransition isVisible={true} />)
  const element = container.firstChild as HTMLElement

  expect(element.style.transitionDuration).toBe('0ms')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 polish phase | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
