# Story 7.8: Pipeline Completion Webhook - Deployment Guide

## Environment Variables Configuration

### Generated Webhook Secret

```
cb910f55ccc473356ed5eec6b3c77d7e3e70ec6fbe263e3ed767c4130269d46f
```

### Railway Backend Configuration

Add these environment variables to Railway backend service:

```bash
FRONTEND_WEBHOOK_URL=https://innovation-web-rho.vercel.app
WEBHOOK_SECRET=cb910f55ccc473356ed5eec6b3c77d7e3e70ec6fbe263e3ed767c4130269d46f
```

**Steps:**
1. Go to Railway dashboard: https://railway.app/project/YOUR_PROJECT_ID
2. Select the backend service
3. Go to "Variables" tab
4. Add both variables above
5. Deploy changes (Railway will auto-restart)

### Vercel Frontend Configuration

Add this environment variable to Vercel:

```bash
WEBHOOK_SECRET=cb910f55ccc473356ed5eec6b3c77d7e3e70ec6fbe263e3ed767c4130269d46f
```

**Steps:**
1. Go to Vercel dashboard: https://vercel.com/philippe-beliveaus-projects/innovation-web
2. Go to Settings → Environment Variables
3. Add `WEBHOOK_SECRET` with the value above
4. Apply to: Production, Preview, Development
5. Redeploy the application (required for env vars to take effect)

## Deployment Order

**CRITICAL:** Both services must be deployed in this order:

1. **Deploy Frontend First** (with WEBHOOK_SECRET)
   ```bash
   cd innovation-web
   vercel --prod --yes
   ```

2. **Deploy Backend Second** (with FRONTEND_WEBHOOK_URL and WEBHOOK_SECRET)
   - Push changes to Railway repo or trigger redeploy in dashboard
   - Verify Railway auto-deploys with new environment variables

## Verification Steps

### 1. Check Environment Variables

**Railway Backend:**
```bash
# In Railway console, run:
echo $FRONTEND_WEBHOOK_URL
echo $WEBHOOK_SECRET
# Should output the correct values
```

**Vercel Frontend:**
Check dashboard Environment Variables section confirms WEBHOOK_SECRET is set.

### 2. Test Webhook Endpoint

```bash
# Test webhook authentication (should return 401 Unauthorized)
curl -X POST https://innovation-web-rho.vercel.app/api/runs/test-run-id/complete \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Secret: wrong-secret" \
  -d '{"status": "COMPLETED"}'

# Should return: {"error":"Unauthorized"}
```

### 3. Monitor Logs During Pipeline Execution

**Railway Backend Logs:**
Look for these log entries after Stage 5 completes:
```
[run-id] Calling completion webhook: https://innovation-web-rho.vercel.app/api/runs/run-id/complete
[run-id] Successfully notified frontend of completion
```

**Vercel Frontend Logs:**
Look for these log entries:
```
[Webhook] Received completion for run run-id
[Webhook] Updated run run-id status to COMPLETED
[Webhook] Created 5/5 opportunity cards
[Webhook] Created inspiration report for run run-id
[Webhook] Pipeline run-id completed successfully: 5 cards saved
```

### 4. Database Verification

After a successful pipeline run:

```sql
-- Check run status
SELECT id, status, completedAt, duration FROM "PipelineRun" WHERE id = 'run-id';
-- Expected: status = 'COMPLETED', completedAt = timestamp, duration = number

-- Check opportunity cards
SELECT id, runId, number, title FROM "OpportunityCard" WHERE runId = 'run-id';
-- Expected: 5 rows

-- Check inspiration report
SELECT id, runId FROM "InspirationReport" WHERE runId = 'run-id';
-- Expected: 1 row
```

## Troubleshooting

### Webhook Not Called

**Symptoms:**
- Pipeline completes on backend
- Run stays in PROCESSING status
- No webhook logs in Railway

**Solutions:**
1. Check `FRONTEND_WEBHOOK_URL` is set in Railway
2. Check `WEBHOOK_SECRET` is set in Railway
3. Verify backend code has `call_completion_webhook()` after Stage 5
4. Check Railway logs for webhook call attempts

### Webhook Returns 401 Unauthorized

**Symptoms:**
- Backend logs: "Webhook failed: 401"
- Frontend logs: "Authentication failed: Invalid secret"

**Solutions:**
1. Verify `WEBHOOK_SECRET` matches in both Railway and Vercel
2. Redeploy both services after setting env vars
3. Check for typos in secret value

### Webhook Returns 404 Not Found

**Symptoms:**
- Backend logs: "Webhook failed: 404"

**Solutions:**
1. Verify frontend endpoint exists: `innovation-web/app/api/runs/[runId]/complete/route.ts`
2. Verify Vercel deployment succeeded
3. Check `FRONTEND_WEBHOOK_URL` points to correct domain

### Webhook Timeout

**Symptoms:**
- Backend logs: "Webhook timeout after 30s"

**Solutions:**
1. Check Vercel deployment is healthy
2. Check database connection (frontend may be timing out on DB query)
3. Monitor Vercel function execution time (should be < 10s)

### Cards Not Created

**Symptoms:**
- Webhook succeeds (200 OK)
- Run status = COMPLETED
- But opportunityCards table is empty

**Solutions:**
1. Check frontend logs for "Failed to create card" errors
2. Verify opportunities array in webhook payload has required fields (title, markdown)
3. Check Prisma schema matches payload structure
4. Run `npx prisma generate` to update Prisma client

## Testing Checklist

- [ ] Environment variables set in Railway backend
- [ ] Environment variables set in Vercel frontend
- [ ] Frontend deployed to production
- [ ] Backend deployed to production
- [ ] Webhook endpoint accessible (test with curl)
- [ ] Upload new document through web UI
- [ ] Monitor Railway logs for webhook call
- [ ] Monitor Vercel logs for webhook receipt
- [ ] Check database: Run status = COMPLETED
- [ ] Check database: 5 OpportunityCards exist
- [ ] Check database: 1 InspirationReport exists
- [ ] Verify sidebar shows completed run with card count

## Rollback Plan

If webhook integration causes issues:

1. **Disable webhook calls** (backend):
   Comment out `call_completion_webhook()` in `pipeline_runner.py`

2. **Redeploy backend** to Railway

3. **Runs will complete** but status won't update (old behavior)

4. **Manual fix** for stuck runs:
   ```sql
   UPDATE "PipelineRun" SET status = 'COMPLETED', completedAt = NOW() WHERE status = 'PROCESSING';
   ```

## Success Criteria

✅ Pipeline completes successfully on Railway
✅ Webhook called within 1 second of completion
✅ Frontend receives webhook and authenticates
✅ Run status updated to COMPLETED
✅ 5 OpportunityCards created in database
✅ InspirationReport created in database
✅ Sidebar shows run with correct card count
✅ No errors in Railway or Vercel logs

---

**Deployed By:** Dev Agent (James)
**Date:** 2025-10-22
**Story:** 7.8 - Pipeline Completion Webhook Integration
