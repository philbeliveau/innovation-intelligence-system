# Story 10.7: frontend-pipeline-state-machine-update

## Status
Approved

## Story
**As a** user,
**I want** to view completed pipeline runs with persisted stage outputs,
**so that** I can review past analysis visualizations without re-running the pipeline (retrospective mode)

## Acceptance Criteria

1. Pipeline page supports two modes: "Live" (polling) and "Retrospective" (static)
2. Retrospective mode activated when status=COMPLETED and stage outputs exist
3. Polling stops automatically when pipeline completes (no infinite polling)
4. State 2 (ThreeColumnLayout) uses persisted stage outputs in retrospective mode
5. State 3 (SparksGrid) works identically in both modes
6. State 4 (ExpandedSparkDetail) works identically in both modes
7. UI indicates mode to user (e.g., "Live Pipeline" vs "Completed Analysis")

## Tasks / Subtasks

- [ ] Update PipelineStateMachine component (AC: 1, 2, 3)
  - [ ] Add mode detection logic: `isRetrospective = status === 'COMPLETED'`
  - [ ] Stop polling when `isRetrospective` is true
  - [ ] Pass `isRetrospective` flag to child components
  - [ ] Add mode indicator in UI (badge or header text)
- [ ] Update ThreeColumnLayout component (AC: 4)
  - [ ] Accept stage outputs from props (retrospective mode)
  - [ ] Fall back to empty/loading state if stage outputs null (old runs)
  - [ ] Display persisted signals, insights, preliminary cards
  - [ ] Keep animations disabled in retrospective mode
- [ ] Update polling logic in page.tsx (AC: 3)
  - [ ] Stop polling when status changes to COMPLETED
  - [ ] Clear polling interval on component unmount
  - [ ] Resume polling on page refresh if status still PROCESSING
  - [ ] Add exponential backoff to reduce API load
- [ ] Add mode indicator UI (AC: 7)
  - [ ] Show "Live Pipeline" badge when polling active
  - [ ] Show "Completed Analysis" badge in retrospective mode
  - [ ] Add timestamp of completion in retrospective mode
  - [ ] Style badges with distinct colors (green=live, blue=completed)
- [ ] Testing (AC: 1-7)
  - [ ] Test live mode with new pipeline run
  - [ ] Test retrospective mode with completed run
  - [ ] Test mode switching (start live, complete, enter retrospective)
  - [ ] Test old runs without stage outputs (should show fallback)
  - [ ] Verify polling stops when completed

## Dev Notes

**Relevant Source Tree:**
- `innovation-web/app/pipeline/[runId]/page.tsx` - Main pipeline page with polling logic
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - State orchestrator
- `innovation-web/components/pipeline/ThreeColumnLayout.tsx` - State 2 visualization
- `innovation-web/hooks/usePipelineStatus.ts` - Status polling hook (may need creation)

**Current Behavior (Live Mode Only):**
- Pipeline page polls `/api/pipeline/[runId]/status` every 5 seconds
- Displays real-time progress as stages complete
- Redirects to `/results/[runId]` when completed (TO BE REMOVED)

**New Behavior (Dual Mode):**

**Mode Detection Logic:**
```typescript
// innovation-web/components/pipeline/PipelineStateMachine.tsx

type PipelineMode = 'live' | 'retrospective'

const determineMode = (status: PipelineStatusResponse): PipelineMode => {
  // Retrospective: pipeline completed and has stage outputs
  if (status.status === 'COMPLETED' && status.stage1Output) {
    return 'retrospective'
  }

  // Live: pipeline still processing
  return 'live'
}

const PipelineStateMachine = ({ runId }: Props) => {
  const { data: status, error } = usePipelineStatus(runId)
  const mode = determineMode(status)

  // Stop polling in retrospective mode
  const shouldPoll = mode === 'live'

  return (
    <div>
      <ModeIndicator mode={mode} completedAt={status.completedAt} />
      {mode === 'retrospective' ? (
        <RetrospectiveView status={status} />
      ) : (
        <LiveView status={status} />
      )}
    </div>
  )
}
```

**Polling Logic Update:**
```typescript
// innovation-web/hooks/usePipelineStatus.ts (NEW HOOK)

import { useEffect, useState } from 'react'
import { PipelineStatusResponse } from '@/lib/types/pipeline'

export function usePipelineStatus(runId: string, enablePolling = true) {
  const [status, setStatus] = useState<PipelineStatusResponse | null>(null)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    let interval: NodeJS.Timeout | null = null

    const fetchStatus = async () => {
      try {
        const res = await fetch(`/api/pipeline/${runId}/status`)
        if (!res.ok) throw new Error('Failed to fetch status')
        const data = await res.json()
        setStatus(data)

        // Stop polling when completed
        if (data.status === 'COMPLETED' && interval) {
          clearInterval(interval)
        }
      } catch (err) {
        setError(err as Error)
      }
    }

    // Initial fetch
    fetchStatus()

    // Set up polling if enabled
    if (enablePolling) {
      interval = setInterval(fetchStatus, 5000) // Poll every 5 seconds
    }

    // Cleanup
    return () => {
      if (interval) clearInterval(interval)
    }
  }, [runId, enablePolling])

  return { data: status, error }
}
```

**ThreeColumnLayout Update:**
```typescript
// innovation-web/components/pipeline/ThreeColumnLayout.tsx

type ThreeColumnLayoutProps = {
  status: PipelineStatusResponse
  mode: 'live' | 'retrospective'
}

export function ThreeColumnLayout({ status, mode }: ThreeColumnLayoutProps) {
  // Use persisted stage outputs in retrospective mode
  const signals = status.stage2Output?.signals || []
  const insights = status.stage3Output?.insights || []
  const preliminary = status.stage4Output?.preliminary || []

  // Disable animations in retrospective mode
  const enableAnimations = mode === 'live'

  return (
    <div className="grid grid-cols-3 gap-4">
      <SignalColumn signals={signals} animate={enableAnimations} />
      <InsightColumn insights={insights} animate={enableAnimations} />
      <PreliminaryColumn items={preliminary} animate={enableAnimations} />
    </div>
  )
}
```

**Mode Indicator Component:**
```typescript
// innovation-web/components/pipeline/ModeIndicator.tsx (NEW)

type ModeIndicatorProps = {
  mode: 'live' | 'retrospective'
  completedAt?: string | null
}

export function ModeIndicator({ mode, completedAt }: ModeIndicatorProps) {
  if (mode === 'live') {
    return (
      <div className="flex items-center gap-2 mb-4">
        <div className="h-2 w-2 bg-green-500 rounded-full animate-pulse" />
        <span className="text-sm text-gray-600">Live Pipeline Running</span>
      </div>
    )
  }

  return (
    <div className="flex items-center gap-2 mb-4">
      <div className="h-2 w-2 bg-blue-500 rounded-full" />
      <span className="text-sm text-gray-600">
        Completed Analysis {completedAt && `(${new Date(completedAt).toLocaleDateString()})`}
      </span>
    </div>
  )
}
```

**Important Constraints:**
- DO NOT break existing live pipeline functionality
- Retrospective mode must work even if user refreshes page
- Polling MUST stop when status=COMPLETED (avoid infinite API calls)
- Old runs without stage outputs should show graceful fallback (Story 10.10)
- State 3 and State 4 work identically in both modes (no changes needed)

**User Experience:**
- User can navigate to `/pipeline/[runId]` at any time
- If pipeline is running, they see live progress (State 1 → 2 → 3 → 4)
- If pipeline is completed, they see retrospective view (State 2 or 3)
- User can bookmark `/pipeline/[runId]` to return to analysis later
- No redirect to `/results/[runId]` (that page is deprecated in new design)

**Edge Cases to Handle:**
1. **Old runs without stage outputs**: Show fallback message (Story 10.10)
2. **Failed pipeline runs**: Show error state with failure reason
3. **Cancelled runs**: Show cancelled state with partial results
4. **Page refresh during live run**: Resume polling from current stage
5. **Network errors during polling**: Show error banner, continue polling

**Dependencies:**
- Requires Story 10.1 (database schema) to be completed
- Requires Story 10.4 (webhook handlers) to populate stage outputs
- Requires Story 10.5 (status endpoint) to return stage outputs
- Blocks Story 10.8 (download buttons)

### Testing

**Test File Location:**
- `innovation-web/components/pipeline/PipelineStateMachine.test.tsx` (NEW)
- `innovation-web/hooks/usePipelineStatus.test.ts` (NEW)
- `innovation-web/components/pipeline/ThreeColumnLayout.test.tsx` (update)

**Testing Standards:**
- Use Jest with React Testing Library
- Mock API responses for status endpoint
- Test mode switching behavior
- Test polling start/stop logic

**Testing Frameworks:**
- Jest for unit testing
- React Testing Library for component testing
- MSW (Mock Service Worker) for API mocking

**Specific Testing Requirements:**

1. **PipelineStateMachine Tests:**
   ```typescript
   // Test: Detects live mode when status=PROCESSING
   // Test: Detects retrospective mode when status=COMPLETED
   // Test: Passes correct props to ThreeColumnLayout
   // Test: Shows mode indicator correctly
   ```

2. **Polling Hook Tests:**
   ```typescript
   // Test: Starts polling on mount
   // Test: Stops polling when status=COMPLETED
   // Test: Clears interval on unmount
   // Test: Handles network errors gracefully
   // Test: Resumes polling after page refresh (if still PROCESSING)
   ```

3. **ThreeColumnLayout Tests:**
   ```typescript
   // Test: Renders signals in live mode
   // Test: Renders persisted signals in retrospective mode
   // Test: Disables animations in retrospective mode
   // Test: Handles null stage outputs gracefully
   ```

4. **Integration Testing:**
   - Start new pipeline run
   - Verify live mode activates with polling
   - Wait for pipeline completion
   - Verify mode switches to retrospective
   - Verify polling stops
   - Refresh page
   - Verify retrospective mode persists
   - Verify stage outputs display correctly

**Manual Testing Checklist:**
- [ ] Start new pipeline run
- [ ] Navigate to `/pipeline/[runId]`
- [ ] Verify "Live Pipeline Running" indicator shows
- [ ] Verify State 1 animation displays
- [ ] Wait for stage 1 to complete
- [ ] Verify State 2 displays with signals/insights
- [ ] Wait for pipeline to complete
- [ ] Verify mode switches to "Completed Analysis"
- [ ] Verify polling stops (check network tab)
- [ ] Refresh page
- [ ] Verify retrospective mode still active
- [ ] Verify stage outputs still display
- [ ] Test with old run (no stage outputs) - see Story 10.10

**Success Metrics:**
- Dual mode detection works correctly (live vs retrospective)
- Polling stops when pipeline completes
- Retrospective mode displays persisted stage outputs
- Mode indicator clearly shows current state
- Zero infinite polling loops in retrospective mode
- Page refreshes maintain correct mode

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation from Pipeline Persistence Epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
