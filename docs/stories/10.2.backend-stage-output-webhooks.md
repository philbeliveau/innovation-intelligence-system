# Story 10.2: backend-stage-output-webhooks

## Status
Draft

## Story
**As a** backend developer,
**I want** all 5 pipeline stages to send their JSON outputs via webhook to the frontend,
**so that** stage-level analysis data persists in the database and users can access intermediate pipeline results

## Acceptance Criteria

1. Stage 1 sends `{ extractedText, mechanisms }` via webhook on completion
2. Stage 2 sends `{ signals }` via webhook on completion
3. Stage 3 sends `{ insights }` via webhook on completion
4. Stage 4 sends `{ preliminary }` via webhook on completion
5. Stage 5 completion webhook unchanged (backward compatible)
6. All webhooks include `X-Webhook-Secret` header for authentication
7. Webhook failures logged but don't block pipeline progression
8. Retry logic implemented with exponential backoff (3 attempts max)
9. Webhook timeout set to 10 seconds
10. All webhook deliveries logged with status code and response time

## Tasks / Subtasks

- [ ] Enhance webhook utility with retry logic (AC: 8, 9, 10)
  - [ ] Update `backend/utils/webhook.py` with exponential backoff
  - [ ] Add timeout parameter (default 10 seconds)
  - [ ] Add detailed logging for attempts and failures
  - [ ] Raise `WebhookDeliveryError` after max retries
- [ ] Update Stage 1 webhook (AC: 1, 6)
  - [ ] Modify `backend/pipeline/stage1_extraction.py`
  - [ ] Send webhook with `{ extractedText, mechanisms }` output
  - [ ] Test webhook delivery in local environment
- [ ] Update Stage 2 webhook (AC: 2, 6)
  - [ ] Modify `backend/pipeline/stage2_signals.py`
  - [ ] Send webhook with `{ signals }` output
  - [ ] Test webhook delivery in local environment
- [ ] Update Stage 3 webhook (AC: 3, 6)
  - [ ] Modify `backend/pipeline/stage3_insights.py`
  - [ ] Send webhook with `{ insights }` output
  - [ ] Test webhook delivery in local environment
- [ ] Update Stage 4 webhook (AC: 4, 6)
  - [ ] Modify `backend/pipeline/stage4_ideation.py`
  - [ ] Send webhook with `{ preliminary }` output
  - [ ] Test webhook delivery in local environment
- [ ] Verify Stage 5 unchanged (AC: 5)
  - [ ] Regression test existing completion webhook
  - [ ] Verify opportunity cards still save correctly
- [ ] Integration testing (AC: 7)
  - [ ] Test full pipeline with webhook failures
  - [ ] Verify pipeline continues despite webhook errors
  - [ ] Check logs show retry attempts
- [ ] Production validation
  - [ ] Deploy to Railway staging environment
  - [ ] Run test pipeline with real documents
  - [ ] Verify all webhooks delivered successfully
  - [ ] Check database for stage outputs

## Dev Notes

**Relevant Source Tree:**
- `backend/pipeline/stage1_extraction.py` - Stage 1 implementation
- `backend/pipeline/stage2_signals.py` - Stage 2 implementation
- `backend/pipeline/stage3_insights.py` - Stage 3 implementation
- `backend/pipeline/stage4_ideation.py` - Stage 4 implementation
- `backend/pipeline/stage5_cards.py` - Stage 5 implementation (verify unchanged)
- `backend/utils/webhook.py` - Webhook utility (enhance with retry logic)

**Webhook Payload Structure:**

All stage webhooks use consistent format:
```json
{
  "stageNumber": 1-5,
  "stageName": "Extraction|Signals|Insights|Ideation|Cards",
  "status": "COMPLETE",
  "output": { /* stage-specific data */ }
}
```

**Stage-Specific Output Structures:**

**Stage 1 Output:**
```json
{
  "extractedText": "Full text extracted from PDF...",
  "mechanisms": [
    {
      "title": "Mechanism Name",
      "description": "How it works",
      "context": "Where it appears in document"
    }
  ]
}
```

**Stage 2 Output:**
```json
{
  "signals": [
    {
      "id": "signal-1",
      "category": "Technology|Market|User Behavior",
      "description": "Signal description",
      "relevance": "Why this matters",
      "mechanismSource": "Linked mechanism ID"
    }
  ]
}
```

**Stage 3 Output:**
```json
{
  "insights": [
    {
      "id": "insight-1",
      "title": "Transferable Insight",
      "description": "How this applies to target industry",
      "signalSources": ["signal-1", "signal-2"],
      "transferability": "High|Medium|Low"
    }
  ]
}
```

**Stage 4 Output:**
```json
{
  "preliminary": [
    {
      "id": "prelim-1",
      "title": "Rough Opportunity Idea",
      "description": "Initial concept",
      "insightSources": ["insight-1"]
    }
  ]
}
```

**Webhook Utility Enhancement:**

```python
# backend/utils/webhook.py

import httpx
import asyncio
import os
from typing import Dict, Any

class WebhookDeliveryError(Exception):
    """Raised when webhook delivery fails after all retries"""
    pass

async def send_webhook_with_retry(
    run_id: str,
    endpoint: str,  # "stage-update" or "complete"
    payload: Dict[str, Any],
    max_retries: int = 3,
    timeout: int = 10
) -> None:
    """
    Send webhook with exponential backoff retry logic
    """
    frontend_url = os.getenv("FRONTEND_URL")
    webhook_secret = os.getenv("WEBHOOK_SECRET")

    url = f"{frontend_url}/api/pipeline/{run_id}/{endpoint}"
    headers = {"X-Webhook-Secret": webhook_secret, "Content-Type": "application/json"}

    for attempt in range(max_retries):
        try:
            async with httpx.AsyncClient(timeout=timeout) as client:
                response = await client.post(url, json=payload, headers=headers)
                response.raise_for_status()

                logger.info(
                    f"[{run_id}] Webhook delivered: {endpoint} "
                    f"(status={response.status_code}, time={response.elapsed.total_seconds():.2f}s)"
                )
                return  # Success

        except (httpx.HTTPError, httpx.TimeoutException) as e:
            wait_time = 2 ** attempt  # Exponential backoff: 1s, 2s, 4s
            logger.warning(
                f"[{run_id}] Webhook attempt {attempt + 1}/{max_retries} failed: {e}. "
                f"Retrying in {wait_time}s..."
            )
            if attempt < max_retries - 1:
                await asyncio.sleep(wait_time)
            else:
                raise WebhookDeliveryError(f"Failed after {max_retries} attempts") from e
```

**Stage Implementation Pattern (Example for Stage 2):**

```python
# backend/pipeline/stage2_signals.py

async def execute_stage2(run_id: str, stage1_output: dict) -> dict:
    """
    Stage 2: Signal Detection
    """
    logger.info(f"[{run_id}] Stage 2: Signal Detection - Starting")

    # Existing signal detection logic
    signals = detect_signals(stage1_output['mechanisms'])

    # NEW: Prepare webhook payload
    webhook_payload = {
        "stageNumber": 2,
        "stageName": "Signals",
        "status": "COMPLETE",
        "output": {
            "signals": signals
        }
    }

    # NEW: Send webhook with retry logic
    try:
        await send_webhook_with_retry(
            run_id=run_id,
            endpoint="stage-update",
            payload=webhook_payload,
            max_retries=3,
            timeout=10
        )
        logger.info(f"[{run_id}] Stage 2: Webhook delivered successfully")
    except WebhookDeliveryError as e:
        # Log error but don't block pipeline
        logger.error(f"[{run_id}] Stage 2: Webhook failed after retries: {e}")

    # Return output for next stage
    return {"signals": signals}
```

**Important Constraints:**
- Webhook payload size should be < 1MB (JSON compresses well)
- Timeout must be short enough to not delay pipeline execution
- Webhook failures must be logged for debugging but not crash pipeline
- Frontend webhook receiver must be ready to accept new payload structure (Story 10.4)

**Environment Variables Required:**
```bash
# In Railway backend environment
FRONTEND_URL=https://innovation-web.vercel.app
WEBHOOK_SECRET=<shared-secret-with-frontend>
```

**Risk Mitigation:**
- Primary Risk: Webhook delivery failures cause data loss (stage outputs not saved)
- Mitigation: Retry logic with 3 attempts, detailed logging for manual recovery
- Rollback: Revert backend deployment using `railway rollback --deployment <previous-id>`

**Dependencies:**
- Blocks: Story 10.4 (Frontend Webhook Handler Updates)
- Blocked By: Story 10.1 (Database Schema Update - columns must exist)

### Testing

**Test File Location:**
- `backend/tests/test_webhook_delivery.py` (new file)
- Manual testing with local frontend running

**Testing Standards:**
- pytest for webhook utility unit tests
- Integration testing with full pipeline
- Manual verification of webhook delivery logs

**Testing Frameworks:**
- pytest for backend tests
- httpx for async HTTP requests
- Railway CLI for log monitoring

**Specific Testing Requirements:**

1. **Webhook Utility Unit Tests:**
   ```python
   # backend/tests/test_webhook_delivery.py

   @pytest.mark.asyncio
   async def test_webhook_success():
       # Mock successful webhook delivery
       pass

   @pytest.mark.asyncio
   async def test_webhook_retry_logic():
       # Mock failed delivery, verify retries
       pass

   @pytest.mark.asyncio
   async def test_webhook_timeout():
       # Mock slow endpoint, verify timeout
       pass
   ```

2. **Local Integration Testing:**
   ```bash
   # Terminal 1: Run frontend
   cd innovation-web && npm run dev

   # Terminal 2: Configure backend environment
   cd backend
   export FRONTEND_URL=http://localhost:3000
   export WEBHOOK_SECRET=test-secret-123

   # Run backend
   uvicorn app.main:app --reload --log-level debug

   # Terminal 3: Trigger pipeline
   curl -X POST http://localhost:8000/api/pipeline/run \
     -H "Content-Type: application/json" \
     -d '{"blob_url": "...", "brand_id": "test", "run_id": "test-123"}'

   # Verify logs show webhook delivery for all stages
   ```

3. **Verify Webhook Delivery:**
   ```bash
   # Check Railway backend logs
   railway logs --service backend

   # Look for lines like:
   # [test-123] Webhook delivered: stage-update (status=200, time=0.15s)
   # [test-123] Stage 2: Webhook delivered successfully
   ```

4. **Test Retry Logic:**
   ```bash
   # Temporarily set invalid FRONTEND_URL
   export FRONTEND_URL=http://invalid-url.com

   # Run pipeline, verify logs show retries:
   # [test-123] Webhook attempt 1/3 failed: ... Retrying in 1s...
   # [test-123] Webhook attempt 2/3 failed: ... Retrying in 2s...
   # [test-123] Webhook attempt 3/3 failed: ... Retrying in 4s...
   ```

**Success Metrics:**
- 100% of pipeline runs send all 5 stage webhooks
- Webhook delivery success rate > 95%
- Average webhook delivery time < 500ms
- Zero pipeline failures caused by webhook errors
- All stage outputs visible in database after completion (verify in Story 10.4)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation from Pipeline Persistence Epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
