# Story 4.2: Results Page with Opportunity Cards

## Status

Draft

## Story

**As a** Innovation Manager,
**I want** to view the 5 brand-specific innovation opportunities generated by the pipeline in a clean, professional format,
**so that** I can review the actionable insights and download or share them with my leadership team.

## Acceptance Criteria

1. Page displays at `/results/[runId]` route with proper routing
2. Page header shows "Pipeline Complete - 5 Opportunities Generated" with success indicator (✓)
3. All 5 opportunity cards render from Stage 5 markdown files (`opportunity-1.md` through `opportunity-5.md`)
4. Each opportunity card displays:
   - Opportunity number and title (extracted from markdown)
   - Full markdown content with proper formatting (headings, lists, bold, italic)
   - Professional card styling with adequate spacing
5. Markdown rendering includes XSS protection (disallowed elements: script, iframe, object, embed)
6. Cards display in vertical scroll layout (single column)
7. "New Pipeline" button redirects to `/upload` (homepage)
8. "Download PDF" button displays (disabled/placeholder state with tooltip)
9. Error handling for missing files:
   - If all 5 files missing: Display "No opportunities found" message
   - If some files missing: Display available opportunities + warning message
   - Provide "Return to Upload" button on error
10. Loading state displays while reading markdown files
11. Company name displays in header (from cookie context)
12. Mobile responsive layout with proper card sizing
13. No console errors or warnings during rendering
14. Markdown content does not break layout (overflow handled properly)
15. Navigation preserves company context across pages

## Tasks / Subtasks

- [ ] Create `/app/results/[runId]/page.tsx` route component (AC: 1)
  - [ ] Set up Next.js dynamic route with params extraction
  - [ ] Implement as Server Component for file reading
  - [ ] Import required shadcn/ui components (Card, Button, Badge)

- [ ] Build markdown file reading logic (AC: 3)
  - [ ] Create async function to read 5 markdown files from filesystem
  - [ ] Use `fs/promises` to read files: `data/test-outputs/{runId}/stage5/opportunity-{1-5}.md`
  - [ ] Handle file reading errors with try/catch
  - [ ] Parse markdown titles from first heading line
  - [ ] Return array of opportunity objects: `{ number: number, title: string, markdown: string }`

- [ ] Implement markdown rendering with XSS protection (AC: 4, 5)
  - [ ] Install `react-markdown` package (if not already installed)
  - [ ] Configure react-markdown with security settings:
    ```typescript
    <ReactMarkdown
      disallowedElements={['script', 'iframe', 'object', 'embed']}
      unwrapDisallowed={true}
    >
      {markdown}
    </ReactMarkdown>
    ```
  - [ ] Test markdown rendering with various formatting (headings, lists, bold, italic)
  - [ ] Verify XSS protection blocks dangerous elements

- [ ] Create opportunity card component (AC: 4, 6)
  - [ ] Create `components/OpportunityCard.tsx` component
  - [ ] Implement card layout with Card component
  - [ ] Add opportunity number badge (e.g., "Opportunity #1")
  - [ ] Render markdown content with proper spacing
  - [ ] Apply Tailwind prose classes for typography
  - [ ] Handle long content with proper overflow (scroll if needed)

- [ ] Build page header and success message (AC: 2)
  - [ ] Add success banner at top: "✓ Pipeline Complete - 5 Opportunities Generated"
  - [ ] Style with green background and white text
  - [ ] Display company name from cookie context
  - [ ] Add visual success icon/animation

- [ ] Add action buttons (AC: 7, 8)
  - [ ] Create "New Pipeline" button with proper styling
  - [ ] Implement click handler: `router.push('/upload')`
  - [ ] Create "Download PDF" button (disabled state)
  - [ ] Add tooltip: "PDF export coming in Phase 2"
  - [ ] Position buttons in action bar (flex layout)

- [ ] Implement error handling (AC: 9)
  - [ ] Check if all 5 files exist before rendering
  - [ ] Display "No opportunities found" if all missing
  - [ ] Display warning banner if some files missing (e.g., "Only 3 of 5 opportunities available")
  - [ ] Render available opportunities even if some missing
  - [ ] Add "Return to Upload" button on critical errors
  - [ ] Log errors to console for debugging

- [ ] Add loading state (AC: 10)
  - [ ] Implement Suspense boundary with loading fallback
  - [ ] Create loading skeleton for opportunity cards
  - [ ] Display "Loading opportunities..." message
  - [ ] Use shadcn/ui Skeleton component

- [ ] Implement responsive layout (AC: 12)
  - [ ] Add Tailwind responsive breakpoints (sm, md, lg)
  - [ ] Adjust card width for mobile (full width on small screens)
  - [ ] Ensure readable text size on all devices
  - [ ] Test on mobile viewport (375px width)

- [ ] Handle markdown overflow and layout (AC: 14)
  - [ ] Add `overflow-auto` class to card content areas
  - [ ] Set max-height for extremely long content
  - [ ] Test with very long markdown files
  - [ ] Ensure tables and code blocks don't break layout

- [ ] Add company context integration (AC: 11, 15)
  - [ ] Fetch company name from `/api/onboarding/current-company`
  - [ ] Display company name in header
  - [ ] Verify context preserved from previous pages

## Dev Notes

### Relevant Source Tree

**Pages:**
- `app/results/[runId]/page.tsx` - Results page (to be created)
- `app/pipeline/[runId]/page.tsx` - Previous page in flow (redirects here on completion)
- `app/upload/page.tsx` - Homepage destination for "New Pipeline" button

**Components to Create:**
- `components/OpportunityCard.tsx` - Individual opportunity card with markdown rendering

**Data Sources:**
- `data/test-outputs/{runId}/stage5/opportunity-1.md` (through `opportunity-5.md`)
- Each markdown file contains full opportunity description with sections:
  - Opportunity title (first heading)
  - Strategic Rationale
  - Implementation Approach
  - Success Metrics
  - Timeline and Investment estimates

**shadcn/ui Components:**
- `Card` - Opportunity card containers
- `Button` - Action buttons (New Pipeline, Download PDF)
- `Badge` - Opportunity number badges, company badge
- `Skeleton` - Loading state placeholders
- `Alert` - Error/warning messages

**Dependencies:**
- `react-markdown` - Markdown rendering library
- `fs/promises` - Node.js filesystem for server component
- `next/navigation` - Router for navigation

**Markdown File Structure Example:**
```markdown
# Plant-Based Dairy Theater Experience

## Strategic Rationale

Lactalis can leverage experience theater principles to create immersive product launch events...

## Implementation Approach

- Partner with local theaters for product launches
- Create immersive tasting experiences
- Integrate social media sharing moments

## Success Metrics

- 20% increase in event participation
- 15% social media engagement lift

## Timeline & Investment

Timeline: 6-12 months
Investment: $500K-$1M
```

**Server Component Implementation Pattern:**
```typescript
import { readFile } from 'fs/promises'
import { Card } from '@/components/ui/card'
import ReactMarkdown from 'react-markdown'

export default async function ResultsPage({ params }: { params: { runId: string } }) {
  const runId = params.runId
  const outputDir = `data/test-outputs/${runId}/stage5`

  // Read all 5 opportunity files
  const opportunities = await Promise.allSettled(
    [1, 2, 3, 4, 5].map(async (num) => {
      const filePath = `${outputDir}/opportunity-${num}.md`
      const markdown = await readFile(filePath, 'utf-8')

      // Extract title from first heading
      const titleMatch = markdown.match(/^#\s+(.+)$/m)
      const title = titleMatch ? titleMatch[1] : `Opportunity ${num}`

      return { number: num, title, markdown }
    })
  )

  // Filter successful reads
  const validOpportunities = opportunities
    .filter((result) => result.status === 'fulfilled')
    .map((result) => result.value)

  // Error handling
  if (validOpportunities.length === 0) {
    return <ErrorDisplay message="No opportunities found" />
  }

  return (
    <div className="max-w-4xl mx-auto p-8">
      <SuccessBanner count={validOpportunities.length} />

      {validOpportunities.length < 5 && (
        <WarningBanner message={`Only ${validOpportunities.length} of 5 opportunities available`} />
      )}

      {validOpportunities.map((opp) => (
        <OpportunityCard key={opp.number} {...opp} />
      ))}

      <ActionButtons />
    </div>
  )
}
```

**XSS Protection Configuration:**
```typescript
// components/OpportunityCard.tsx
import ReactMarkdown from 'react-markdown'

export function OpportunityCard({ number, title, markdown }) {
  return (
    <Card className="p-6 mb-6">
      <Badge className="mb-4">Opportunity #{number}</Badge>
      <ReactMarkdown
        className="prose prose-sm max-w-none"
        disallowedElements={['script', 'iframe', 'object', 'embed']}
        unwrapDisallowed={true}
      >
        {markdown}
      </ReactMarkdown>
    </Card>
  )
}
```

**Styling Guidelines:**
- Success Banner: `bg-green-600 text-white py-4 px-6 rounded-lg mb-6`
- Warning Banner: `bg-yellow-100 text-yellow-800 py-3 px-4 rounded-md mb-4`
- Opportunity Cards: `p-6 mb-6` spacing, `prose` classes for typography
- Action Buttons: Primary button for "New Pipeline", secondary for "Download PDF"

**Tailwind Prose Classes:**
- Apply `prose` class to markdown container for automatic typography styling
- Use `prose-sm` for slightly smaller text
- Use `max-w-none` to remove max-width restriction
- Headings, lists, bold, italic will automatically style correctly

**Error Messages:**
- No opportunities found: "Pipeline completed but no opportunities were generated. Please try again or contact support."
- Partial opportunities: "Warning: Only X of 5 opportunities are available. Some files may be missing."
- File read error: "Unable to load opportunities. Please refresh the page or contact support."

**Reference Design:**
- PRD Section 4.4: Results Page specifications
- Architecture Section 5.6: Results Page layout

**Important Notes from Previous Stories:**
- Company context stored in HTTP-only cookie
- Pipeline output files always in `data/test-outputs/{runId}/stage5/` directory
- Markdown files generated by Python pipeline (Stage 5)
- File naming convention: `opportunity-1.md` through `opportunity-5.md` (not zero-indexed)

### Testing

**Test File Location:**
- Manual testing only for hackathon scope
- Future: `app/results/[runId]/page.test.tsx` for component tests

**Test Standards:**
- Verify all 5 markdown files render correctly
- Verify markdown formatting preserved (headings, lists, bold, italic)
- Verify XSS protection blocks dangerous elements
- Verify error handling for missing files
- Verify action buttons navigate correctly
- Verify responsive layout on mobile viewport

**Testing Frameworks and Patterns:**
- Manual testing with browser inspection
- Test with complete pipeline run (all 5 files present)
- Test with partial files (delete 1-2 files manually)
- Test with no files (delete all 5 files)
- Test with malicious markdown (inject `<script>` tags)

**Specific Testing Requirements:**

1. **Complete Render Test:**
   - Run full pipeline to completion
   - Navigate to `/results/[runId]`
   - Verify all 5 cards display
   - Verify titles extracted correctly
   - Verify markdown formatting looks professional

2. **XSS Protection Test:**
   - Create test markdown file with embedded script:
     ```markdown
     # Test Opportunity

     <script>alert('XSS')</script>

     This should render without executing.
     ```
   - Verify script tag does not execute
   - Verify content displays safely

3. **Error Handling Test:**
   - Delete all 5 opportunity files
   - Verify "No opportunities found" message displays
   - Delete 2 of 5 files
   - Verify warning banner shows "Only 3 of 5 opportunities available"
   - Verify available opportunities still render

4. **Navigation Test:**
   - Click "New Pipeline" button
   - Verify redirect to `/upload` page
   - Verify company context preserved
   - Hover over "Download PDF" button
   - Verify tooltip shows "PDF export coming in Phase 2"

5. **Responsive Test:**
   - Resize browser to 375px width (mobile)
   - Verify cards stack properly
   - Verify text remains readable
   - Verify buttons resize appropriately

6. **Overflow Test:**
   - Create very long markdown file (5000+ words)
   - Verify content scrolls properly
   - Verify layout does not break
   - Create markdown with wide table
   - Verify table scrolls horizontally if needed

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA Agent after story completion_
