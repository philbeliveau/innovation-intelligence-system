# Story 10.8: download-buttons-in-state-3

## Status
Approved

## Story
**As a** user,
**I want** download buttons for full report and opportunity cards in the pipeline UI,
**so that** I can export analysis results for sharing and archiving without navigating away from the page

## Acceptance Criteria

1. "Download Full Report" button appears in State 3 (SparksGrid) when `hasFullReport=true`
2. Button hidden when `hasFullReport=false` (old runs or report generation disabled)
3. Clicking "Download Full Report" triggers PDF download from `/api/pipeline/[runId]/download-report`
4. "Download All Opportunity Cards" button downloads all cards as a single PDF
5. Download buttons styled consistently with design system (teal primary color)
6. Loading state shows during PDF generation (spinner + "Generating PDF...")
7. Error handling displays user-friendly message if download fails

## Tasks / Subtasks

- [ ] Add "Download Full Report" button to SparksGrid (AC: 1, 2)
  - [ ] Add button component with conditional rendering based on `hasFullReport`
  - [ ] Position button in header area next to "New Pipeline" button
  - [ ] Style with teal background and white text
  - [ ] Add download icon (file-down or arrow-down icon)
- [ ] Implement download handler for full report (AC: 3, 6, 7)
  - [ ] Call `/api/pipeline/[runId]/download-report` endpoint
  - [ ] Show loading spinner during PDF generation
  - [ ] Trigger browser download when response received
  - [ ] Handle errors with toast notification
  - [ ] Log errors to console for debugging
- [ ] Add "Download All Opportunity Cards" button (AC: 4)
  - [ ] Add button next to "Download Full Report"
  - [ ] Style consistently with report download button
  - [ ] Add cards icon
- [ ] Implement download handler for opportunity cards (AC: 4, 6, 7)
  - [ ] Call new endpoint `/api/pipeline/[runId]/download-cards` (if created)
  - [ ] OR generate PDF client-side from opportunityCards data
  - [ ] Show loading state during generation
  - [ ] Trigger browser download
  - [ ] Handle errors gracefully
- [ ] Add loading states (AC: 6)
  - [ ] Disable button during download
  - [ ] Show spinner icon
  - [ ] Show "Generating PDF..." text
  - [ ] Prevent double-clicks
- [ ] Add error handling (AC: 7)
  - [ ] Catch network errors
  - [ ] Catch 404 errors (report not available)
  - [ ] Show toast notification with error message
  - [ ] Re-enable button after error
- [ ] Testing (AC: 1-7)
  - [ ] Test download full report button
  - [ ] Test download opportunity cards button
  - [ ] Test conditional rendering (hasFullReport)
  - [ ] Test loading states
  - [ ] Test error handling

## Dev Notes

**Relevant Source Tree:**
- `innovation-web/components/pipeline/SparksGrid.tsx` - State 3 component with download buttons
- `innovation-web/app/api/pipeline/[runId]/download-report/route.ts` - Full report PDF endpoint (Story 10.6)
- `innovation-web/app/api/pipeline/[runId]/download-cards/route.ts` - Opportunity cards PDF endpoint (NEW, optional)
- `innovation-web/lib/download-utils.ts` - Download utility functions (NEW)

**Current SparksGrid Component:**
- Displays 2-column grid of opportunity cards
- Has "New Pipeline" button in header
- Shows opportunity card thumbnails with numbered overlays

**New UI Layout (State 3 Header):**
```
┌─────────────────────────────────────────────────────┐
│  My Board of Ideators Badge                         │
│                                                      │
│  [Download Full Report] [Download All Cards] [New Pipeline] │
└─────────────────────────────────────────────────────┘
```

**Implementation Example:**

**SparksGrid Component Update:**
```typescript
// innovation-web/components/pipeline/SparksGrid.tsx

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { FileDown, Download, Loader2 } from 'lucide-react'
import { downloadPDF } from '@/lib/download-utils'
import { useToast } from '@/hooks/use-toast'

type SparksGridProps = {
  runId: string
  opportunityCards: OpportunityCard[]
  hasFullReport: boolean
}

export function SparksGrid({ runId, opportunityCards, hasFullReport }: SparksGridProps) {
  const [downloadingReport, setDownloadingReport] = useState(false)
  const [downloadingCards, setDownloadingCards] = useState(false)
  const { toast } = useToast()

  const handleDownloadReport = async () => {
    setDownloadingReport(true)
    try {
      await downloadPDF(`/api/pipeline/${runId}/download-report`, 'analysis-report.pdf')
      toast({
        title: 'Report downloaded',
        description: 'Full analysis report downloaded successfully'
      })
    } catch (error) {
      console.error('Report download failed:', error)
      toast({
        title: 'Download failed',
        description: 'Failed to download report. Please try again.',
        variant: 'destructive'
      })
    } finally {
      setDownloadingReport(false)
    }
  }

  const handleDownloadCards = async () => {
    setDownloadingCards(true)
    try {
      await downloadPDF(`/api/pipeline/${runId}/download-cards`, 'opportunity-cards.pdf')
      toast({
        title: 'Cards downloaded',
        description: 'All opportunity cards downloaded successfully'
      })
    } catch (error) {
      console.error('Cards download failed:', error)
      toast({
        title: 'Download failed',
        description: 'Failed to download cards. Please try again.',
        variant: 'destructive'
      })
    } finally {
      setDownloadingCards(false)
    }
  }

  return (
    <div>
      {/* Header with download buttons */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <BOIBadge />
        </div>

        <div className="flex items-center gap-3">
          {/* Download Full Report Button */}
          {hasFullReport && (
            <Button
              onClick={handleDownloadReport}
              disabled={downloadingReport}
              variant="outline"
              className="gap-2"
            >
              {downloadingReport ? (
                <>
                  <Loader2 className="h-4 w-4 animate-spin" />
                  Generating PDF...
                </>
              ) : (
                <>
                  <FileDown className="h-4 w-4" />
                  Download Full Report
                </>
              )}
            </Button>
          )}

          {/* Download All Cards Button */}
          <Button
            onClick={handleDownloadCards}
            disabled={downloadingCards}
            variant="outline"
            className="gap-2"
          >
            {downloadingCards ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin" />
                Generating PDF...
              </>
            ) : (
              <>
                <Download className="h-4 w-4" />
                Download All Cards
              </>
            )}
          </Button>

          {/* New Pipeline Button */}
          <Button
            onClick={() => router.push('/upload')}
            className="bg-[#5B9A99] hover:bg-[#4A7B7A] gap-2"
          >
            <Plus className="h-4 w-4" />
            New Pipeline
          </Button>
        </div>
      </div>

      {/* Opportunity cards grid */}
      <div className="grid grid-cols-2 gap-4">
        {opportunityCards.map((card, idx) => (
          <SparkCard key={card.id} card={card} number={idx + 1} />
        ))}
      </div>
    </div>
  )
}
```

**Download Utility Function:**
```typescript
// innovation-web/lib/download-utils.ts

export async function downloadPDF(url: string, filename: string): Promise<void> {
  const response = await fetch(url)

  if (!response.ok) {
    throw new Error(`Download failed: ${response.status} ${response.statusText}`)
  }

  // Get the blob
  const blob = await response.blob()

  // Create download link
  const downloadUrl = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = downloadUrl
  link.download = filename
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)

  // Cleanup
  URL.revokeObjectURL(downloadUrl)
}
```

**Opportunity Cards PDF Endpoint (Optional - if not using client-side generation):**
```typescript
// innovation-web/app/api/pipeline/[runId]/download-cards/route.ts

import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { generateCardsPDF } from '@/lib/pdf-generator'

export async function GET(
  request: NextRequest,
  { params }: { params: { runId: string } }
) {
  try {
    const { runId } = params

    // Query opportunity cards
    const cards = await prisma.opportunityCard.findMany({
      where: { pipelineRunId: runId },
      orderBy: { createdAt: 'asc' }
    })

    if (cards.length === 0) {
      return NextResponse.json(
        { error: 'No opportunity cards found' },
        { status: 404 }
      )
    }

    // Generate PDF
    const pdfBuffer = await generateCardsPDF(cards)

    // Return PDF
    return new Response(pdfBuffer, {
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': 'attachment; filename="opportunity-cards.pdf"',
        'Content-Length': pdfBuffer.byteLength.toString()
      }
    })

  } catch (error) {
    console.error('Cards PDF generation failed:', error)
    return NextResponse.json(
      { error: 'Failed to generate PDF' },
      { status: 500 }
    )
  }
}
```

**Important Constraints:**
- Download buttons MUST not block pipeline UI (non-blocking)
- Loading states prevent double-clicks during PDF generation
- Error messages user-friendly (no technical jargon)
- Full report button conditionally rendered (only if hasFullReport=true)
- Button styling consistent with design system (teal primary color)
- Tooltips explain what each download includes (optional enhancement)

**User Experience:**
- User completes pipeline run
- Sees State 3 with opportunity cards grid
- Sees download buttons in header
- Clicks "Download Full Report" → PDF downloads immediately
- Clicks "Download All Cards" → PDF with all cards downloads
- Loading spinner prevents confusion during generation
- Error toast shows if download fails

**Edge Cases to Handle:**
1. **Old runs without full report**: Hide "Download Full Report" button
2. **Network timeout during download**: Show timeout error, allow retry
3. **PDF generation failure**: Show error toast, log to console
4. **No opportunity cards**: Disable "Download All Cards" button
5. **Multiple rapid clicks**: Disable buttons during download

**Dependencies:**
- Requires Story 10.5 (status endpoint) to return `hasFullReport`
- Requires Story 10.6 (download-report endpoint) for full report PDF
- Requires Story 10.7 (state machine) to pass `hasFullReport` to SparksGrid
- May require new endpoint for opportunity cards PDF (or client-side generation)

### Testing

**Test File Location:**
- `innovation-web/components/pipeline/SparksGrid.test.tsx` (update)
- `innovation-web/lib/download-utils.test.ts` (NEW)

**Testing Standards:**
- Use Jest with React Testing Library
- Mock fetch for download API calls
- Test button states (enabled/disabled/loading)
- Test conditional rendering

**Testing Frameworks:**
- Jest for unit testing
- React Testing Library for component testing
- MSW (Mock Service Worker) for API mocking

**Specific Testing Requirements:**

1. **SparksGrid Component Tests:**
   ```typescript
   // Test: "Download Full Report" button shows when hasFullReport=true
   // Test: "Download Full Report" button hidden when hasFullReport=false
   // Test: "Download All Cards" button always shows
   // Test: Clicking report button triggers download
   // Test: Clicking cards button triggers download
   // Test: Loading state shows during download
   // Test: Error toast shows on download failure
   // Test: Buttons disabled during download
   ```

2. **Download Utility Tests:**
   ```typescript
   // Test: downloadPDF creates and clicks download link
   // Test: downloadPDF handles network errors
   // Test: downloadPDF handles 404 responses
   // Test: downloadPDF cleans up object URLs
   ```

3. **Integration Testing:**
   - Complete pipeline run
   - Navigate to State 3 (SparksGrid)
   - Verify download buttons appear
   - Click "Download Full Report"
   - Verify PDF downloads
   - Click "Download All Cards"
   - Verify PDF downloads
   - Test with old run (no full report)
   - Verify report button hidden

**Manual Testing Checklist:**
- [ ] Complete pipeline run with full report
- [ ] Navigate to `/pipeline/[runId]`
- [ ] Advance to State 3 (SparksGrid)
- [ ] Verify "Download Full Report" button shows
- [ ] Click "Download Full Report"
- [ ] Verify PDF downloads with correct filename
- [ ] Open PDF and verify content
- [ ] Click "Download All Cards"
- [ ] Verify PDF downloads with all cards
- [ ] Test with old run (no full report)
- [ ] Verify report button hidden
- [ ] Test error handling (disconnect network)
- [ ] Verify error toast shows

**Success Metrics:**
- Download buttons appear in correct state (State 3)
- Full report button conditionally rendered based on `hasFullReport`
- PDFs download successfully when buttons clicked
- Loading states prevent double-clicks
- Error handling shows user-friendly messages
- Button styling consistent with design system

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation from Pipeline Persistence Epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
