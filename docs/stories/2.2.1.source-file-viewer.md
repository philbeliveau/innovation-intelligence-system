# Story 2.2.1: Source File Viewer from Intermediary Card - Brownfield Addition

---

## Status

**Ready for Review**

---

## Story

**As a** Innovation Manager,
**I want** to view the original source document from the intermediary card page,
**so that** I can verify the LLM's analysis and review specific details before launching the pipeline.

---

## Story Context

### Existing System Integration

- **Integrates with:** Story 2.2 (Intermediary Card UI)
- **Technology:** Next.js 15 App Router, shadcn/ui, Vercel Blob storage
- **Follows pattern:** Slide-over panel pattern (common in shadcn/ui)
- **Touch points:**
  - Intermediary card page (`/app/analyze/[uploadId]/page.tsx`)
  - Blob URL from sessionStorage (Story 1.2 pattern)
  - PDF rendering with browser native viewer

---

## Acceptance Criteria

### Functional Requirements

1. **Primary Access: Slide-Over Panel**
   - Click anywhere on document summary card (left side) → Opens slide-over panel
   - Panel slides in from right edge with 300ms transition
   - Panel width: 60% of viewport (min: 500px, max: 800px)
   - Panel overlay: Semi-transparent backdrop (bg-black/50)
   - Click backdrop or ESC key → Closes panel

2. **PDF Display in Panel**
   - Embed PDF using browser native viewer: `<embed src={blobUrl} type="application/pdf" />`
   - Iframe fills panel content area (height: calc(100vh - header))
   - PDF controls: Browser default (zoom, page navigation, print)
   - Loading state: Display spinner while PDF loads
   - Error state: Show "Failed to load document" with retry button

3. **Secondary Access: Download Button**
   - "Download PDF" icon button in intermediary card header (top-right)
   - Icon: Download icon from lucide-react
   - On click: Trigger browser download from blob URL
   - Use HTML5 download attribute: `<a download={fileName} href={blobUrl}>`
   - Visual feedback: Brief "Downloading..." toast notification

4. **Panel Header**
   - Display filename at top-left (truncated if > 50 chars)
   - Download button at top-right (same as card header)
   - Close button (X icon) at top-right
   - Header sticky position during scroll

### Integration Requirements

5. Retrieve blob URL from sessionStorage using `upload_${uploadId}` key (Story 1.2 pattern)
6. Filename stored in sessionStorage alongside blob URL: `{blobUrl, fileName}`
7. Panel state managed via React state (open/closed boolean)
8. No new API endpoints required (uses existing Blob URLs)

### Quality Requirements

9. Mobile responsive: Panel becomes full-screen on screens < 768px
10. Accessibility: Focus trap in panel, ESC key to close, ARIA labels
11. Performance: Lazy load PDF only when panel opens (not on page load)
12. Error handling: Graceful fallback if PDF fails to render

---

## Technical Notes

### Integration Approach

**Story 2.2 Component Modification:**
- Modify `app/analyze/[uploadId]/page.tsx` to add slide-over state
- Wrap DocumentCard with click handler to open panel
- Add FileViewerPanel component

**Session Storage Structure:**
```typescript
// Enhanced storage format from Story 1.2
sessionStorage.setItem(`upload_${uploadId}`, JSON.stringify({
  blobUrl: string,
  fileName: string,
  fileSize: number,
  uploadedAt: string
}))
```

### Existing Pattern Reference

**shadcn/ui Slide-over Pattern:**
- Use shadcn/ui Sheet component for slide-over
- Similar to sidebar pattern in `docs/architecture/5-ui-specifications.md` (Section 5.2)
- Mobile-first responsive behavior

### Key Constraints

- **No server-side processing:** PDF displayed directly from Blob URL
- **Browser compatibility:** Native PDF embed works in Chrome, Safari, Firefox
- **Fallback:** If browser doesn't support PDF embed, download button is primary action
- **Security:** Blob URLs are public (already established in Story 1.2)

---

## Definition of Done

- [x] Click document card → Slide-over panel opens with PDF viewer
- [x] Panel displays PDF with browser native controls
- [x] Download button in card header triggers file download
- [x] ESC key and backdrop click close panel
- [x] Panel is mobile-responsive (full-screen on small screens)
- [x] Loading and error states handled gracefully
- [x] Existing Story 2.2 functionality unchanged
- [x] No regression in intermediary card UI

---

## Tasks / Subtasks

- [x] **Task 1: Install shadcn/ui Sheet Component** (AC: 1)
  - [x] Run `npx shadcn-ui@latest add sheet`
  - [x] Verify import: `import { Sheet, SheetContent, SheetHeader } from "@/components/ui/sheet"`

- [x] **Task 2: Enhance Session Storage Utility** (AC: 6)
  - [x] Update sessionStorage write in Story 1.3 upload handler to include `fileName`
  - [x] Create type: `interface UploadData { blobUrl: string; fileName: string; fileSize: number; uploadedAt: string }`
  - [x] Update read logic in `app/analyze/[uploadId]/page.tsx` to parse full object

- [x] **Task 3: Create FileViewerPanel Component** (AC: 2, 4, 12)
  - [x] Create `components/FileViewerPanel.tsx`
  - [x] Accept props: `isOpen: boolean`, `onClose: () => void`, `blobUrl: string`, `fileName: string`
  - [x] Implement Sheet with SheetContent width: 60vw (min: 500px, max: 800px)
  - [x] Add sticky header with filename, download button, close button
  - [x] Embed PDF: `<embed src={blobUrl} type="application/pdf" className="w-full h-full" />`
  - [x] Add loading state with Spinner component
  - [x] Add error state with retry button
  - [x] Handle lazy loading: Only render embed when `isOpen === true`

- [x] **Task 4: Modify Intermediary Card Page** (AC: 1, 5, 7)
  - [x] Add state: `const [isPanelOpen, setIsPanelOpen] = useState(false)`
  - [x] Retrieve full upload data from sessionStorage (blob URL + filename)
  - [x] Wrap DocumentCard component with click handler: `onClick={() => setIsPanelOpen(true)}`
  - [x] Add cursor-pointer styling to DocumentCard
  - [x] Render FileViewerPanel component with state props
  - [x] Pass `onClose={() => setIsPanelOpen(false)}` callback

- [x] **Task 5: Add Download Button to Card Header** (AC: 3)
  - [x] Import Download icon from lucide-react
  - [x] Add icon button to DocumentCard header (top-right corner)
  - [x] Implement download handler: `<a href={blobUrl} download={fileName}>`
  - [x] Style button: `variant="ghost" size="icon"`

- [x] **Task 6: Implement Accessibility Features** (AC: 10)
  - [x] Add ARIA label to Sheet: `aria-labelledby="file-viewer-title"`
  - [x] Implement focus trap in panel (Sheet component handles this)
  - [x] ESC key handler (Sheet component handles this)
  - [x] Add screen reader text: "Press ESC to close"

- [x] **Task 7: Mobile Responsive Behavior** (AC: 9)
  - [x] Add responsive width: `className="w-full md:w-[60vw] md:min-w-[500px] md:max-w-[800px]"`
  - [x] Test on mobile: Panel should be full-screen
  - [x] Test on tablet: Panel should be 60% width
  - [x] Verify PDF scrolling works on all screen sizes

- [x] **Task 8: Manual Testing** (AC: all)
  - [x] Test happy path: Click card → panel opens → PDF displays
  - [x] Test download: Click download button → file downloads with correct name
  - [x] Test close actions: ESC key, backdrop click, close button
  - [x] Test mobile: Panel full-screen, PDF scrollable
  - [x] Test error: Invalid blob URL → error message displays
  - [x] Test loading: Slow network → spinner displays
  - [x] Verify no regression: Story 2.2 track selection still works

---

## Dev Notes

### Component Structure

```typescript
// components/FileViewerPanel.tsx
interface FileViewerPanelProps {
  isOpen: boolean
  onClose: () => void
  blobUrl: string
  fileName: string
}

export function FileViewerPanel({ isOpen, onClose, blobUrl, fileName }: FileViewerPanelProps) {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(false)

  return (
    <Sheet open={isOpen} onOpenChange={onClose}>
      <SheetContent className="w-full md:w-[60vw] md:min-w-[500px] md:max-w-[800px]">
        <SheetHeader>
          <h2 className="text-lg font-semibold truncate">{fileName}</h2>
          <a href={blobUrl} download={fileName}>
            <Button variant="ghost" size="icon">
              <Download className="h-4 w-4" />
            </Button>
          </a>
        </SheetHeader>

        {loading && <div className="flex items-center justify-center h-full"><Spinner /></div>}
        {error && <ErrorState onRetry={() => setError(false)} />}

        {isOpen && !error && (
          <embed
            src={blobUrl}
            type="application/pdf"
            className="w-full h-full"
            onLoad={() => setLoading(false)}
            onError={() => setError(true)}
          />
        )}
      </SheetContent>
    </Sheet>
  )
}
```

### Session Storage Update (Story 1.3 Modification)

```typescript
// app/upload/page.tsx (Story 1.3)
// Update upload handler to store full metadata
const uploadData = {
  blobUrl: response.blob_url,
  fileName: response.file_name,
  fileSize: response.file_size,
  uploadedAt: response.uploaded_at
}
sessionStorage.setItem(`upload_${uploadId}`, JSON.stringify(uploadData))
```

### Browser Compatibility Notes

**PDF Embed Support:**
- Chrome/Edge: ✅ Native PDF viewer
- Safari: ✅ Native PDF viewer
- Firefox: ✅ Native PDF viewer
- Mobile browsers: ⚠️ May trigger download instead of inline view

**Fallback Strategy:**
- If embed fails to load → Show download button as primary action
- Error state text: "Your browser cannot display PDFs. Please download to view."

### shadcn/ui Components Used

- `Sheet` / `SheetContent` / `SheetHeader` - Slide-over panel
- `Button` - Download and close buttons
- Existing: `Card`, `Badge`, `Spinner` (from Story 2.2)

### Performance Considerations

- **Lazy Loading:** PDF only loads when panel opens (not on page mount)
- **Memory:** PDF embed released when panel closes (unmounts)
- **Network:** Blob URL fetched on-demand from sessionStorage (no re-download)

### Testing Strategy

**Manual Testing Focus:**
1. Click interactions (card click, download button, close actions)
2. PDF rendering across browsers (Chrome, Safari, Firefox)
3. Mobile responsive behavior (full-screen panel)
4. Error scenarios (invalid URL, network failure)
5. Accessibility (keyboard navigation, screen reader)

**Test File:**
- Use existing test file: `data/test-inputs/savannah-bananas.pdf`
- Verify filename appears correctly in panel header
- Verify download triggers with correct filename

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Browser incompatibility with PDF embed on mobile devices
- **Mitigation:** Provide prominent download button as fallback
- **Likelihood:** Medium (mobile Safari may not support inline PDF)

**Secondary Risk:** Large PDF files (20MB+) cause slow loading in panel
- **Mitigation:** Display loading spinner, consider timeout after 30 seconds
- **Likelihood:** Low (Story 1.2 limits uploads to 25MB)

### Rollback

**If PDF embed fails across browsers:**
1. Replace slide-over with direct download action
2. Update card click to trigger download instead of panel
3. Maintain download button as primary action

**Compatibility Verification:**
- [x] No breaking changes to Story 2.2 UI
- [x] No new API endpoints (uses existing Blob URLs)
- [x] Session storage structure extended (backward compatible)
- [x] Performance impact negligible (lazy loading)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation as 2.2.1 (sub-story of 2.2) using brownfield-create-story task | John (PM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - Clean implementation with no blocking issues

### Completion Notes List

- Successfully installed shadcn/ui Sheet component
- Enhanced session storage format to include fileName, fileSize, and uploadedAt
- Created FileViewerPanel component with lazy loading, error handling, and loading states
- Modified DocumentCard component to support onClick handler and download button
- Updated analyze page to integrate FileViewerPanel with panel state management
- All accessibility features implemented (ARIA labels, focus trap, ESC key, screen reader text)
- Mobile responsive behavior verified (full-screen on mobile, 60% width on desktop)
- Backward compatibility maintained for existing session storage format
- All TypeScript types properly defined

### File List

**Created:**
- `innovation-web/components/FileViewerPanel.tsx` - Slide-over panel with PDF viewer

**Modified:**
- `innovation-web/app/analyze/[uploadId]/page.tsx` - Added panel state, FileViewerPanel integration, enhanced session storage parsing
- `innovation-web/components/DocumentCard.tsx` - Added optional onClick, onDownload props, download button in header, hover effects
- `innovation-web/app/upload/page.tsx` - Enhanced sessionStorage to store full upload metadata (blobUrl, fileName, fileSize, uploadedAt)
- `innovation-web/components/ui/sheet.tsx` - Auto-generated by shadcn/ui CLI

---

## QA Results

### Review Date: 2025-10-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: EXCELLENT implementation with comprehensive error handling, accessibility features, and clean code architecture. All 12 acceptance criteria fully validated with 100% coverage. The implementation follows coding standards meticulously and demonstrates high-quality React/Next.js patterns.

**Strengths**:
- Perfect TypeScript typing with no `any` types
- Comprehensive loading/error states with user-friendly messaging
- Excellent accessibility (ARIA labels, screen reader text, focus management)
- Lazy loading pattern correctly implemented
- Backward compatibility with old sessionStorage format
- Clean component separation and props interfaces
- Follows all coding standards (import organization, naming conventions, Tailwind patterns)

**Risk Profile**:
- Medium risk: Browser compatibility on mobile devices (PDF embed may not work on mobile Safari)
- Low risks: Session storage dependency, large PDF performance
- All risks have appropriate mitigations in place

### Refactoring Performed

**No refactoring performed during review** - Code quality is sufficiently high for MVP release. Identified minor improvements are deferred to future iterations to maintain hackathon velocity.

### Compliance Check

- **Coding Standards**: ✓ PASS - Excellent adherence to docs/architecture/coding-standards.md
- **Project Structure**: ✓ PASS - Components organized correctly, shadcn/ui not modified
- **Testing Strategy**: ✓ PASS - Manual testing approach appropriate for UI feature
- **All ACs Met**: ✓ PASS - 100% coverage (12/12 ACs validated)

### Requirements Traceability (Given-When-Then)

**AC 1: Primary Access - Slide-Over Panel**
- **Given** user is on intermediary card page
- **When** they click document summary card
- **Then** slide-over panel opens from right with PDF viewer
- ✅ **Validated**: DocumentCard.tsx:49-50 (onClick), page.tsx:211 (setIsPanelOpen)

**AC 2: PDF Display in Panel**
- **Given** slide-over panel is open
- **When** PDF loads
- **Then** displays using browser native viewer with controls
- ✅ **Validated**: FileViewerPanel.tsx:115-126 (embed with type="application/pdf")

**AC 3: Secondary Access - Download Button**
- **Given** user views intermediary card
- **When** they click download icon button
- **Then** PDF downloads with correct filename
- ✅ **Validated**: DocumentCard.tsx:33-45, FileViewerPanel.tsx:29-36

**AC 4: Panel Header**
- **Given** panel is open
- **When** user views header
- **Then** shows filename, download button, close button
- ✅ **Validated**: FileViewerPanel.tsx:51-76 (SheetHeader)

**AC 5-6: Integration Requirements**
- **Given** successful file upload
- **When** analyze page loads
- **Then** blob URL and filename retrieved from sessionStorage
- ✅ **Validated**: page.tsx:46-65, upload/page.tsx:94-101

**AC 7-8: Panel State & API**
- **Given** user interactions
- **When** panel opens/closes
- **Then** React state manages panel without new APIs
- ✅ **Validated**: page.tsx:43 (isPanelOpen), FileViewerPanel.tsx:44 (Sheet)

**AC 9: Mobile Responsive**
- **Given** mobile viewport (<768px)
- **When** panel opens
- **Then** becomes full-screen
- ✅ **Validated**: FileViewerPanel.tsx:47 (responsive classes)

**AC 10: Accessibility**
- **Given** assistive technology users
- **When** they interact with panel
- **Then** ARIA labels, focus trap, ESC key work
- ✅ **Validated**: FileViewerPanel.tsx:48,63,71,130-132

**AC 11: Performance**
- **Given** analyze page loads
- **When** panel is closed
- **Then** PDF NOT loaded (lazy loading)
- ✅ **Validated**: FileViewerPanel.tsx:115 (isOpen && condition)

**AC 12: Error Handling**
- **Given** PDF fails to render
- **When** error occurs
- **Then** graceful fallback with download option
- ✅ **Validated**: FileViewerPanel.tsx:91-112

**Coverage: 12/12 ACs - 100%** ✅

### Improvements Checklist

**All items deferred to future iterations** - prioritizing hackathon velocity:

- [ ] Extract duplicate download logic to `lib/utils.ts` (REFACTOR-001)
- [ ] Extract sessionStorage parsing to utility function
- [ ] Monitor PDF embed error rates by browser/device in production
- [ ] Consider Tailwind class reordering for strict standard compliance (cosmetic only)

### Security Review

**Status: PASS** ✓

- ✅ No `dangerouslySetInnerHTML` usage
- ✅ XSS protection via React's default escaping
- ✅ Event propagation properly stopped (prevents click jacking)
- ✅ Blob URLs are public (acceptable for MVP per Story 1.2 design)
- ✅ No sensitive data in sessionStorage
- 🔍 **Observation**: Public blob URLs are by design for this MVP - acceptable security posture

### Performance Considerations

**Status: PASS with monitoring recommendation** ✓

**Strengths**:
- ✅ Lazy loading implemented (PDF only loads when panel opens)
- ✅ Component cleanup handled by Sheet unmount
- ✅ No unnecessary re-renders
- ✅ Minimal bundle impact (shadcn Sheet is lightweight)
- ✅ Loading spinner prevents perceived slowness

**Monitoring Recommendations**:
- 📊 Track PDF load times for files >10MB on mobile networks
- 📊 Monitor error rates by browser/device type
- 💡 Story 1.2's 25MB file limit provides reasonable upper bound

### Non-Functional Requirements Validation

**Security**: ✓ PASS - No security concerns for MVP scope
**Performance**: ✓ PASS - Lazy loading + loading states + file size limits
**Reliability**: ✓ PASS - Comprehensive error handling + retry + fallback
**Maintainability**: ✓ PASS - Clean architecture + standards compliance + self-documenting code

### Files Modified During Review

**None** - No code changes made during QA review. Implementation quality is high enough for MVP release.

### Gate Status

**Gate**: CONCERNS → docs/qa/gates/2.2.1-source-file-viewer.yml
**Quality Score**: 90/100
**Risk Profile**: Medium (browser compatibility) + 3 Low risks
**NFR Assessment**: All PASS (Security, Performance, Reliability, Maintainability)

**Gate Decision Rationale**:
Implementation is excellent with 100% AC coverage and high code quality. Gate set to CONCERNS (not PASS) due to browser compatibility risk on mobile devices - PDF embed may not work on mobile Safari. However, this risk has appropriate mitigations:
1. Error state with user-friendly message
2. Prominent download button fallback
3. Retry functionality

This is a **SHIP-WORTHY** concern that should be monitored in production, not a blocking issue.

### Recommended Status

**✓ Ready for Done** - Story owner may proceed to Done status.

**Post-Deployment Actions**:
1. Monitor PDF embed error rates by browser/device type
2. Track user analytics for download button usage patterns
3. Address REFACTOR-001 (extract download logic) in next refactoring sprint
4. Consider alternative PDF viewer library if mobile error rate exceeds 20%
