# Story 10.1: database-schema-update

## Status
Draft

## Story
**As a** backend developer,
**I want** to add database columns for stage outputs and full report markdown,
**so that** all pipeline analysis data persists and users can access results after pipeline completion

## Acceptance Criteria

1. `PipelineRun` model updated with 5 new fields: `stage1Output`, `stage2Output`, `stage3Output`, `stage4Output`, `fullReportMarkdown`
2. All new fields are nullable for backward compatibility
3. Migration generated and runs successfully without errors
4. Prisma client regenerated with TypeScript types for new fields
5. Existing `PipelineRun` records remain intact after migration
6. Migration tested on development database before production deployment

## Tasks / Subtasks

- [ ] Update Prisma schema (AC: 1, 2)
  - [ ] Add `stage1Output Json?` field
  - [ ] Add `stage2Output Json?` field
  - [ ] Add `stage3Output Json?` field
  - [ ] Add `stage4Output Json?` field
  - [ ] Add `fullReportMarkdown String? @db.Text` field
- [ ] Generate and test migration (AC: 3, 6)
  - [ ] Run `npx prisma migrate dev --name add_stage_outputs_and_report`
  - [ ] Verify migration SQL script
  - [ ] Test migration on local development database
  - [ ] Verify existing records unchanged
- [ ] Regenerate Prisma client (AC: 4)
  - [ ] Run `npx prisma generate`
  - [ ] Verify TypeScript types include new fields
  - [ ] Test API queries with new fields (should return null for old records)
- [ ] Documentation (AC: 6)
  - [ ] Update architecture documentation with schema changes
  - [ ] Document rollback procedure
  - [ ] Add migration notes to deployment guide

## Dev Notes

**Relevant Source Tree:**
- `innovation-web/prisma/schema.prisma` - Prisma schema definition
- `innovation-web/prisma/migrations/` - Migration history
- `docs/architecture/` - Architecture documentation (if sharded)

**Schema Changes Required:**

```prisma
model PipelineRun {
  id          String   @id @default(uuid())
  userId      String
  documentName String
  companyName  String
  status       String  // PROCESSING, COMPLETED, FAILED, CANCELLED
  currentStage Int     // 1-5
  blobUrl      String
  createdAt    DateTime @default(now())
  completedAt  DateTime?

  // NEW FIELDS - Stage Outputs
  stage1Output       Json?    // { extractedText: string, mechanisms: array }
  stage2Output       Json?    // { signals: array }
  stage3Output       Json?    // { insights: array }
  stage4Output       Json?    // { preliminary: array }

  // NEW FIELD - Full Report
  fullReportMarkdown String?  @db.Text

  opportunityCards OpportunityCard[]
  user            User @relation(fields: [userId], references: [id])
}
```

**Data Type Justification:**
- `Json?`: Flexible storage for varying stage output structures, queryable with Prisma JSON operators
- `String? @db.Text`: Large text storage for markdown reports (up to 1GB in PostgreSQL)
- Nullable (`?`): Ensures existing records without outputs remain valid

**Migration Commands:**
```bash
# From innovation-web directory
cd innovation-web

# Generate migration
npx prisma migrate dev --name add_stage_outputs_and_report

# Regenerate Prisma client
npx prisma generate

# Verify types updated
# Check: node_modules/.prisma/client/index.d.ts includes new fields
```

**Important Constraints:**
- Migration MUST complete before Stories 10.2-10.5 can begin (backend depends on these columns existing)
- Production deployment requires database migration coordination
- JSON storage size should be monitored (estimate: 10-50KB per run)

**Risk Mitigation:**
- Primary Risk: Database migration failure in production causing downtime
- Mitigation: Test migration on production database clone first, run during low-traffic window
- Rollback: `npx prisma migrate resolve --rolled-back add_stage_outputs_and_report`

**Dependencies:**
- Blocks Stories 10.2, 10.3, 10.4, 10.5 (requires database columns to exist)
- Blocked By: None (foundational story)

### Testing

**Test File Location:**
- Manual testing in Prisma Studio and API routes
- No dedicated test file needed (schema validation)

**Testing Standards:**
- Verify migration generates valid SQL
- Test on development database before production
- Verify backward compatibility with existing records

**Testing Frameworks:**
- Prisma CLI migration tooling
- PostgreSQL database

**Specific Testing Requirements:**

1. **Migration Validation:**
   ```bash
   # Run migration on development database
   npx prisma migrate dev --name add_stage_outputs_and_report

   # Verify SQL generated is correct
   cat prisma/migrations/*/migration.sql
   ```

2. **Existing Data Verification:**
   ```bash
   # Open Prisma Studio
   npx prisma studio

   # Query existing PipelineRun records
   # Verify new fields show as null
   # Verify existing fields unchanged
   ```

3. **Type Safety Verification:**
   ```typescript
   // In a test API route or script
   import { prisma } from '@/lib/prisma'

   const run = await prisma.pipelineRun.findFirst()

   // TypeScript should recognize these fields
   console.log(run?.stage1Output) // Should be null for old records
   console.log(run?.fullReportMarkdown) // Should be null for old records
   ```

4. **New Record Creation Test:**
   ```typescript
   const newRun = await prisma.pipelineRun.create({
     data: {
       userId: "test-user",
       documentName: "test.pdf",
       companyName: "Test Corp",
       status: "PROCESSING",
       currentStage: 1,
       blobUrl: "https://example.com/test.pdf",
       stage1Output: { extractedText: "test", mechanisms: [] }
     }
   })

   console.log(newRun.stage1Output) // Should contain JSON object
   ```

**Production Deployment Testing:**
1. Clone production database using Railway CLI
2. Test migration on clone: `DATABASE_URL="postgresql://staging-url" npx prisma migrate deploy`
3. Verify no errors in migration logs
4. Query existing records to verify data integrity
5. Deploy to production during low-traffic window

**Success Metrics:**
- Migration completes in < 30 seconds
- Zero downtime during deployment
- All existing API tests pass after migration
- No errors in application logs post-migration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation from Pipeline Persistence Epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
