# Story 1.3: Upload Page UI with Company Badge

**Epic:** Epic 1 - Core Upload & File Management
**Priority:** P0
**Estimated Time:** 1.5 hours

---

## Status

**Draft**

---

## Story

**As a** Innovation Manager,
**I want** to see my selected company and drag & drop files to upload,
**so that** I can easily submit market signals for analysis with my brand context visible.

---

## Acceptance Criteria

1. Page route exists at `/upload`
2. On page load, call `GET /api/onboarding/current-company` to check cookie
3. If no cookie found, redirect to `/` (root landing page)
4. If cookie exists, display company name in badge at top-right corner
5. Badge format: "{Company Name} üè¢" (e.g., "Lactalis Canada üè¢")
6. Badge uses shadcn/ui Badge component with gray, non-intrusive styling
7. Page displays title: "My Board of Ideators" centered at top with "My" in teal italics
8. Central upload area has dashed border and upload icon (üì§)
9. Upload zone text: "Drag & drop or choose file to upload"
10. Supported types displayed: "Supported types: PDF, txt, Markdown"
11. User can click upload zone to open file picker
12. User can drag & drop file from desktop onto upload zone
13. Visual feedback on drag-over (border changes to solid, background highlight)
14. Uses `react-dropzone` library for drag & drop functionality
15. On file selection, immediately call `POST /api/upload` with FormData
16. Display progress bar with percentage during upload
17. Show file name and size below progress bar (human-readable format: "2.3 MB")
18. On upload success, save `blob_url` to sessionStorage with key: `upload_${upload_id}`
19. On upload success, redirect to `/analyze/${upload_id}`
20. On upload error, display error message below upload zone
21. On error, allow retry (zone remains interactive)
22. Idle state: Upload zone with icon and text
23. Uploading state: Progress bar replaces upload icon, zone disabled
24. Success state: Brief checkmark (‚úì) visible for 500ms before redirect
25. Error state: Error message with red border, zone interactive
26. Placeholder buttons below zone: [Link] [Website] [YouTube] [Paste text] (disabled, grayed out)
27. Layout matches reference design `docs/image/main-page.png`
28. Upload zone: Centered card with padding, max-width 600px
29. Company badge: Top-right corner, absolute positioning
30. API route `GET /api/onboarding/current-company` exists
31. API uses `cookies()` from `next/headers` to read cookie
32. API returns company name from YAML file
33. Uses Next.js `useRouter().push()` for client-side navigation
34. No page reload on redirect, maintains SPA experience
35. Upload ID in URL format: `/analyze/upload-1729349025123`
36. Error handling for network error: "Network error. Please check your connection."
37. Error handling for invalid file type: "Invalid file type. Please upload PDF, TXT, or MD files."
38. Error handling for file too large: "File too large. Maximum size is 25MB."
39. Error handling for upload API error: "Upload failed. Please try again."
40. Missing cookie: Silent redirect to `/` with no error flash
41. Upload zone has `role="button"` and proper ARIA labels
42. Keyboard navigation: Tab to focus, Enter/Space to open file picker
43. Screen reader announces upload progress percentage
44. Error messages have `role="alert"`
45. Upload progress updates smoothly (no jumps)
46. No layout shift during state transitions
47. Loading skeleton for company badge while fetching (optional polish)
48. No console errors or warnings in browser
49. TypeScript compilation passes with no errors
50. Manual testing completed with all 3 file types (PDF, TXT, MD)

---

## Tasks / Subtasks

- [ ] Task 1: Install dependencies and setup (AC: 14, 6)
  - [ ] Install react-dropzone: `npm install react-dropzone`
  - [ ] Install shadcn/ui components: `npx shadcn-ui@latest add badge progress card`
  - [ ] Verify installations in package.json

- [ ] Task 2: Create company context API route (AC: 30, 31, 32)
  - [ ] Create `app/api/onboarding/current-company/route.ts`
  - [ ] Implement GET handler
  - [ ] Read `company_id` cookie using `cookies().get('company_id')?.value`
  - [ ] Return 401 if no cookie: `{error: 'No company selected'}`
  - [ ] Load YAML file from `data/brand-profiles/${companyId}.yaml`
  - [ ] Parse YAML and return: `{company_id, company_name: profile.brand_name}`
  - [ ] Handle errors: 500 for file read/parse failures

- [ ] Task 3: Create upload page component structure (AC: 1, 7, 27, 28, 29)
  - [ ] Create `app/upload/page.tsx` as client component
  - [ ] Add page title "My Board of Ideators" with styled "My" in teal italics
  - [ ] Create max-width container (600px) for upload zone
  - [ ] Position company badge at top-right corner (absolute positioning)
  - [ ] Set background to light gray/off-white

- [ ] Task 4: Implement company context check (AC: 2, 3, 4, 5, 6, 40, 47)
  - [ ] Create state: `const [companyName, setCompanyName] = useState<string>('')`
  - [ ] Add useEffect hook to call `/api/onboarding/current-company` on mount
  - [ ] On error or no cookie, redirect to `/` using `router.push('/')`
  - [ ] On success, set company name state
  - [ ] Display Badge component with company name and üè¢ emoji
  - [ ] Show loading skeleton while fetching (optional)

- [ ] Task 5: Implement drag & drop upload zone (AC: 8, 9, 10, 11, 12, 13, 14, 22, 23, 24, 25)
  - [ ] Initialize useDropzone hook with config:
    - `accept: {'application/pdf': ['.pdf'], 'text/plain': ['.txt'], 'text/markdown': ['.md']}`
    - `maxSize: 25 * 1024 * 1024` (25MB)
    - `multiple: false`
    - `disabled: uploading`
  - [ ] Apply getRootProps() to upload zone div
  - [ ] Apply getInputProps() to hidden input element
  - [ ] Style upload zone: dashed border, padding, centered content
  - [ ] Show upload icon (üì§) in idle state
  - [ ] Display text: "Drag & drop or choose file to upload"
  - [ ] Display supported types: "Supported types: PDF, txt, Markdown"
  - [ ] Add hover state with solid border
  - [ ] Add drag-over state with blue highlight: `isDragActive ? 'border-blue-500 bg-blue-50' : ''`

- [ ] Task 6: Implement file upload flow (AC: 15, 16, 17, 18, 19, 20, 21)
  - [ ] Create state: `uploading`, `uploadProgress`, `error`, `fileName`, `fileSize`
  - [ ] Implement onDrop handler
  - [ ] Extract first file: `const file = acceptedFiles[0]`
  - [ ] Set uploading=true, clear error, set file metadata
  - [ ] Create FormData and append file
  - [ ] Simulate progress with setInterval (10% every 200ms up to 90%)
  - [ ] Call `fetch('/api/upload', {method: 'POST', body: formData})`
  - [ ] On success: clear interval, set progress to 100%
  - [ ] Parse response JSON: `{upload_id, blob_url}`
  - [ ] Save to sessionStorage: `sessionStorage.setItem(`upload_${upload_id}`, blob_url)`
  - [ ] Wait 500ms (show checkmark)
  - [ ] Redirect: `router.push(`/analyze/${upload_id}`)`
  - [ ] On error: display error message, reset uploading state

- [ ] Task 7: Create progress bar component (AC: 16, 17, 43, 45)
  - [ ] Use shadcn/ui Progress component
  - [ ] Display during uploading state
  - [ ] Show percentage: "Uploading... {uploadProgress}%"
  - [ ] Show file name and size in human-readable format
  - [ ] Add smooth transitions (no jumps)
  - [ ] Announce progress to screen readers (aria-live)

- [ ] Task 8: Implement state transitions (AC: 22, 23, 24, 25, 46)
  - [ ] Idle: Upload icon + text
  - [ ] Uploading: Progress bar, disabled zone
  - [ ] Success: Checkmark (‚úì) emoji for 500ms
  - [ ] Error: Error message below zone, zone interactive
  - [ ] Ensure no layout shift between states

- [ ] Task 9: Add placeholder buttons (AC: 26)
  - [ ] Create button row: [Link] [Website] [YouTube] [Paste text]
  - [ ] Set all buttons to disabled
  - [ ] Apply opacity-40 or gray styling
  - [ ] Add cursor-not-allowed

- [ ] Task 10: Implement error handling (AC: 20, 21, 36, 37, 38, 39, 40)
  - [ ] Handle network errors: "Network error. Please check your connection."
  - [ ] Handle API validation errors from response JSON
  - [ ] Display error message in red bordered box below upload zone
  - [ ] Add "Try Again" button that clears error
  - [ ] Apply `role="alert"` to error message div

- [ ] Task 11: Implement accessibility (AC: 41, 42, 43, 44)
  - [ ] Add `role="button"` to upload zone
  - [ ] Add `aria-label="Upload file"` to upload zone
  - [ ] Add `tabIndex={0}` for keyboard focus
  - [ ] Test Tab key navigation
  - [ ] Test Enter/Space key to open file picker
  - [ ] Add `aria-live="polite"` to progress text for screen readers
  - [ ] Add `role="alert"` to error messages

- [ ] Task 12: Implement navigation and redirect (AC: 19, 33, 34, 35)
  - [ ] Import `useRouter` from 'next/navigation'
  - [ ] Call `router.push(`/analyze/${upload_id}`)` after success
  - [ ] Verify client-side navigation (no page reload)
  - [ ] Verify URL format: `/analyze/upload-1729349025123`

- [ ] Task 13: Helper functions (AC: 17)
  - [ ] Create `formatFileSize(bytes: number): string` function
  - [ ] Return formatted string: "2.3 MB", "1.5 KB", "345 B"
  - [ ] Use in file size display

- [ ] Task 14: Visual design polish (AC: 27, 28, 29, 46)
  - [ ] Match reference design `docs/image/main-page.png`
  - [ ] Fine-tune spacing, colors, typography
  - [ ] Ensure centered layout with proper padding
  - [ ] Verify company badge positioning
  - [ ] Test layout shift during state transitions

- [ ] Task 15: Testing (AC: 48, 49, 50)
  - [ ] Test upload flow with PDF file
  - [ ] Test upload flow with TXT file
  - [ ] Test upload flow with MD file
  - [ ] Test drag & drop vs. click-to-upload
  - [ ] Test keyboard navigation (Tab, Enter, Space)
  - [ ] Test error scenarios (no cookie, network error, invalid file)
  - [ ] Test with all 4 company contexts (Lactalis, Columbia, Decathlon, McCormick)
  - [ ] Verify sessionStorage contains blob URL after upload
  - [ ] Check browser console for errors
  - [ ] Run TypeScript compiler: `npm run build`

---

## Dev Notes

### Existing System Integration
- **Depends on:** Story 1.1 (company cookie), Story 1.2 (upload API)
- **Integration Points:**
  - Reads `company_id` cookie set by Story 1.1
  - Calls `POST /api/upload` from Story 1.2
  - Saves `blob_url` to sessionStorage for Epic 2 (analyze page)
- **Technology Stack:** Next.js 15, React 19, react-dropzone 14.x, shadcn/ui

### Route Structure
- **This Route:** `app/upload/page.tsx` - Upload page
- **Previous Route:** `/` (root) - Landing page from Story 1.1
- **Next Route:** `/analyze/{uploadId}` - Analysis page from Epic 2
- **API Dependency:** `POST /api/upload` from Story 1.2

### Component Architecture
```
app/
  upload/
    page.tsx                 # Upload page (client component)
  api/
    onboarding/
      current-company/
        route.ts             # GET endpoint for company context
components/
  ui/
    badge.tsx                # shadcn/ui Badge
    progress.tsx             # shadcn/ui Progress
    card.tsx                 # shadcn/ui Card
```

### State Management
```typescript
const [companyName, setCompanyName] = useState<string>('')
const [uploading, setUploading] = useState(false)
const [uploadProgress, setUploadProgress] = useState(0)
const [error, setError] = useState('')
const [fileName, setFileName] = useState('')
const [fileSize, setFileSize] = useState(0)
```

### SessionStorage Key Format
- **Key:** `upload_${upload_id}`
- **Value:** Full blob URL string
- **Example:** `upload_upload-1729349025123` ‚Üí `"https://blob.vercel-storage.com/uploads/..."`
- **Purpose:** Pass blob URL to analyze page without URL parameter
- **Cleanup:** Cleared after pipeline completion (Epic 3)

### useDropzone Configuration
```typescript
const { getRootProps, getInputProps, isDragActive } = useDropzone({
  onDrop,
  accept: {
    'application/pdf': ['.pdf'],
    'text/plain': ['.txt'],
    'text/markdown': ['.md']
  },
  maxSize: 25 * 1024 * 1024,  // 25MB
  multiple: false,
  disabled: uploading
})
```

### Progress Simulation
- **Real Progress:** Requires XHR with onProgress callback (fetch API doesn't support)
- **Hackathon Approach:** Simulate progress with setInterval
- **Algorithm:** Increment 10% every 200ms up to 90%, then jump to 100% on API success
- **Future Enhancement:** Replace with XHR for real progress tracking

### Error Message Mapping
| Scenario | Message |
|----------|---------|
| No cookie | Silent redirect to `/` (no message) |
| Network error | "Network error. Please check your connection." |
| Invalid file type | "Invalid file type. Please upload PDF, TXT, or MD files." |
| File too large | "File too large. Maximum size is 25MB." |
| API error | "Upload failed. Please try again." |

### Visual Design Reference
- Reference image: `docs/image/main-page.png`
- Background: Light gray (#F9FAFB)
- Upload zone: White card with dashed border (#E5E7EB)
- Drag-over: Blue highlight (#DBEAFE) with solid border (#3B82F6)
- Progress bar: Teal accent (#14B8A6)

### Dependencies
- `react-dropzone`: ^14.0.0
- `@/components/ui/badge`: shadcn/ui
- `@/components/ui/progress`: shadcn/ui
- `@/components/ui/card`: shadcn/ui

### Testing

#### Test File Location
- Use existing: `data/test-inputs/savannah-bananas.pdf`
- Create test files: `test.txt`, `test.md`

#### Testing Standards
- **Browser Support:** Chrome, Safari, Firefox (desktop only)
- **Keyboard Navigation:** Full keyboard accessibility required
- **Screen Readers:** ARIA labels and live regions required
- **TypeScript:** Zero compilation errors

#### Testing Frameworks and Patterns
- Manual testing only (no automated tests for hackathon)
- Test all user flows and error scenarios
- Verify sessionStorage and redirects

#### Specific Testing Requirements
1. Test drag & drop for all 3 file types
2. Test click-to-upload for all 3 file types
3. Test with all 4 company contexts
4. Test keyboard navigation (Tab, Enter, Space)
5. Test error recovery (retry after error)
6. Verify sessionStorage contains blob URL
7. Verify redirect to `/analyze/{uploadId}` works
8. Test without company cookie (expect redirect to `/`)

### Test Scenarios
```bash
# Manual test flow:
1. Complete Story 1.1 (set company cookie via landing page)
2. Navigate to /upload
3. Verify company badge displays correct company name
4. Drag & drop PDF file onto upload zone
5. Verify progress bar animates
6. Verify checkmark appears briefly
7. Verify redirect to /analyze/{uploadId}
8. Open browser DevTools > Application > Session Storage
9. Verify key: upload_{uploadId} with blob URL value
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation using BMAD template | John (PM Agent) |

---

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent during implementation*

### Debug Log References

*To be populated by dev agent during implementation*

### Completion Notes List

*To be populated by dev agent during implementation*

### File List

*To be populated by dev agent during implementation*

Expected files:
- `app/upload/page.tsx`
- `app/api/onboarding/current-company/route.ts`
- `components/ui/badge.tsx` (from shadcn/ui)
- `components/ui/progress.tsx` (from shadcn/ui)
- `components/ui/card.tsx` (from shadcn/ui)

---

## QA Results

*To be populated by QA agent after implementation*
