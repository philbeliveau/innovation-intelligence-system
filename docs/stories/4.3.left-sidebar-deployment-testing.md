# Story 4.3: Left Sidebar & Deployment Testing

## Status

Draft

## Story

**As a** Innovation Manager,
**I want** to easily navigate back to the upload page from any screen and have confidence that the deployed application works reliably,
**so that** I can efficiently run multiple pipeline iterations and trust the system for client demonstrations.

## Acceptance Criteria

1. Collapsible left sidebar component created and integrated
2. Sidebar hidden by default (collapsed state)
3. Sidebar slides in when user hovers at left edge of screen (within 20px)
4. Sidebar slides out when mouse leaves sidebar area
5. Transition animation smooth (300ms duration)
6. Sidebar displays "üè† Home" button with icon
7. Clicking "Home" button navigates to `/upload` page
8. Sidebar accessible from all pages (pipeline viewer, results, upload, analyze)
9. Sidebar preserves company context across navigation
10. Error boundary component wraps entire application
11. Error boundary catches and displays runtime errors gracefully
12. Error boundary provides "Try Again" and "Return to Upload" buttons
13. Application deployed to Vercel with production environment
14. Environment variables set correctly in Vercel dashboard
15. End-to-end test passes: upload ‚Üí analyze ‚Üí pipeline ‚Üí results
16. No console errors in production deployment
17. Python pipeline executes successfully in Vercel environment
18. Status polling works correctly in production
19. File uploads to Vercel Blob succeed
20. Markdown rendering works in production
21. Mobile responsiveness verified in production
22. Page load performance acceptable (< 3s initial load)

## Tasks / Subtasks

- [ ] Create left sidebar component (AC: 1-9)
  - [ ] Create `components/LeftSidebar.tsx` component
  - [ ] Implement fixed position layout (left: 0, top: 0, full height)
  - [ ] Add collapsed state (translate-x-full hidden off-screen)
  - [ ] Add hover detection zone (absolute positioned div, 20px width at left edge)
  - [ ] Implement hover handlers to toggle sidebar visibility
  - [ ] Add CSS transition (300ms ease-in-out)
  - [ ] Add "üè† Home" button with icon and text
  - [ ] Implement navigation: `router.push('/upload')`
  - [ ] Style with dark background (bg-gray-800) and white text
  - [ ] Set z-index high enough to appear above content (z-50)

- [ ] Integrate sidebar into app layout (AC: 8)
  - [ ] Add sidebar to root layout: `app/layout.tsx`
  - [ ] Ensure sidebar appears on all pages
  - [ ] Verify sidebar doesn't interfere with page content
  - [ ] Test sidebar on all routes (/, /upload, /analyze/[id], /pipeline/[id], /results/[id])

- [ ] Create error boundary component (AC: 10-12)
  - [ ] Create `app/error.tsx` for global error boundary
  - [ ] Implement error UI with friendly message
  - [ ] Add error details display (error.message)
  - [ ] Add "Try Again" button with reset() handler
  - [ ] Add "Return to Upload" button with navigation
  - [ ] Style error page consistently with app design
  - [ ] Test error boundary by throwing test error

- [ ] Prepare for deployment (AC: 13)
  - [ ] Review `vercel.json` configuration (if exists)
  - [ ] Verify `package.json` build scripts
  - [ ] Check Python requirements.txt is up to date
  - [ ] Review environment variable requirements
  - [ ] Create `.env.example` file with required variables

- [ ] Set up Vercel project (AC: 13, 14)
  - [ ] Install Vercel CLI: `npm i -g vercel`
  - [ ] Run `vercel login` to authenticate
  - [ ] Run `vercel` to link project (first deployment)
  - [ ] Configure environment variables in Vercel dashboard:
    - OPENROUTER_API_KEY
    - OPENROUTER_BASE_URL
    - LLM_MODEL
    - BLOB_READ_WRITE_TOKEN (auto-generated)
  - [ ] Verify Python runtime settings (if configurable)

- [ ] Deploy to production (AC: 13)
  - [ ] Run `vercel --prod` for production deployment
  - [ ] Wait for deployment to complete
  - [ ] Note production URL
  - [ ] Verify deployment succeeded in Vercel dashboard

- [ ] Test Python pipeline in production (AC: 17)
  - [ ] Create test API route: `/api/test-python`
  - [ ] Test Python version: `python --version`
  - [ ] Deploy and verify Python is available
  - [ ] If Python unavailable, implement contingency (separate Python server)
  - [ ] Test pipeline execution with sample file

- [ ] Run end-to-end test in production (AC: 15)
  - [ ] Navigate to production URL
  - [ ] Test onboarding: Enter "Lactalis" ‚Üí verify redirect to /upload
  - [ ] Test upload: Drag & drop `savannah-bananas.pdf` ‚Üí verify file uploads
  - [ ] Test analysis: Verify intermediary card displays with LLM extraction
  - [ ] Test launch: Click "Launch" ‚Üí verify redirect to /pipeline/[runId]
  - [ ] Test pipeline viewer: Watch stages progress (wait 15-30 minutes)
  - [ ] Verify Stage 1 tracks display correctly
  - [ ] Verify status polling updates every 5 seconds
  - [ ] Verify automatic redirect to /results/[runId] on completion
  - [ ] Test results: Verify all 5 opportunity cards render
  - [ ] Test navigation: Click "New Pipeline" ‚Üí verify redirect to /upload

- [ ] Verify production functionality (AC: 16-22)
  - [ ] Open browser DevTools console
  - [ ] Navigate through all pages
  - [ ] Check for console errors or warnings
  - [ ] Test status polling (Network tab - verify 5-second intervals)
  - [ ] Test Vercel Blob upload (verify file appears in Blob dashboard)
  - [ ] Test markdown rendering (verify formatting looks correct)
  - [ ] Test on mobile device (real device or DevTools responsive mode)
  - [ ] Measure page load performance (Lighthouse or Network tab)
  - [ ] Verify no critical performance issues

- [ ] Document deployment (AC: 22)
  - [ ] Note production URL in README or deployment docs
  - [ ] Document any deployment issues encountered
  - [ ] Document environment variables required
  - [ ] Create deployment checklist for future deployments

- [ ] Final polish and testing (AC: 16)
  - [ ] Review all pages for visual consistency
  - [ ] Check responsive layout on all screen sizes
  - [ ] Verify company context persists across navigation
  - [ ] Test error scenarios (invalid company, missing files, etc.)
  - [ ] Verify left sidebar works on all pages
  - [ ] Test keyboard navigation (tab through interactive elements)

## Dev Notes

### Relevant Source Tree

**Components to Create:**
- `components/LeftSidebar.tsx` - Collapsible sidebar with home navigation
- `app/error.tsx` - Global error boundary

**Existing Files to Modify:**
- `app/layout.tsx` - Add sidebar component

**Vercel Configuration:**
- `vercel.json` - Optional configuration file
- `.env.example` - Document required environment variables

**shadcn/ui Components:**
- `Button` - Home button in sidebar
- Custom CSS for sidebar animation

**Environment Variables Required:**
```bash
# .env.local (development)
OPENROUTER_API_KEY=sk-or-v1-...
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
LLM_MODEL=anthropic/claude-sonnet-4.5

# Vercel auto-generates:
BLOB_READ_WRITE_TOKEN=vercel_blob_...
```

**Left Sidebar Implementation Pattern:**
```typescript
'use client'
import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'

export function LeftSidebar() {
  const router = useRouter()
  const [isVisible, setIsVisible] = useState(false)

  return (
    <>
      {/* Hover detection zone */}
      <div
        className="fixed left-0 top-0 h-full w-5 z-40"
        onMouseEnter={() => setIsVisible(true)}
      />

      {/* Sidebar */}
      <div
        className={`fixed left-0 top-0 h-full w-48 bg-gray-800 text-white z-50 transition-transform duration-300 ${
          isVisible ? 'translate-x-0' : '-translate-x-full'
        }`}
        onMouseLeave={() => setIsVisible(false)}
      >
        <div className="p-4">
          <Button
            variant="ghost"
            className="w-full justify-start text-white hover:bg-gray-700"
            onClick={() => router.push('/upload')}
          >
            üè† Home
          </Button>
        </div>
      </div>
    </>
  )
}
```

**Error Boundary Implementation:**
```typescript
// app/error.tsx
'use client'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <div className="flex min-h-screen flex-col items-center justify-center p-8">
      <div className="max-w-md text-center">
        <h2 className="text-2xl font-bold mb-4 text-red-600">
          Something went wrong!
        </h2>
        <p className="text-gray-600 mb-6">{error.message}</p>
        <div className="flex gap-4 justify-center">
          <button
            onClick={() => reset()}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >
            Try Again
          </button>
          <button
            onClick={() => window.location.href = '/upload'}
            className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
          >
            Return to Upload
          </button>
        </div>
      </div>
    </div>
  )
}
```

**Vercel Deployment Commands:**
```bash
# First deployment (link project)
vercel

# Production deployment
vercel --prod

# Check deployment status
vercel ls

# View logs
vercel logs [deployment-url]
```

**Python Environment Check:**
```typescript
// app/api/test-python/route.ts
import { exec } from 'child_process'
import { NextResponse } from 'next/server'

export async function GET() {
  return new Promise((resolve) => {
    exec('python --version', (error, stdout, stderr) => {
      resolve(NextResponse.json({
        pythonAvailable: !error,
        version: stdout || 'Not available',
        error: error?.message || null
      }))
    })
  })
}
```

**Contingency Plan (if Python not available on Vercel):**
1. **Option A:** Deploy Python pipeline to Render.com or Railway
   - Create separate Python service
   - Expose webhook endpoint for pipeline execution
   - Next.js triggers pipeline via HTTP request
   - Next.js polls status via API endpoint

2. **Option B:** Use Docker with Railway/Fly.io
   - Create Dockerfile combining Next.js + Python
   - Deploy entire stack in single container

3. **Option C:** Use Replit or PythonAnywhere
   - Host Python pipeline on Python-native platform
   - Integrate via API calls

**Critical Pre-Deployment Checks:**
- ‚úÖ All API routes functional locally
- ‚úÖ Python pipeline runs successfully locally
- ‚úÖ Environment variables documented
- ‚úÖ Vercel Blob integration tested
- ‚úÖ All pages accessible and functional
- ‚úÖ No console errors in development

**End-to-End Test Checklist:**
- [ ] Onboarding flow (company selection)
- [ ] File upload to Vercel Blob
- [ ] LLM document analysis
- [ ] Intermediary card display
- [ ] Pipeline execution trigger
- [ ] Status polling (5-second intervals)
- [ ] Stage 1 track visualization
- [ ] Stages 2-5 progress indicators
- [ ] Automatic redirect to results
- [ ] All 5 opportunity cards render
- [ ] "New Pipeline" button navigation
- [ ] Left sidebar navigation
- [ ] Error boundary catches errors

**Performance Targets:**
- Initial page load: < 3 seconds
- API response time: < 2 seconds (except /run which is background)
- Status polling response: < 1 second
- Markdown rendering: Instant (client-side)

**Reference Documentation:**
- Vercel Deployment Guide: https://vercel.com/docs/deployments
- Vercel Environment Variables: https://vercel.com/docs/environment-variables
- Next.js Deployment: https://nextjs.org/docs/deployment

**Important Notes from Previous Stories:**
- Company context stored in HTTP-only cookie (7-day expiry)
- Pipeline runs in background (non-blocking `exec()`)
- Status polling interval: 5 seconds
- All routes use dynamic routing with params
- File uploads stored in Vercel Blob (public access)

### Testing

**Test File Location:**
- Manual end-to-end testing only for hackathon scope
- Future: E2E tests with Playwright or Cypress

**Test Standards:**
- All acceptance criteria must pass in production environment
- No console errors allowed in production
- Performance within acceptable limits
- Error boundary must catch and display errors gracefully
- Left sidebar must work on all pages

**Testing Frameworks and Patterns:**
- Manual testing with browser DevTools
- Vercel deployment logs for debugging
- Network tab monitoring for API requests
- Lighthouse for performance testing

**Specific Testing Requirements:**

1. **Left Sidebar Test:**
   - Navigate to each page (/, /upload, /analyze/[id], /pipeline/[id], /results/[id])
   - Hover at left edge of screen
   - Verify sidebar slides in smoothly
   - Click "Home" button
   - Verify navigation to /upload
   - Verify company context preserved

2. **Error Boundary Test:**
   - Trigger intentional error (e.g., undefined variable)
   - Verify error boundary catches error
   - Verify error message displays
   - Click "Try Again" - verify reset works
   - Click "Return to Upload" - verify navigation works

3. **Production Deployment Test:**
   - Run full end-to-end test with real file
   - Upload `savannah-bananas.pdf`
   - Select "Lactalis" company
   - Wait for full pipeline completion (15-30 minutes)
   - Verify all 5 opportunities generated
   - Check Vercel logs for any errors
   - Monitor Vercel Blob dashboard for file uploads

4. **Performance Test:**
   - Open Lighthouse in Chrome DevTools
   - Run audit on production URL
   - Target: Performance score > 70
   - Check Core Web Vitals (LCP, FID, CLS)
   - Verify no critical issues

5. **Python Environment Test:**
   - Visit `/api/test-python` endpoint in production
   - Verify Python is available
   - If not available, implement contingency plan
   - Test pipeline execution in production

6. **Mobile Responsiveness Test:**
   - Test on real mobile device (iOS/Android)
   - Or use Chrome DevTools device emulation
   - Test all pages at 375px width
   - Verify sidebar works on mobile
   - Verify all content readable and accessible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA Agent after story completion_
