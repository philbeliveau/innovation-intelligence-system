# Story 4.1: Horizontal Pipeline Viewer UI

## Status

Draft

## Story

**As a** Innovation Manager,
**I want** to watch the 5-stage innovation pipeline execute in real-time with a horizontal visual flow,
**so that** I can understand the processing stages and see the selected inspiration tracks while the system generates my brand-specific opportunities.

## Acceptance Criteria

1. Page displays at `/pipeline/[runId]` route with proper routing
2. Horizontal stage indicator row shows all 5 stages (Input Processing, Signal Amplification, Universal Translation, Brand Contextualization, Opportunity Generation)
3. Each stage box displays:
   - Stage number (1-5)
   - Short name ("Tracks", "Signals", "Lessons", "Context", "Opport.")
   - Status icon (⌛ pending, ⏳ running, ✓ complete)
4. Stage 1 displays 2 selected inspiration tracks in side-by-side card layout matching `docs/image/track-division.png`
5. Track cards show:
   - Track title
   - Track summary/content (2-3 sentences)
   - "Selected" indicator with checkmark
   - Loading skeleton state while data loads
6. Current stage detail panel displays:
   - Stage name and description
   - Progress indicator or status message
   - Estimated time remaining (when running)
7. Status polling occurs every 5 seconds via `/api/status/[runId]` endpoint
8. Frontend implements 35-minute timeout protection
9. Visual transitions occur when stages complete (checkmark appears, next stage activates)
10. Automatic redirect to `/results/[runId]` when Stage 5 completes (status === "complete")
11. Error states display user-friendly messages (pipeline timeout, pipeline failure)
12. "Back" button navigates to upload page
13. Company name displays in header (from cookie context)
14. No console errors during normal operation
15. Mobile responsive layout with basic Tailwind breakpoints

## Tasks / Subtasks

- [ ] Create `/app/pipeline/[runId]/page.tsx` route component (AC: 1)
  - [ ] Set up Next.js dynamic route with params extraction
  - [ ] Import required shadcn/ui components (Card, Badge, Progress, Separator)
  - [ ] Create client component wrapper for polling logic

- [ ] Build horizontal stage indicator component (AC: 2, 3)
  - [ ] Create `components/StageIndicator.tsx` component
  - [ ] Implement horizontal flex layout for 5 stage boxes
  - [ ] Add stage data array with numbers, names, descriptions
  - [ ] Render status icons based on current stage (pending/running/complete)
  - [ ] Add arrow/separator elements between stages
  - [ ] Style active stage with border highlight and pulse animation

- [ ] Create Stage 1 track display component (AC: 4, 5)
  - [ ] Create `components/InspirationTrack.tsx` component
  - [ ] Implement side-by-side card layout (Tailwind Grid or Flex)
  - [ ] Add track title, content, and "Selected ✓" indicator
  - [ ] Implement loading skeleton state using shadcn/ui Skeleton
  - [ ] Match visual design from `docs/image/track-division.png`
  - [ ] Handle track data from `inspirations.json` structure

- [ ] Build current stage detail panel (AC: 6)
  - [ ] Create `components/StageDetailPanel.tsx` component
  - [ ] Display stage name and full description
  - [ ] Add Progress component for current stage
  - [ ] Show status message ("Extracting trends...", etc.)
  - [ ] Calculate and display estimated time remaining
  - [ ] Update content based on current stage number

- [ ] Implement status polling logic (AC: 7, 8)
  - [ ] Set up `useEffect` hook for polling on component mount
  - [ ] Create `pollStatus` async function
  - [ ] Fetch from `/api/status/[runId]` every 5 seconds
  - [ ] Implement timeout check (35-minute max runtime)
  - [ ] Update component state with status data
  - [ ] Handle polling cleanup on component unmount
  - [ ] Stop polling when status === "complete" or "error"

- [ ] Add stage transition animations (AC: 9)
  - [ ] Animate checkmark appearance on stage completion
  - [ ] Highlight next stage when previous completes
  - [ ] Add smooth transitions using Tailwind transition classes

- [ ] Implement automatic redirect on completion (AC: 10)
  - [ ] Check if `current_stage === 5 && status === "complete"`
  - [ ] Use `useRouter` to navigate to `/results/[runId]`
  - [ ] Optional: Add 3-second countdown with "View Opportunities" button

- [ ] Add error handling and display (AC: 11)
  - [ ] Create error state in component
  - [ ] Display error message for timeout (> 35 minutes)
  - [ ] Display error message for pipeline failure (status === "error")
  - [ ] Show user-friendly error with support instructions
  - [ ] Provide "Return to Upload" button on error

- [ ] Add navigation and header elements (AC: 12, 13)
  - [ ] Add "Back" button in header (navigate to `/upload`)
  - [ ] Display company name from cookie context
  - [ ] Style header with consistent layout

- [ ] Implement responsive layout (AC: 15)
  - [ ] Add Tailwind responsive breakpoints (sm, md, lg)
  - [ ] Stack stage boxes vertically on mobile
  - [ ] Adjust track card layout for smaller screens
  - [ ] Test on mobile viewport sizes

## Dev Notes

### Relevant Source Tree

**Pages:**
- `app/pipeline/[runId]/page.tsx` - Main pipeline viewer page (to be created)
- `app/analyze/[uploadId]/page.tsx` - Previous page in flow (redirects here with "Launch" button)
- `app/results/[runId]/page.tsx` - Next page in flow (redirect destination)

**Components to Create:**
- `components/StageIndicator.tsx` - Horizontal stage box row
- `components/InspirationTrack.tsx` - Stage 1 two-track card display
- `components/StageDetailPanel.tsx` - Current stage progress panel

**API Integration:**
- `app/api/status/[runId]/route.ts` - Status polling endpoint (created in Epic 3)

**Data Sources:**
- `data/test-outputs/{runId}/stage1/inspirations.json` - Track data structure (from Story 3.2):
  ```json
  {
    "selected_tracks": [1, 2],
    "track_1": {
      "title": "Track 1 Title",
      "summary": "Summary of first track...",
      "icon_url": ""
    },
    "track_2": {
      "title": "Track 2 Title",
      "summary": "Summary of second track...",
      "icon_url": ""
    },
    "completed_at": "2025-10-19T14:23:45.123Z"
  }
  ```
- `data/test-outputs/{runId}/logs/pipeline.log` - Log file for stage detection

**shadcn/ui Components:**
- `Card` - Stage boxes and track containers
- `Badge` - Status indicators and company badge
- `Progress` - Progress bars for current stage
- `Separator` - Between stages
- `Skeleton` - Loading state for track cards
- `Button` - Back button and navigation

**Styling Guidelines:**
- Status Icons:
  - ⌛ Pending: Gray background, `text-gray-400`
  - ⏳ Running: Blue background, `text-blue-500`, animated spinner
  - ✓ Complete: Green background, `text-green-600`
- Active Stage: Border with `border-2 border-blue-500`, pulse animation
- Layout: Horizontal flex row, equal spacing, responsive stack on mobile

**API Response Format (`/api/status/[runId]`):**
```typescript
{
  run_id: string,
  status: "running" | "complete" | "error",
  current_stage: 0 | 1 | 2 | 3 | 4 | 5,
  stage1_data?: {
    selected_tracks: [1, 2],
    track_1: { title: string, summary: string, icon_url: string },
    track_2: { title: string, summary: string, icon_url: string },
    completed_at: string
  }
}
```

**Polling Implementation Pattern:**
```typescript
'use client'
import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

export default function PipelineViewer({ params }) {
  const router = useRouter()
  const [status, setStatus] = useState(null)
  const [error, setError] = useState(null)

  useEffect(() => {
    const startTime = Date.now()
    const MAX_RUNTIME = 35 * 60 * 1000 // 35 minutes

    const pollStatus = async () => {
      try {
        const response = await fetch(`/api/status/${params.runId}`)
        const data = await response.json()
        setStatus(data)

        // Frontend timeout check
        const elapsed = Date.now() - startTime
        if (elapsed > MAX_RUNTIME && data.status === 'running') {
          setError('Pipeline timeout - exceeded 35 minutes')
          return
        }

        // Backend error check
        if (data.status === 'error') {
          setError(data.error || 'Pipeline failed')
          return
        }

        // Redirect on completion
        if (data.current_stage === 5 && data.status === 'complete') {
          router.push(`/results/${params.runId}`)
          return
        }

        // Continue polling if not complete
        if (data.status !== 'complete') {
          setTimeout(pollStatus, 5000)
        }
      } catch (e) {
        setError('Failed to fetch pipeline status')
      }
    }

    pollStatus()

    return () => {
      // Cleanup on unmount (clear any pending timeouts)
    }
  }, [params.runId, router])

  // Render UI based on status...
}
```

**Stage Descriptions:**
- Stage 1: "Track Division - Selected 2 inspiration tracks"
- Stage 2: "Signal Amplification - Extracting broader trends"
- Stage 3: "Universal Translation - Converting to brand-agnostic lessons"
- Stage 4: "Brand Contextualization - Applying to [Brand Name]"
- Stage 5: "Opportunity Generation - Creating 5 actionable innovations"

**Reference Design:**
- `docs/image/track-division.png` - Stage 1 track UI layout
- PRD Section 4.3: Pipeline Viewer specifications
- Architecture Section 5.4: Horizontal Flow Layout

**Important Notes from Previous Stories:**
- Company context stored in HTTP-only cookie (set in Epic 1)
- Brand name accessed via `/api/onboarding/current-company` endpoint
- Pipeline runs in background (non-blocking execution)
- All file paths use `data/test-outputs/{runId}/` structure

### Testing

**Test File Location:**
- Manual testing only for hackathon scope
- Future: `app/pipeline/[runId]/page.test.tsx` for component tests

**Test Standards:**
- Verify polling starts on component mount
- Verify polling stops on component unmount
- Verify status updates every 5 seconds
- Verify timeout protection triggers at 35 minutes
- Verify redirect occurs when Stage 5 completes
- Verify error messages display for failures
- Verify Stage 1 tracks render correctly from JSON data
- Verify all 5 stage boxes render with correct names/numbers
- Verify responsive layout on mobile viewport (375px width)

**Testing Frameworks and Patterns:**
- Manual testing with browser DevTools
- Network tab monitoring for polling requests
- Console log monitoring (no errors allowed)
- Test data: Use `savannah-bananas.pdf` with Lactalis brand

**Specific Testing Requirements:**
1. **Polling Test:**
   - Open Network tab, watch for `/api/status/[runId]` requests every 5 seconds
   - Verify no duplicate requests (polling cleanup works)

2. **Stage Transition Test:**
   - Manually watch pipeline execute through all 5 stages
   - Verify stage icons update correctly (⌛ → ⏳ → ✓)
   - Verify animations play on stage completion

3. **Track Display Test:**
   - Verify 2 tracks display side-by-side
   - Verify track titles and content load from `inspirations.json`
   - Verify "Selected ✓" indicator appears

4. **Timeout Test:**
   - Mock a stuck pipeline (kill process after Stage 2)
   - Wait 35 minutes, verify timeout error displays

5. **Error Handling Test:**
   - Delete log file mid-execution
   - Verify error state displays with user-friendly message

6. **Redirect Test:**
   - Let pipeline complete fully
   - Verify automatic redirect to `/results/[runId]`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA Agent after story completion_
