# Story 8.0: Backend API Endpoints Prerequisites

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P0 (BLOCKER - Must complete before frontend stories)
**Estimated Time:** 2-3 hours

---

## Status

**Draft**

---

## Story

**As a** frontend developer implementing the new pipeline visualization states,
**I need** all required API endpoints and data structures to be in place,
**so that** the frontend can properly fetch, display, and download pipeline data without backend blockers.

---

## Acceptance Criteria

### 1. Stage 1 Output Enhanced with Mechanism Details
- Modify Python pipeline Stage 1 to include detailed mechanism extraction
- Output JSON structure must include:
  - `extractedText`: Full text extracted from PDF
  - `coreMechanism`: Main transferable pattern (string)
  - `businessImpact`: ROI/value proposition (string)
  - `patternTransfersTo`: Array of applicable industries (string[])
  - `trendImage`: URL or base64 of extracted trend image
  - `trendTitle`: Title of the trend being analyzed
- All fields populated from LLM analysis during Stage 1
- Test with real pipeline execution

### 2. Download Stage 1 Report Endpoint Created
- Create endpoint: `GET /api/pipeline/[runId]/download/stage1`
- Returns PDF report of Stage 1 extraction results
- PDF includes:
  - Extracted text summary
  - Core mechanism analysis
  - Business impact assessment
  - Pattern transfer opportunities
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename="stage1-report-[runId].pdf"`
- Error handling: 404 if runId not found, 500 if PDF generation fails

### 3. Download All Opportunities Endpoint Created
- Create endpoint: `GET /api/pipeline/[runId]/download/all`
- Generates ZIP file containing all opportunity PDFs
- Each PDF named: `opportunity-[number]-[truncated-title].pdf`
- ZIP file structure:
  ```
  opportunities-[runId].zip
  ├── opportunity-1-innovative-packaging.pdf
  ├── opportunity-2-sustainability-focus.pdf
  └── opportunity-3-personalization-trend.pdf
  ```
- Content-Type: `application/zip`
- Content-Disposition: `attachment; filename="opportunities-[runId].zip"`
- Handle case where no opportunities exist (return empty ZIP or 404)

### 4. Status Endpoint Returns Opportunity Preview Data
- Enhance `GET /api/pipeline/[runId]/status` response
- During Stage 5 processing, include partial opportunities:
  ```typescript
  {
    currentStage: 5,
    status: "PROCESSING",
    stages: [...],
    partialOpportunities: [
      {
        id: "temp-1",
        title: "First opportunity title",
        summary: "Brief summary...",
        heroImageUrl: null, // May be null during generation
        isComplete: false
      }
    ]
  }
  ```
- Allows State 2 to show spark previews during generation
- Mark opportunities as `isComplete: true` when fully generated

### 5. Pipeline Completion Webhook Enhanced
- Ensure `/api/pipeline/[runId]/complete` webhook includes:
  - All opportunity cards with full markdown content
  - Hero image URLs (if generated)
  - Proper numbering (1-based indexing)
  - Ensure markdown field is named `fullContent` (not just `content`)
- Verify webhook fires AFTER all opportunities saved to database
- Add retry logic if webhook fails (3 attempts with exponential backoff)

### 6. Stage Update Webhook Includes Stage Output
- Modify `/api/pipeline/[runId]/stage-update` webhook
- Include stage output data in webhook payload:
  ```json
  {
    "runId": "abc123",
    "stageNumber": 1,
    "stageName": "Document Analysis",
    "status": "COMPLETED",
    "output": {
      // Stage-specific output data
    }
  }
  ```
- Frontend can immediately display stage results without extra polling
- Reduce unnecessary API calls

### 7. Error State Payloads Standardized
- When pipeline fails, include error details:
  ```json
  {
    "runId": "abc123",
    "status": "FAILED",
    "error": {
      "stage": 3,
      "code": "LLM_RATE_LIMIT",
      "message": "Rate limit exceeded for OpenRouter API",
      "timestamp": "2025-10-25T10:30:00Z",
      "canRetry": true
    }
  }
  ```
- Error codes: `PDF_PARSE_ERROR`, `LLM_RATE_LIMIT`, `LLM_ERROR`, `WEBHOOK_FAILURE`, `UNKNOWN`
- Frontend can show appropriate error messages per failure type

---

## Tasks / Subtasks

- [ ] Enhance Stage 1 Python pipeline output (AC: #1)
  - [ ] Open `backend/pipeline/stages/stage1_document_analysis.py`
  - [ ] Modify LLM prompt to extract:
    - Core mechanism
    - Business impact
    - Pattern transfers to industries
  - [ ] Update output JSON structure
  - [ ] Extract trend image from PDF (if present)
  - [ ] Store trend title from analysis
  - [ ] Test with sample innovation PDF
  - [ ] Verify all fields populated correctly

- [ ] Create Stage 1 download endpoint (AC: #2)
  - [ ] Create `innovation-web/app/api/pipeline/[runId]/download/stage1/route.ts`
  - [ ] Fetch Stage 1 data from database/cache
  - [ ] Generate PDF using library (e.g., `@react-pdf/renderer` or `pdfkit`)
  - [ ] Include all mechanism details in PDF
  - [ ] Format PDF with BOI branding
  - [ ] Return PDF with proper headers
  - [ ] Test download in browser
  - [ ] Handle missing runId (404)

- [ ] Create download all opportunities endpoint (AC: #3)
  - [ ] Create `innovation-web/app/api/pipeline/[runId]/download/all/route.ts`
  - [ ] Fetch all opportunities from Prisma database
  - [ ] Generate individual PDFs for each opportunity
  - [ ] Create ZIP file using `archiver` or similar library
  - [ ] Add all PDFs to ZIP with numbered filenames
  - [ ] Stream ZIP response with proper headers
  - [ ] Test with 0, 1, 5, 10 opportunities
  - [ ] Verify ZIP extracts correctly

- [ ] Enhance status endpoint with partial opportunities (AC: #4)
  - [ ] Open `innovation-web/app/api/pipeline/[runId]/status/route.ts`
  - [ ] During Stage 5, query partial opportunity data
  - [ ] Add `partialOpportunities` array to response
  - [ ] Mark opportunities with `isComplete` flag
  - [ ] Test real-time updates during Stage 5
  - [ ] Verify State 2 can display previews

- [ ] Enhance pipeline completion webhook (AC: #5)
  - [ ] Open `backend/pipeline/webhook_handler.py`
  - [ ] Ensure all opportunity fields included:
    - `id`, `title`, `summary`, `fullContent` (markdown)
    - `heroImageUrl` (if available)
    - `number` (1-based index)
  - [ ] Add retry logic with exponential backoff
  - [ ] Log webhook attempts and failures
  - [ ] Verify webhook fires after DB saves
  - [ ] Test with real pipeline completion

- [ ] Include stage output in stage-update webhook (AC: #6)
  - [ ] Open `backend/pipeline/webhook_handler.py`
  - [ ] Modify stage-update payload structure
  - [ ] Include full stage output in webhook
  - [ ] Test each stage webhook (1-5)
  - [ ] Verify frontend receives output immediately
  - [ ] Remove need for extra polling calls

- [ ] Standardize error payloads (AC: #7)
  - [ ] Create error code enum/constants
  - [ ] Modify all error handlers to use standard format
  - [ ] Include stage number where error occurred
  - [ ] Add `canRetry` flag based on error type
  - [ ] Test each error scenario:
    - PDF parse failure
    - LLM rate limit
    - LLM API error
    - Webhook delivery failure
  - [ ] Document error codes in README

- [ ] Integration testing (AC: #1-7)
  - [ ] Run full pipeline with new Stage 1 output
  - [ ] Test download stage 1 report
  - [ ] Test download all opportunities (ZIP)
  - [ ] Verify partial opportunities during Stage 5
  - [ ] Test pipeline completion webhook
  - [ ] Simulate and test each error scenario
  - [ ] Verify Railway deployment works
  - [ ] Test with frontend State Machine (once built)

---

## Dev Notes

### Integration Points

**Backend Services:**
- `backend/pipeline/stages/stage1_document_analysis.py` - Enhance output
- `backend/pipeline/webhook_handler.py` - Enhance webhooks
- `backend/main.py` - May need new endpoints if using FastAPI

**Frontend API Routes:**
- `innovation-web/app/api/pipeline/[runId]/status/route.ts` - Enhance response
- `innovation-web/app/api/pipeline/[runId]/download/stage1/route.ts` - NEW
- `innovation-web/app/api/pipeline/[runId]/download/all/route.ts` - NEW

**Database:**
- May need to update Prisma schema if storing new Stage 1 fields
- Ensure `OpportunityCard` model has all required fields

### Technical Details

**Enhanced Stage 1 Output Structure:**
```python
# backend/pipeline/stages/stage1_document_analysis.py
stage1_output = {
    "extractedText": full_text,
    "coreMechanism": "User personalization through AI-driven recommendations",
    "businessImpact": "35% increase in customer engagement, 20% reduction in churn",
    "patternTransfersTo": [
        "Retail",
        "Healthcare",
        "Financial Services",
        "Entertainment"
    ],
    "trendImage": "data:image/png;base64,..." or "https://...",
    "trendTitle": "Hyper-Personalization in Consumer Products",
    "analysis": {
        # Existing analysis data
    }
}
```

**PDF Generation Library Options:**
1. **@react-pdf/renderer** (React-based, good for complex layouts)
2. **pdfkit** (Node.js, programmatic)
3. **puppeteer** (HTML to PDF, requires more resources)
4. **jsPDF** (Client-side option, simple)

**ZIP Generation:**
```typescript
// Using archiver library
import archiver from 'archiver'
import { Readable } from 'stream'

const archive = archiver('zip', { zlib: { level: 9 } })
opportunities.forEach((opp, index) => {
  const pdfBuffer = await generatePDF(opp)
  archive.append(pdfBuffer, {
    name: `opportunity-${index + 1}-${slugify(opp.title)}.pdf`
  })
})
archive.finalize()
```

**Error Code Constants:**
```typescript
// lib/pipeline-errors.ts
export enum PipelineErrorCode {
  PDF_PARSE_ERROR = 'PDF_PARSE_ERROR',
  LLM_RATE_LIMIT = 'LLM_RATE_LIMIT',
  LLM_ERROR = 'LLM_ERROR',
  WEBHOOK_FAILURE = 'WEBHOOK_FAILURE',
  UNKNOWN = 'UNKNOWN'
}

export const ErrorMessages: Record<PipelineErrorCode, string> = {
  [PipelineErrorCode.PDF_PARSE_ERROR]: 'Failed to parse the uploaded PDF',
  [PipelineErrorCode.LLM_RATE_LIMIT]: 'AI service rate limit reached, please try again later',
  [PipelineErrorCode.LLM_ERROR]: 'AI service encountered an error',
  [PipelineErrorCode.WEBHOOK_FAILURE]: 'Failed to update pipeline status',
  [PipelineErrorCode.UNKNOWN]: 'An unexpected error occurred'
}
```

**Webhook Retry Logic:**
```python
# backend/pipeline/webhook_handler.py
import time
import requests
from typing import Optional

def send_webhook_with_retry(url: str, payload: dict, max_attempts: int = 3) -> bool:
    """Send webhook with exponential backoff retry"""
    for attempt in range(max_attempts):
        try:
            response = requests.post(
                url,
                json=payload,
                timeout=30,
                headers={'X-Webhook-Secret': WEBHOOK_SECRET}
            )
            if response.status_code == 200:
                return True

            # Log non-200 responses
            print(f"Webhook attempt {attempt + 1} failed: {response.status_code}")

        except Exception as e:
            print(f"Webhook attempt {attempt + 1} error: {str(e)}")

        # Exponential backoff: 1s, 2s, 4s
        if attempt < max_attempts - 1:
            time.sleep(2 ** attempt)

    return False
```

### Files Referenced

- `backend/pipeline/stages/stage1_document_analysis.py` - Stage 1 logic
- `backend/pipeline/webhook_handler.py` - Webhook delivery
- `backend/main.py` - FastAPI routes
- `innovation-web/app/api/pipeline/[runId]/status/route.ts` - Status endpoint
- `innovation-web/prisma/schema.prisma` - Database schema

### API Endpoint Specifications

**GET /api/pipeline/[runId]/download/stage1**
- Response: PDF file
- Headers:
  - Content-Type: `application/pdf`
  - Content-Disposition: `attachment; filename="stage1-report-[runId].pdf"`
- Status Codes:
  - 200: Success, PDF returned
  - 404: Pipeline run not found
  - 500: PDF generation failed

**GET /api/pipeline/[runId]/download/all**
- Response: ZIP file containing all opportunity PDFs
- Headers:
  - Content-Type: `application/zip`
  - Content-Disposition: `attachment; filename="opportunities-[runId].zip"`
- Status Codes:
  - 200: Success, ZIP returned
  - 404: Pipeline run not found
  - 500: ZIP generation failed

### Testing

#### Test File Location
- `backend/tests/test_stage1_output.py`
- `backend/tests/test_webhook_retry.py`
- `innovation-web/__tests__/api/download-endpoints.test.ts`

#### Testing Standards
- All endpoints return correct content types
- Error cases handled gracefully
- Webhook retry logic works
- PDF/ZIP generation doesn't timeout
- Large opportunity sets handled (test with 20+ cards)

#### Specific Testing Requirements

1. **Stage 1 Output Test:**
   - Mock LLM response with mechanism extraction
   - Verify all required fields present
   - Test with PDF containing images
   - Test with PDF without images
   - Verify JSON structure matches spec

2. **Download Endpoints Test:**
   - Generate real PDF, verify readable
   - Generate ZIP with 0, 1, 10 opportunities
   - Verify filenames are sanitized
   - Test concurrent download requests
   - Verify memory cleanup after generation

3. **Webhook Retry Test:**
   - Mock webhook endpoint that fails twice
   - Verify 3 attempts made
   - Verify exponential backoff timing
   - Test successful retry on attempt 2
   - Test final failure after 3 attempts

4. **Error Payload Test:**
   - Trigger each error type
   - Verify error code present
   - Verify user-friendly message
   - Test `canRetry` flag logic
   - Verify timestamp included

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 backend prerequisites | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*