# Story 7.5: Delete Run with Cascade

## Status
Approved

## Story
**As a** product innovation manager,
**I want** to delete old or unwanted pipeline runs,
**so that** I can keep my run history clean and focused on relevant analyses.

## Acceptance Criteria

1. **Delete Button - Run Detail Page**
   - "Delete Run" button in page header (top-right, styled as destructive)
   - Click → Show confirmation modal with warning message
   - Modal text: "Delete this run? This will permanently remove the run and all {cardCount} opportunity cards. This action cannot be undone."
   - Cancel button → Close modal, no action
   - Confirm button → DELETE `/api/runs/[runId]`, redirect to `/runs` on success

2. **Delete Button - Run History Page**
   - Each run card has "Delete" action (icon or text button)
   - Click → Same confirmation modal as above
   - Confirm → DELETE `/api/runs/[runId]`, remove card from grid immediately (optimistic update)

3. **API Behavior**
   - Endpoint: `DELETE /api/runs/[runId]`
   - Verifies user owns run via Clerk auth
   - Uses Prisma `deleteMany` with user ID constraint
   - Returns 404 if run not found or user unauthorized
   - Returns 200 with `{ success: true }` on successful deletion

4. **Cascade Delete Behavior**
   - Deleting run automatically deletes:
     - All related `OpportunityCard` records
     - Related `InspirationReport` record
     - All related `StageOutput` records
   - Cascade defined in Prisma schema: `@relation(onDelete: Cascade)`
   - All deletes execute in single atomic transaction (ACID guarantee)

5. Deletion removes run from sidebar "My Runs" section immediately

6. If user deletes run while viewing it, redirect to `/runs` after success

7. Run history page updates count and grid after deletion

8. Existing runs remain unchanged (no side effects)

9. Confirmation modal prevents accidental deletions

10. Optimistic UI: Card disappears immediately, reverts if API fails

11. Error handling: If delete fails, show error toast and restore card

12. Loading state: Delete button shows spinner during API call

## Tasks / Subtasks

- [ ] Add delete button to run detail page (AC: 1)
  - [ ] Add "Delete Run" button to page header with destructive styling
  - [ ] Create confirmation modal component
  - [ ] Add modal text with dynamic card count
  - [ ] Implement confirm/cancel handlers
  - [ ] Add redirect to `/runs` on success

- [ ] Add delete button to run history cards (AC: 2)
  - [ ] Add "Delete" button to RunCard component
  - [ ] Reuse confirmation modal
  - [ ] Implement optimistic UI update

- [ ] Create delete API endpoint (AC: 3, 4)
  - [ ] Create `app/api/runs/[runId]/route.ts` with DELETE handler
  - [ ] Verify user ownership with Clerk
  - [ ] Use Prisma deleteMany with user constraint
  - [ ] Handle 404 for non-existent or unauthorized runs
  - [ ] Return success response

- [ ] Configure Prisma cascade relations (AC: 4)
  - [ ] Verify schema has @relation(onDelete: Cascade) for all relations
  - [ ] Test cascade deletes all related records
  - [ ] Ensure atomic transaction (ACID)

- [ ] Implement UI feedback (AC: 5, 6, 7, 9, 10, 11, 12)
  - [ ] Update sidebar to remove deleted run
  - [ ] Add redirect logic from detail page
  - [ ] Update history page count and grid
  - [ ] Implement optimistic UI with revert on error
  - [ ] Add loading spinner to delete button
  - [ ] Create error toast with restore option

- [ ] Write integration tests (DoD)
  - [ ] Test cascade delete removes all related records
  - [ ] Test user authorization enforcement
  - [ ] Test 404 handling
  - [ ] Test optimistic UI revert on error
  - [ ] Verify no orphaned records in database

## Dev Notes

**Existing System Integration:**
- Integrates with: Run detail page and run history page
- Technology: Prisma cascade delete, Next.js API routes, shadcn/ui Dialog
- Follows pattern: Delete confirmation modal pattern (common in admin interfaces)
- Touch points: `/api/runs/[runId]` DELETE endpoint, Prisma cascade relations

**API Implementation:** See PRD lines 1705-1729

**Prisma Delete Pattern:**
```typescript
const deleted = await prisma.run.deleteMany({
  where: {
    id: runId,
    user: { clerkId: userId }
  }
})

if (deleted.count === 0) {
  return NextResponse.json({ error: 'Run not found' }, { status: 404 })
}
```

**Cascade Relations (from Prisma Schema):**
```prisma
model Run {
  opportunityCards  OpportunityCard[]  @relation(onDelete: Cascade)
  inspirationReport InspirationReport? @relation(onDelete: Cascade)
  stageOutputs      StageOutput[]      @relation(onDelete: Cascade)
}
```

**shadcn/ui Components:**
- `AlertDialog` for delete confirmation
- `Button` variant="destructive" for delete action

**Component Location:**
- `innovation-web/src/app/api/runs/[runId]/route.ts` (new DELETE handler)
- Update `innovation-web/src/app/runs/[runId]/page.tsx`
- Update `innovation-web/src/components/RunCard.tsx`

### Testing

**Test File Location:**
- `innovation-web/src/app/api/runs/[runId]/__tests__/route.test.ts`

**Testing Standards:**
- Use Jest for API route testing
- Mock Prisma database operations
- Test cascade delete behavior
- Verify ACID transaction properties
- Test Clerk authentication

**Testing Framework:** Jest + Prisma mock

**Specific Testing Requirements:**
- Test delete endpoint removes run and all related records
- Test unauthorized user cannot delete
- Test 404 returned for non-existent run
- Test optimistic UI reverts on API failure
- Test confirmation modal prevents accidental deletion
- Verify no orphaned records after cascade delete
- Test redirect works from detail page
- Test history page updates after deletion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation from epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
