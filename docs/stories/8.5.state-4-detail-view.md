# Story 8.5: State 4 - Spark Detail View with Collapsed Sidebar

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P1
**Estimated Time:** 3-4 hours

---

## Status

**Draft**

---

## Story

**As a** CPG Innovation Manager reviewing a specific opportunity spark,
**I want** to see the full markdown content in a detail view with thumbnails sidebar for quick navigation,
**so that** I can deeply explore one opportunity while easily switching to view others.

---

## Acceptance Criteria

### 1. CollapsedSidebar Component Created
- File created: `innovation-web/components/pipeline/CollapsedSidebar.tsx`
- Width: 120px fixed
- Background: White with right border (1px gray)
- Thumbnails: 80×80px, stacked vertically with 8px gap
- Selected thumbnail: 3px teal border (#5B9A99)
- Scrollable if more than 4 sparks
- Each thumbnail shows: number badge + miniature hero image
- Click thumbnail switches to that spark (triggers re-render)

### 2. ExpandedSparkDetail Component Created
- File created: `innovation-web/components/pipeline/ExpandedSparkDetail.tsx`
- Width: Flex 1 (fills remaining space after sidebar)
- Back button: Top-left "← Back to Grid" returns to State 3
- Hero image: Full-width at top (16:9 aspect ratio)
- Content padding: 48px horizontal, 32px vertical
- Markdown rendering: Uses `react-markdown` with custom components
- Scrollable container: Full viewport height
- Sticky header: Back button stays visible while scrolling

### 3. Markdown Rendering with Custom Components
- Install `react-markdown` package
- Custom heading styles: h1-h6 with proper hierarchy
- Custom link component: Opens external links in new tab
- Custom code block: Syntax highlighting (optional, use `<pre>` fallback)
- Custom image component: Lazy loading with Next.js Image
- XSS protection: Sanitize HTML with `rehype-sanitize`
- Line breaks preserved: Use `remarkGfm` plugin

### 4. State 4 Integrated into PipelineStateMachine
- `PipelineStateMachine.tsx` renders State 4 when `status === "COMPLETED" && selectedCardId !== null`
- Layout: Flex row (sidebar + detail view)
- Smooth transition from State 3 → State 4 (600ms slide)
- Sidebar slides in from left
- Detail view slides in from right
- Left main sidebar (stage boxes) hidden in State 4
- Full-width layout for detail view

### 5. Navigation Between Sparks
- Clicking thumbnail in sidebar updates `selectedCardId`
- Detail view content updates with smooth transition (300ms fade)
- Scroll position resets to top on spark change
- Keyboard navigation: Arrow up/down cycles through sparks
- Auto-scroll sidebar to keep selected thumbnail visible

### 6. Back to Grid Functionality
- Back button sets `selectedCardId` to `null`
- Triggers State 4 → State 3 transition (400ms slide)
- Returns to grid view with all sparks visible
- Grid scroll position preserved (returns to where user left)
- Optional: Highlight previously viewed spark in grid

### 7. Responsive Behavior
- Desktop (>1024px): Sidebar 120px + detail flex-1
- Tablet (768-1024px): Sidebar 100px + detail flex-1
- Mobile (<768px): No sidebar, detail view full-width with top navigation
- Mobile navigation: Top bar with prev/next arrows + spark counter (e.g., "2 of 5")

---

## Tasks / Subtasks

- [ ] Create CollapsedSidebar component (AC: #1)
  - [ ] Create `innovation-web/components/pipeline/CollapsedSidebar.tsx`
  - [ ] Implement fixed-width container (120px)
  - [ ] Add white background with right border
  - [ ] Create thumbnail grid (vertical stack, 8px gap)
  - [ ] Create ThumbnailCard sub-component:
    - [ ] 80×80px container with rounded corners
    - [ ] Number badge overlay (top-left, white circle)
    - [ ] Hero image thumbnail (or gray placeholder)
    - [ ] Teal border when selected (3px)
    - [ ] Hover effect: subtle shadow
  - [ ] Map through sparks array
  - [ ] Add click handler to update selectedCardId
  - [ ] Implement scrollable container (overflow-y-auto)
  - [ ] Add TypeScript interface: `CollapsedSidebarProps`

- [ ] Create ExpandedSparkDetail component (AC: #2, #3)
  - [ ] Create `innovation-web/components/pipeline/ExpandedSparkDetail.tsx`
  - [ ] Install `react-markdown`: `npm install react-markdown rehype-sanitize remark-gfm`
  - [ ] Import react-markdown and plugins
  - [ ] Implement back button with arrow icon
  - [ ] Add sticky header with back button
  - [ ] Display full-width hero image (16:9 aspect ratio)
  - [ ] Create scrollable content container
  - [ ] Render markdown content with react-markdown
  - [ ] Configure custom components:
    - [ ] Custom heading renderer (h1-h6)
    - [ ] Custom link renderer (external links → new tab)
    - [ ] Custom image renderer (Next.js Image)
    - [ ] Custom code block renderer
  - [ ] Add XSS protection with rehype-sanitize
  - [ ] Add GFM support with remark-gfm
  - [ ] Add TypeScript interface: `ExpandedSparkDetailProps`
  - [ ] Style with proper typography and spacing

- [ ] Implement keyboard navigation (AC: #5)
  - [ ] Add keyboard event listener (useEffect)
  - [ ] ArrowUp: Navigate to previous spark
  - [ ] ArrowDown: Navigate to next spark
  - [ ] Update selectedCardId on arrow key press
  - [ ] Prevent navigation if at first/last spark
  - [ ] Clean up event listener on unmount
  - [ ] Test keyboard navigation flow

- [ ] Implement sidebar auto-scroll (AC: #5)
  - [ ] Create ref for selected thumbnail element
  - [ ] Use `scrollIntoView` when selectedCardId changes
  - [ ] Smooth scroll behavior
  - [ ] Center selected thumbnail in viewport
  - [ ] Test with long list of sparks (>10)

- [ ] Integrate State 4 into PipelineStateMachine (AC: #4)
  - [ ] Open `innovation-web/components/pipeline/PipelineStateMachine.tsx`
  - [ ] Import CollapsedSidebar and ExpandedSparkDetail
  - [ ] Add conditional render: `status === "COMPLETED" && selectedCardId !== null`
  - [ ] Create flex row layout: `flex flex-row`
  - [ ] Render CollapsedSidebar (left side)
  - [ ] Render ExpandedSparkDetail (right side, flex-1)
  - [ ] Pass selected spark data to ExpandedSparkDetail
  - [ ] Pass all sparks to CollapsedSidebar
  - [ ] Wire up selectedCardId state management
  - [ ] Hide main left sidebar (stage boxes) in State 4

- [ ] Implement State 3 → State 4 transition (AC: #4)
  - [ ] Add transition classes: `duration-600 ease-in-out`
  - [ ] State 3 slides out to left: `translate-x-[-100%]`
  - [ ] State 4 slides in from right: `translate-x-0`
  - [ ] Sidebar slides in from left
  - [ ] Detail view slides in from right
  - [ ] Test transition smoothness
  - [ ] Verify no layout flicker

- [ ] Implement State 4 → State 3 back navigation (AC: #6)
  - [ ] Create back button click handler
  - [ ] Set selectedCardId to null
  - [ ] Trigger State 4 → State 3 transition (400ms)
  - [ ] State 4 slides out to right
  - [ ] State 3 slides in from left
  - [ ] Optional: Preserve grid scroll position
  - [ ] Optional: Highlight previously viewed spark

- [ ] Implement mobile responsive navigation (AC: #7)
  - [ ] Hide CollapsedSidebar on mobile (<768px)
  - [ ] Create mobile top navigation bar
  - [ ] Add prev/next arrow buttons
  - [ ] Add spark counter: "2 of 5"
  - [ ] Wire up prev/next navigation
  - [ ] Test on mobile devices/emulators

- [ ] Test spark switching (AC: #5)
  - [ ] Click thumbnail in sidebar → verify detail view updates
  - [ ] Verify smooth content transition (300ms fade)
  - [ ] Verify scroll position resets to top
  - [ ] Press ArrowDown → verify next spark displays
  - [ ] Press ArrowUp → verify previous spark displays
  - [ ] Test sidebar auto-scroll to selected thumbnail

- [ ] Test markdown rendering (AC: #3)
  - [ ] Render spark with headings (h1-h6) → verify styled correctly
  - [ ] Render spark with links → verify open in new tab
  - [ ] Render spark with images → verify lazy loading
  - [ ] Render spark with code blocks → verify proper formatting
  - [ ] Render spark with malicious HTML → verify sanitized
  - [ ] Test GFM features (tables, strikethrough)

- [ ] Test back navigation (AC: #6)
  - [ ] Click "Back to Grid" button → verify returns to State 3
  - [ ] Verify State 4 → State 3 transition (400ms slide)
  - [ ] Optional: Verify grid scroll position preserved
  - [ ] Optional: Verify previously viewed spark highlighted

- [ ] Visual QA against mockup (AC: #1, #2)
  - [ ] Compare with `docs/image/MyBOI Mockup v2_compressed.pdf` (if State 4 shown)
  - [ ] Verify sidebar thumbnail styling matches design
  - [ ] Verify detail view layout matches design
  - [ ] Verify typography and spacing match
  - [ ] Get design approval from UX expert

---

## Dev Notes

### Integration Points

**Parent Component:**
- `innovation-web/components/pipeline/PipelineStateMachine.tsx`
- State 4 renders when: `status === "COMPLETED" && selectedCardId !== null`
- Triggered by clicking spark card in State 3

**Data Source:**
- Selected spark from `opportunities` array
- Find by `id`: `opportunities.find(o => o.id === selectedCardId)`
- Markdown content in `spark.fullContent` field

**Main Sidebar Behavior:**
- Hide stage boxes sidebar when State 4 active
- Show CollapsedSidebar instead
- Full-width layout for detail view

**Design Reference:**
- Mockup: `docs/image/MyBOI Mockup v2_compressed.pdf` (State 4 may not be shown)
- Specification: `docs/front-end-spec.md` - Lines 816-902
- Color palette: Teal #5B9A99, Gray #F9FAFB, White #FFFFFF

### Technical Details

**Component File Structure:**
```
innovation-web/
├── components/pipeline/
│   ├── CollapsedSidebar.tsx (NEW)
│   ├── ExpandedSparkDetail.tsx (NEW)
│   └── PipelineStateMachine.tsx (MODIFY)
└── package.json (ADD react-markdown dependencies)
```

**TypeScript Interfaces:**
```typescript
// CollapsedSidebar.tsx
interface CollapsedSidebarProps {
  sparks: Spark[]
  selectedId: string
  onSelectSpark: (id: string) => void
}

// ExpandedSparkDetail.tsx
interface ExpandedSparkDetailProps {
  spark: Spark
  onBack: () => void
}

interface Spark {
  id: string
  title: string
  summary: string
  heroImageUrl?: string
  fullContent: string // Markdown
}
```

**CollapsedSidebar Implementation:**
```tsx
// CollapsedSidebar.tsx
import { useRef, useEffect } from 'react'

const CollapsedSidebar: React.FC<CollapsedSidebarProps> = ({
  sparks,
  selectedId,
  onSelectSpark,
}) => {
  const selectedRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    // Auto-scroll to selected thumbnail
    selectedRef.current?.scrollIntoView({
      behavior: 'smooth',
      block: 'center',
    })
  }, [selectedId])

  return (
    <div className="w-30 bg-white border-r border-gray-200 overflow-y-auto">
      <div className="flex flex-col gap-2 p-2">
        {sparks.map((spark, index) => (
          <div
            key={spark.id}
            ref={spark.id === selectedId ? selectedRef : null}
            onClick={() => onSelectSpark(spark.id)}
            className={`
              relative w-20 h-20 rounded-lg overflow-hidden cursor-pointer
              transition-all duration-200
              hover:shadow-md
              ${spark.id === selectedId ? 'ring-3 ring-[#5B9A99]' : 'ring-1 ring-gray-200'}
            `}
          >
            {spark.heroImageUrl ? (
              <Image src={spark.heroImageUrl} alt={spark.title} fill className="object-cover" />
            ) : (
              <div className="w-full h-full bg-gray-200" />
            )}
            <div className="absolute top-1 left-1 w-6 h-6 bg-white rounded-full flex items-center justify-center text-xs font-bold">
              {index + 1}
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

**ExpandedSparkDetail Implementation:**
```tsx
// ExpandedSparkDetail.tsx
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'
import rehypeSanitize from 'rehype-sanitize'
import Image from 'next/image'

const ExpandedSparkDetail: React.FC<ExpandedSparkDetailProps> = ({ spark, onBack }) => {
  return (
    <div className="flex-1 overflow-y-auto">
      {/* Sticky Header with Back Button */}
      <div className="sticky top-0 z-10 bg-white border-b border-gray-200 px-12 py-4">
        <button
          onClick={onBack}
          className="flex items-center gap-2 text-[#5B9A99] hover:text-[#4A7F7E] transition-colors"
        >
          <ArrowLeftIcon className="w-5 h-5" />
          <span className="font-medium">Back to Grid</span>
        </button>
      </div>

      {/* Content */}
      <div className="px-12 py-8 max-w-4xl mx-auto">
        {/* Hero Image */}
        {spark.heroImageUrl && (
          <div className="relative aspect-video mb-8 rounded-lg overflow-hidden">
            <Image src={spark.heroImageUrl} alt={spark.title} fill className="object-cover" />
          </div>
        )}

        {/* Markdown Content */}
        <ReactMarkdown
          remarkPlugins={[remarkGfm]}
          rehypePlugins={[rehypeSanitize]}
          components={{
            h1: ({ node, ...props }) => <h1 className="text-4xl font-bold mb-4" {...props} />,
            h2: ({ node, ...props }) => <h2 className="text-3xl font-semibold mb-3 mt-8" {...props} />,
            h3: ({ node, ...props }) => <h3 className="text-2xl font-semibold mb-2 mt-6" {...props} />,
            p: ({ node, ...props }) => <p className="mb-4 leading-7" {...props} />,
            a: ({ node, ...props }) => (
              <a className="text-[#5B9A99] underline hover:text-[#4A7F7E]" target="_blank" rel="noopener noreferrer" {...props} />
            ),
            img: ({ node, ...props }) => (
              <Image
                src={props.src || ''}
                alt={props.alt || ''}
                width={800}
                height={600}
                className="rounded-lg my-4"
              />
            ),
            code: ({ node, inline, ...props }) =>
              inline ? (
                <code className="bg-gray-100 px-1.5 py-0.5 rounded text-sm" {...props} />
              ) : (
                <pre className="bg-gray-100 p-4 rounded-lg overflow-x-auto mb-4">
                  <code {...props} />
                </pre>
              ),
          }}
        >
          {spark.fullContent}
        </ReactMarkdown>
      </div>
    </div>
  )
}
```

**Keyboard Navigation:**
```tsx
// PipelineStateMachine.tsx - Add keyboard navigation
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (!selectedCardId || opportunities.length === 0) return

    const currentIndex = opportunities.findIndex(o => o.id === selectedCardId)

    if (e.key === 'ArrowDown' && currentIndex < opportunities.length - 1) {
      setSelectedCardId(opportunities[currentIndex + 1].id)
    } else if (e.key === 'ArrowUp' && currentIndex > 0) {
      setSelectedCardId(opportunities[currentIndex - 1].id)
    }
  }

  window.addEventListener('keydown', handleKeyDown)
  return () => window.removeEventListener('keydown', handleKeyDown)
}, [selectedCardId, opportunities])
```

**Mobile Top Navigation Bar:**
```tsx
// ExpandedSparkDetail.tsx - Mobile variant
const MobileNavBar: React.FC<{
  currentIndex: number
  total: number
  onPrev: () => void
  onNext: () => void
  onBack: () => void
}> = ({ currentIndex, total, onPrev, onNext, onBack }) => (
  <div className="md:hidden sticky top-0 z-10 bg-white border-b border-gray-200 px-4 py-3">
    <div className="flex items-center justify-between">
      <button onClick={onBack} className="text-[#5B9A99]">
        <ArrowLeftIcon className="w-6 h-6" />
      </button>
      <div className="flex items-center gap-4">
        <button onClick={onPrev} disabled={currentIndex === 0} className="disabled:opacity-30">
          <ChevronUpIcon className="w-6 h-6" />
        </button>
        <span className="text-sm font-medium">{currentIndex + 1} of {total}</span>
        <button onClick={onNext} disabled={currentIndex === total - 1} className="disabled:opacity-30">
          <ChevronDownIcon className="w-6 h-6" />
        </button>
      </div>
    </div>
  </div>
)
```

**State 3 → State 4 Transition:**
```tsx
// PipelineStateMachine.tsx
{/* State 3 - Slide out */}
<div className={`
  transition-all duration-600 ease-in-out
  ${selectedCardId ? 'opacity-0 -translate-x-full pointer-events-none absolute' : 'opacity-100 translate-x-0'}
`}>
  <IconNavigation activeSection="sparks" />
  <SparksGrid sparks={opportunities} onCardClick={handleCardClick} />
  <ActionBar {...actionBarProps} />
</div>

{/* State 4 - Slide in */}
<div className={`
  flex flex-row h-full
  transition-all duration-600 ease-in-out
  ${selectedCardId ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-full'}
`}>
  <CollapsedSidebar
    sparks={opportunities}
    selectedId={selectedCardId!}
    onSelectSpark={setSelectedCardId}
  />
  <ExpandedSparkDetail
    spark={opportunities.find(o => o.id === selectedCardId)!}
    onBack={() => setSelectedCardId(null)}
  />
</div>
```

### Files Referenced

- `docs/front-end-spec.md` - Lines 816-902 (State 4 component specs)
- `docs/image/MyBOI Mockup v2_compressed.pdf` (State 4 may not be shown)
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Parent component
- `package.json` - Add react-markdown dependencies

### Package Dependencies

**Install Commands:**
```bash
cd innovation-web
npm install react-markdown remark-gfm rehype-sanitize
```

**Package Versions:**
- `react-markdown`: ^9.0.0
- `remark-gfm`: ^4.0.0
- `rehype-sanitize`: ^6.0.0

### Design Specifications

**CollapsedSidebar:**
- Width: 120px fixed
- Background: White
- Border-right: 1px gray (#E5E7EB)
- Thumbnail size: 80×80px
- Thumbnail gap: 8px
- Number badge: 24px circle, white background
- Selected border: 3px teal (#5B9A99)
- Hover shadow: Elevation 2

**ExpandedSparkDetail:**
- Width: Flex-1 (remaining space)
- Padding: 48px horizontal, 32px vertical
- Max-width: 1024px (content area)
- Back button: Sticky top, 16px padding
- Hero image: Full-width, 16:9 aspect ratio
- Content margin: 32px top

**Typography (Markdown):**
- h1: 2.25rem (36px), font-bold, margin-bottom 1rem
- h2: 1.875rem (30px), font-semibold, margin-bottom 0.75rem, margin-top 2rem
- h3: 1.5rem (24px), font-semibold, margin-bottom 0.5rem, margin-top 1.5rem
- p: 1rem (16px), margin-bottom 1rem, line-height 1.75
- a: Teal color, underlined, opens in new tab
- code (inline): Gray background, 0.875rem (14px)
- code (block): Gray background, 1rem (16px), rounded, padding 1rem

**Mobile Navigation:**
- Top bar height: 56px
- Background: White
- Border-bottom: 1px gray
- Arrow buttons: 24×24px
- Counter text: 14px medium

### Testing

#### Test File Location
- `innovation-web/__tests__/pipeline/CollapsedSidebar.test.tsx`
- `innovation-web/__tests__/pipeline/ExpandedSparkDetail.test.tsx`
- `innovation-web/__tests__/pipeline/state-4-integration.test.tsx`
- `innovation-web/__tests__/pipeline/keyboard-navigation.test.tsx`

#### Testing Standards
- All components render without errors
- Markdown renders safely (XSS protected)
- Navigation works correctly
- Keyboard controls function
- No console warnings or errors

#### Testing Framework
- Jest + React Testing Library
- Playwright for state transition testing

#### Specific Testing Requirements

1. **CollapsedSidebar Test:**
   - Render with 5 sparks → verify 5 thumbnails shown
   - Render with selectedId="2" → verify 2nd thumbnail has teal border
   - Click thumbnail → verify onSelectSpark called with correct id
   - Test auto-scroll: select last spark → verify scrolled into view
   - Verify number badges (1, 2, 3...) display correctly

2. **ExpandedSparkDetail Test:**
   - Render with spark data → verify hero image displays
   - Render markdown content → verify headings styled correctly
   - Render markdown with link → verify opens in new tab
   - Render markdown with image → verify Next.js Image used
   - Render markdown with code → verify syntax highlighting
   - Click back button → verify onBack called
   - Test XSS: render malicious HTML → verify sanitized

3. **Keyboard Navigation Test:**
   - Focus State 4, press ArrowDown → verify next spark displays
   - Focus State 4, press ArrowUp → verify previous spark displays
   - Press ArrowDown at last spark → verify no change
   - Press ArrowUp at first spark → verify no change
   - Verify keyboard listeners clean up on unmount

4. **State 4 Integration Test:**
   - Set selectedCardId="1" → verify State 4 renders
   - Verify CollapsedSidebar renders with all thumbnails
   - Verify ExpandedSparkDetail renders selected spark
   - Verify main sidebar (stage boxes) hidden
   - Click thumbnail in sidebar → verify detail view updates smoothly
   - Click back button → verify returns to State 3

5. **State 3 → State 4 Transition Test:**
   - Click spark card in State 3
   - Verify State 3 slides out to left (600ms)
   - Verify State 4 slides in from right (600ms)
   - Verify no layout flicker
   - Test on Chrome, Safari, Firefox

6. **State 4 → State 3 Transition Test:**
   - Click "Back to Grid" button
   - Verify State 4 slides out to right (400ms)
   - Verify State 3 slides in from left (400ms)
   - Optional: Verify grid scroll position preserved
   - Optional: Verify previously viewed spark highlighted

7. **Mobile Responsive Test:**
   - Render at 320px width → verify sidebar hidden
   - Verify mobile top navigation bar shows
   - Verify prev/next arrows functional
   - Verify spark counter displays correctly (e.g., "2 of 5")
   - Test prev/next navigation flow
   - Test on iOS Safari, Android Chrome

8. **Markdown Rendering Security Test:**
   - Render with `<script>alert('XSS')</script>` → verify script stripped
   - Render with `<img src=x onerror=alert('XSS')>` → verify sanitized
   - Render with iframe → verify removed
   - Render with `javascript:` links → verify sanitized
   - Verify only safe markdown elements render

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 State 4 | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
