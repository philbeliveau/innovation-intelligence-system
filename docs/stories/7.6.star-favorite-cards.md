# Story 7.6: Star/Favorite Opportunity Cards

## Status
Draft

## Story
**As a** product innovation manager,
**I want** to star/bookmark specific opportunity cards that I find most promising,
**so that** I can quickly identify and revisit my favorite innovation concepts across multiple runs.

## Acceptance Criteria

1. **Star Button on Cards**
   - Star icon button appears in top-right corner of every opportunity card
   - Unstarred state: Outline star icon (☆) with gray color
   - Starred state: Filled star icon (⭐) with yellow color
   - Click → Toggle starred state via POST `/api/cards/[cardId]/star`

2. **Star Locations**
   - Results page: All 5 opportunity cards display star button
   - Run detail page (Opportunity Cards tab): All cards display star button
   - Card modal/expansion: Star button visible in modal header

3. **API Behavior**
   - Endpoint: `POST /api/cards/[cardId]/star`
   - Verifies user owns card via Clerk auth
   - Toggles `starred` boolean field: `true → false` or `false → true`
   - Returns new state: `{ starred: true }` or `{ starred: false }`
   - Returns 404 if card not found or user unauthorized

4. **Persistence**
   - Starred state persists across sessions (stored in database)
   - User sees same starred cards when returning to run detail page
   - Starred cards remain starred even after logout/login

5. Existing card rendering logic continues to work unchanged

6. Star state updates immediately without full page refresh

7. Multiple stars can be toggled in quick succession without conflicts

8. Star state visible on both results page and run detail page

9. Optimistic UI: Icon updates immediately on click (before API response)

10. Error handling: Reverts to previous state if API call fails

11. Loading state: Subtle animation during API call (optional)

12. Accessibility: Star button has aria-label "Toggle favorite" for screen readers

## Tasks / Subtasks

- [ ] Add star button to opportunity cards (AC: 1, 2)
  - [ ] Add star icon button to OpportunityCard component
  - [ ] Style filled vs outline star icons with colors
  - [ ] Position button in top-right corner
  - [ ] Add star button to results page cards
  - [ ] Add star button to run detail page cards
  - [ ] Add star button to card modal header

- [ ] Create star toggle API endpoint (AC: 3)
  - [ ] Create `app/api/cards/[cardId]/star/route.ts`
  - [ ] Fetch card and verify user ownership
  - [ ] Toggle starred boolean field
  - [ ] Return new state in response
  - [ ] Handle 404 for unauthorized access

- [ ] Implement star toggle functionality (AC: 5, 6, 7, 9, 10)
  - [ ] Create onClick handler for star button
  - [ ] Implement optimistic UI update
  - [ ] Call POST `/api/cards/[cardId]/star`
  - [ ] Sync with server response
  - [ ] Add error handling with state revert
  - [ ] Show error toast on failure

- [ ] Ensure persistence (AC: 4, 8)
  - [ ] Verify starred field stored in database
  - [ ] Test state persists across page refreshes
  - [ ] Test state persists across sessions
  - [ ] Verify state visible on all card locations

- [ ] Add accessibility and polish (AC: 11, 12)
  - [ ] Add aria-label to star button
  - [ ] Add optional loading animation
  - [ ] Match brutalist aesthetic

- [ ] Write unit and integration tests (DoD)
  - [ ] Test star toggle updates database
  - [ ] Test optimistic UI behavior
  - [ ] Test error handling and revert
  - [ ] Test persistence across sessions
  - [ ] Test accessibility with screen readers

## Dev Notes

**Existing System Integration:**
- Integrates with: Opportunity card rendering components, run detail page
- Technology: Prisma update operation, Next.js API routes, React state management
- Follows pattern: Toggle button with optimistic UI updates
- Touch points: `/api/cards/[cardId]/star` endpoint, OpportunityCard component

**API Implementation:** See PRD lines 1730-1798 and architecture doc lines 546-599

**Prisma Update Pattern:**
```typescript
// Fetch card to verify ownership
const card = await prisma.opportunityCard.findFirst({
  where: {
    id: cardId,
    user: { clerkId: userId }
  }
})

// Toggle starred field
const updatedCard = await prisma.opportunityCard.update({
  where: { id: cardId },
  data: { starred: !card.starred }
})

return NextResponse.json({ starred: updatedCard.starred })
```

**React State Management:**
```typescript
const [starred, setStarred] = useState(card.starred)

const handleStarClick = async () => {
  // Optimistic update
  setStarred(!starred)

  try {
    const res = await fetch(`/api/cards/${cardId}/star`, { method: 'POST' })
    const data = await res.json()
    setStarred(data.starred) // Sync with server response
  } catch (error) {
    // Revert on error
    setStarred(starred)
    toast.error('Failed to update favorite')
  }
}
```

**Component Location:**
- `innovation-web/src/app/api/cards/[cardId]/star/route.ts` (new)
- Update `innovation-web/src/components/OpportunityCard.tsx`
- Update `innovation-web/src/app/results/page.tsx` (if needed)
- Update `innovation-web/src/app/runs/[runId]/page.tsx` (if needed)

### Testing

**Test File Location:**
- `innovation-web/src/app/api/cards/[cardId]/star/__tests__/route.test.ts`
- `innovation-web/src/components/__tests__/OpportunityCard.test.tsx`

**Testing Standards:**
- Use React Testing Library for component tests
- Use Jest for API route testing
- Mock Prisma database operations
- Test optimistic UI behavior
- Test error handling paths

**Testing Framework:** Jest + React Testing Library + Prisma mock

**Specific Testing Requirements:**
- Test star button renders in all locations
- Test click toggles between filled and outline icon
- Test API updates starred field in database
- Test optimistic UI updates immediately
- Test error reverts icon on API failure
- Test starred state persists across page refresh
- Test user can only star their own cards
- Test ARIA label for accessibility
- Test multiple rapid toggles don't cause conflicts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation from epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
