# Story 8.2: State 1 - Extraction Animation Components

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P1
**Estimated Time:** 3-4 hours

---

## Status

**Draft**

---

## Story

**As a** CPG Innovation Manager watching my pipeline execute,
**I want** to see an engaging animated visualization while Stage 1 extracts mechanisms from my document,
**so that** I understand the system is actively processing and feel confident the pipeline is working.

---

## Acceptance Criteria

### 1. ExtractionAnimation Component Created
- File created: `innovation-web/components/pipeline/ExtractionAnimation.tsx`
- Component displays BOI (Board of Ideators) badge in top-left corner
- Animated beaker/flask illustration with bubbling teal liquid (#5B9A99)
- Pulsing animation loops smoothly every 2-3 seconds
- Text overlay: "Extracting transferable insights from your document"
- Component accepts `status` prop: 'running' | 'error'
- Error state shows red tint overlay and stops animation

### 2. WorkflowIllustration Component Created
- File created: `innovation-web/components/pipeline/WorkflowIllustration.tsx`
- Displays contextual illustration showing what Stage 1 does
- Static image with optional subtle breathing effect (scale 1.0 → 1.02)
- Shows "BOI" badge overlay for branding consistency
- Text overlay: "Understanding the core transferable pattern"
- Uses Next.js `Image` component for optimization
- Fallback to SVG icon if image fails to load

### 3. State 1 Integrated into PipelineStateMachine
- `PipelineStateMachine.tsx` renders State 1 when `currentStage === 1 && status === "PROCESSING"`
- Two-box horizontal layout on desktop (50/50 split)
- Left box: `ExtractionAnimation` component
- Right box: `WorkflowIllustration` component
- Mobile responsive: Stacks vertically on screens < 768px
- Smooth fade-in transition when State 1 activates (300ms)

### 4. BOI Branding Badge Component
- File created: `innovation-web/components/pipeline/BOIBadge.tsx`
- Reusable teal circular badge with "BOI" text
- Size variants: small (32px), medium (48px), large (64px)
- Positioned absolutely in top-left of parent container
- White text on teal background (#5B9A99)
- Accessible: `aria-label="Board of Ideators"`

### 5. CSS Animations Implemented
- Beaker bubbling animation defined in Tailwind or CSS module
- Animation duration: 2.5 seconds infinite loop
- Keyframes: subtle scale + opacity changes for bubbles
- Performance: Uses `transform` and `opacity` only (GPU-accelerated)
- Respects `prefers-reduced-motion` media query

### 6. Error State Handling
- When `status === "FAILED"` during Stage 1:
  - ExtractionAnimation shows red overlay (#EF4444 at 20% opacity)
  - Animation stops immediately
  - Text changes to: "Extraction encountered an error"
  - Error icon (⚠️) replaces bubbling animation
  - User sees clear visual feedback something went wrong

### 7. Loading State & Skeleton
- Before pipeline data loads, show skeleton placeholders
- Skeleton uses shimmer animation effect
- Two skeleton boxes maintain 50/50 layout
- Prevents layout shift when real components load
- Skeleton accessible: `aria-busy="true"`

---

## Tasks / Subtasks

- [ ] Create BOIBadge reusable component (AC: #4)
  - [ ] Create `innovation-web/components/pipeline/BOIBadge.tsx`
  - [ ] Implement size variants: small, medium, large
  - [ ] Add TypeScript interface: `BOIBadgeProps`
  - [ ] Style with Tailwind: teal background, white text, circular
  - [ ] Add absolute positioning props for flexible placement
  - [ ] Add accessibility label: `aria-label="Board of Ideators"`
  - [ ] Export as default component

- [ ] Create ExtractionAnimation component (AC: #1, #5)
  - [ ] Create `innovation-web/components/pipeline/ExtractionAnimation.tsx`
  - [ ] Import BOIBadge component
  - [ ] Add beaker/flask SVG illustration (inline or imported)
  - [ ] Define CSS keyframes for bubbling animation
  - [ ] Implement animation loop: 2.5s infinite
  - [ ] Add text overlay: "Extracting transferable insights..."
  - [ ] Implement status prop: 'running' | 'error'
  - [ ] Add error state: red overlay, stopped animation, error icon
  - [ ] Test `prefers-reduced-motion` fallback (static state)
  - [ ] Ensure GPU-accelerated properties only (transform/opacity)

- [ ] Create WorkflowIllustration component (AC: #2)
  - [ ] Create `innovation-web/components/pipeline/WorkflowIllustration.tsx`
  - [ ] Import Next.js `Image` component
  - [ ] Add placeholder workflow diagram image (or SVG)
  - [ ] Import BOIBadge and position in top-left
  - [ ] Add text overlay: "Understanding the core transferable pattern"
  - [ ] Implement optional breathing animation (scale 1.0 → 1.02, 3s loop)
  - [ ] Add fallback SVG icon if image fails
  - [ ] Handle loading state with skeleton placeholder
  - [ ] Optimize with Next.js Image priority/lazy loading

- [ ] Define CSS animations (AC: #5)
  - [ ] Create `innovation-web/styles/pipeline-animations.css` or use Tailwind
  - [ ] Define @keyframes for beaker bubbling effect
  - [ ] Define @keyframes for breathing effect (optional)
  - [ ] Define fade-in transition for State 1 activation
  - [ ] Add `prefers-reduced-motion` media query overrides
  - [ ] Test animations in Chrome, Safari, Firefox
  - [ ] Verify GPU acceleration (check DevTools Performance)

- [ ] Integrate State 1 into PipelineStateMachine (AC: #3)
  - [ ] Open `innovation-web/components/pipeline/PipelineStateMachine.tsx`
  - [ ] Import ExtractionAnimation and WorkflowIllustration components
  - [ ] Add conditional render for State 1: `currentStage === 1 && status === "PROCESSING"`
  - [ ] Create two-box layout container (flex or grid)
  - [ ] Desktop: 50/50 split (lg:grid-cols-2)
  - [ ] Mobile: Vertical stack (grid-cols-1)
  - [ ] Add gap between boxes: `gap-6`
  - [ ] Pass status prop to ExtractionAnimation
  - [ ] Add fade-in transition class: `transition-opacity duration-300`

- [ ] Add skeleton loading states (AC: #7)
  - [ ] Create `innovation-web/components/pipeline/SkeletonBox.tsx`
  - [ ] Implement shimmer animation effect
  - [ ] Two skeleton boxes in 50/50 layout
  - [ ] Match exact dimensions of real components
  - [ ] Add `aria-busy="true"` for accessibility
  - [ ] Show skeleton when `pipelineData === null`
  - [ ] Test skeleton → real component transition (no layout shift)

- [ ] Test error state handling (AC: #6)
  - [ ] Simulate Stage 1 failure (mock `status: "FAILED"`)
  - [ ] Verify ExtractionAnimation shows red overlay
  - [ ] Verify animation stops immediately
  - [ ] Verify error text displays correctly
  - [ ] Verify error icon appears
  - [ ] Test error state on mobile and desktop

- [ ] Test responsive layout (AC: #3)
  - [ ] Test on 320px width (mobile) - verify vertical stack
  - [ ] Test on 768px width (tablet) - verify 50/50 split
  - [ ] Test on 1920px width (desktop) - verify 50/50 split
  - [ ] Verify no horizontal scrolling at any breakpoint
  - [ ] Test on iOS Safari, Android Chrome

- [ ] Accessibility testing (AC: #4, #7)
  - [ ] Verify BOIBadge has `aria-label`
  - [ ] Verify skeleton has `aria-busy="true"`
  - [ ] Test keyboard navigation (focusable elements)
  - [ ] Test with screen reader (VoiceOver/NVDA)
  - [ ] Verify animation respects `prefers-reduced-motion`
  - [ ] Check color contrast ratios (WCAG AA minimum)

- [ ] Visual QA against mockup (AC: #1, #2)
  - [ ] Compare with `docs/image/MyBOI Mockup v2_compressed.pdf` Page 3
  - [ ] Verify teal color matches (#5B9A99)
  - [ ] Verify BOI badge placement matches mockup
  - [ ] Verify text overlay matches mockup
  - [ ] Verify spacing and padding consistent
  - [ ] Get design approval from UX expert

---

## Dev Notes

### Integration Points

**Parent Component:**
- `innovation-web/components/pipeline/PipelineStateMachine.tsx`
- State 1 renders when: `currentStage === 1 && status === "PROCESSING"`
- Replaces existing `DetailPanel` logic for Stage 1

**Polling Data Source:**
- Pipeline page polls: `GET /api/pipeline/[runId]/status`
- Response includes: `currentStage`, `status`, `stages[]`
- No changes to polling logic required

**Design Reference:**
- Mockup: `docs/image/MyBOI Mockup v2_compressed.pdf` - Page 3
- Specification: `docs/front-end-spec.md` - Lines 486-550
- Color palette: Teal #5B9A99, Red #EF4444

### Technical Details

**Component File Structure:**
```
innovation-web/components/pipeline/
├── BOIBadge.tsx (NEW - reusable badge)
├── ExtractionAnimation.tsx (NEW)
├── WorkflowIllustration.tsx (NEW)
├── SkeletonBox.tsx (NEW - loading state)
└── PipelineStateMachine.tsx (MODIFY - add State 1)
```

**CSS Animation Structure:**
```css
/* Beaker bubbling animation */
@keyframes bubble {
  0%, 100% {
    transform: translateY(0) scale(1);
    opacity: 0.6;
  }
  50% {
    transform: translateY(-8px) scale(1.05);
    opacity: 0.9;
  }
}

/* Breathing effect for illustration */
@keyframes breathe {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

/* Respect reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  .bubble-animation,
  .breathe-animation {
    animation: none !important;
  }
}
```

**TypeScript Interfaces:**
```typescript
// BOIBadge.tsx
interface BOIBadgeProps {
  size?: 'small' | 'medium' | 'large'
  className?: string
}

// ExtractionAnimation.tsx
interface ExtractionAnimationProps {
  status: 'running' | 'error'
  elapsedTime?: number // Optional: for future enhancement
}

// WorkflowIllustration.tsx
interface WorkflowIllustrationProps {
  imageUrl?: string // Optional custom image
  showAnimation?: boolean // Toggle breathing effect
}

// SkeletonBox.tsx
interface SkeletonBoxProps {
  width?: string // e.g., "50%"
  height?: string // e.g., "400px"
  className?: string
}
```

**State 1 Layout (Desktop):**
```tsx
// PipelineStateMachine.tsx - State 1 section
{currentState === 'state1' && (
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 transition-opacity duration-300">
    {/* Left Box: Extraction Animation */}
    <div className="relative bg-white rounded-lg shadow-md p-8 min-h-[400px]">
      <ExtractionAnimation status={status === 'FAILED' ? 'error' : 'running'} />
    </div>

    {/* Right Box: Workflow Illustration */}
    <div className="relative bg-white rounded-lg shadow-md p-8 min-h-[400px]">
      <WorkflowIllustration />
    </div>
  </div>
)}
```

**BOI Badge Implementation:**
```tsx
// BOIBadge.tsx
const BOIBadge: React.FC<BOIBadgeProps> = ({ size = 'medium', className = '' }) => {
  const sizeClasses = {
    small: 'w-8 h-8 text-xs',
    medium: 'w-12 h-12 text-sm',
    large: 'w-16 h-16 text-base',
  }

  return (
    <div
      className={`
        absolute top-4 left-4
        rounded-full bg-[#5B9A99]
        flex items-center justify-center
        font-bold text-white
        ${sizeClasses[size]}
        ${className}
      `}
      aria-label="Board of Ideators"
    >
      BOI
    </div>
  )
}
```

**Beaker SVG Illustration (Inline Example):**
```tsx
// ExtractionAnimation.tsx - Simplified beaker SVG
const BeakerSVG = () => (
  <svg viewBox="0 0 200 300" className="w-32 h-48 mx-auto">
    {/* Beaker body */}
    <path
      d="M 60 50 L 60 200 Q 100 250 140 200 L 140 50 Z"
      fill="none"
      stroke="#5B9A99"
      strokeWidth="3"
    />
    {/* Liquid */}
    <path
      d="M 65 150 L 65 195 Q 100 235 135 195 L 135 150 Z"
      fill="#5B9A99"
      opacity="0.3"
    />
    {/* Bubbles - animated */}
    <circle cx="90" cy="180" r="4" fill="#5B9A99" className="bubble-animation" />
    <circle cx="110" cy="190" r="3" fill="#5B9A99" className="bubble-animation" style={{animationDelay: '0.5s'}} />
  </svg>
)
```

### Files Referenced

- `docs/front-end-spec.md` - Lines 486-550 (State 1 component specs)
- `docs/image/MyBOI Mockup v2_compressed.pdf` - Page 3 (visual reference)
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Parent component
- `innovation-web/app/pipeline/[runId]/page.tsx` - Polling logic (unchanged)

### Design Specifications

**Colors:**
- Primary teal: `#5B9A99`
- Error red: `#EF4444`
- Background white: `#FFFFFF`
- Text dark: `#1F2937`

**Typography:**
- Heading: System UI font, 1.25rem (20px), font-semibold
- Body text: System UI font, 1rem (16px), font-normal
- BOI badge: System UI font, 0.875rem (14px), font-bold

**Spacing:**
- Box padding: `2rem` (32px)
- Gap between boxes: `1.5rem` (24px)
- BOI badge offset: `1rem` (16px) from top-left
- Text overlay margin: `1rem` (16px) from bottom

**Animations:**
- Bubbling duration: 2.5 seconds
- Breathing duration: 3 seconds
- Fade-in transition: 300ms
- All animations: `ease-in-out` timing

### Testing

#### Test File Location
- `innovation-web/__tests__/pipeline/ExtractionAnimation.test.tsx`
- `innovation-web/__tests__/pipeline/WorkflowIllustration.test.tsx`
- `innovation-web/__tests__/pipeline/BOIBadge.test.tsx`
- `innovation-web/__tests__/pipeline/state-1-integration.test.tsx`

#### Testing Standards
- All components render without errors
- Animations trigger correctly
- Error states display properly
- Responsive layout works at all breakpoints
- Accessibility attributes present
- No console warnings or errors

#### Testing Framework
- Jest + React Testing Library
- Playwright for animation testing

#### Specific Testing Requirements

1. **ExtractionAnimation Component Test:**
   - Render with status='running' → verify animation active
   - Render with status='error' → verify red overlay + stopped animation
   - Verify BOI badge renders in top-left
   - Verify text overlay displays correctly
   - Mock `prefers-reduced-motion` → verify animation disabled
   - Verify bubbling animation loops infinitely

2. **WorkflowIllustration Component Test:**
   - Render with default props → verify image loads
   - Render with custom imageUrl → verify custom image used
   - Verify BOI badge renders
   - Verify text overlay displays
   - Test image load failure → verify SVG fallback shown
   - Verify breathing animation (if enabled)

3. **BOIBadge Component Test:**
   - Render with size='small' → verify 32px dimensions
   - Render with size='medium' → verify 48px dimensions
   - Render with size='large' → verify 64px dimensions
   - Verify background color is #5B9A99
   - Verify text content is "BOI"
   - Verify aria-label present

4. **State 1 Integration Test:**
   - Mock `currentStage=1, status="PROCESSING"`
   - Verify two-box layout renders
   - Verify ExtractionAnimation in left box
   - Verify WorkflowIllustration in right box
   - Verify 50/50 split on desktop (>1024px)
   - Verify vertical stack on mobile (<768px)
   - Verify fade-in transition occurs

5. **Responsive Layout Test:**
   - Render at 320px width → verify single column
   - Render at 768px width → verify 50/50 grid
   - Render at 1920px width → verify 50/50 grid
   - Verify no horizontal scrollbar at any width
   - Test on iOS Safari, Chrome mobile

6. **Accessibility Test:**
   - Run axe-core accessibility audit
   - Verify ARIA labels present on all components
   - Test keyboard navigation
   - Test with screen reader (announce status changes)
   - Verify color contrast ratios meet WCAG AA
   - Verify `prefers-reduced-motion` respected

7. **Error State Test:**
   - Set status='FAILED' during Stage 1
   - Verify ExtractionAnimation shows error state
   - Verify red overlay (#EF4444) visible
   - Verify animation stopped
   - Verify error text displayed
   - Verify error icon visible

8. **Performance Test:**
   - Verify animations use GPU-accelerated properties
   - Check DevTools Performance panel
   - Verify no layout thrashing
   - Test on low-end mobile device
   - Verify animation frame rate >30fps

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 State 1 | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
