# Homepage Authentication Flow Redesign - Brownfield Addition

## User Story

As a new user visiting the Innovation Intelligence Platform,
I want to enter my company name on the homepage before being prompted to authenticate,
So that I can intuitively begin my workflow and be prompted to sign in only after providing context.

## Story Context

**Existing System Integration:**

- Integrates with: Clerk authentication system via middleware.ts and SignedIn/SignedOut components
- Technology: Next.js 15, Clerk authentication, React Server Components
- Follows pattern: Clerk modal authentication (currently using SignInButton mode="modal")
- Touch points:
  - `innovation-web/middleware.ts` - Auth protection layer
  - `innovation-web/app/page.tsx` - Homepage with current auth-first flow
  - `innovation-web/components/CompanyInput.tsx` - Company validation component
  - Brand profile validation against `data/brand-profiles/*.yaml`

**Current Behavior:**
- Homepage shows sign-in prompt BEFORE company input
- CompanyInput only renders when user is `<SignedIn>`
- Middleware protects all routes except `/sign-in(.*)` and `/sign-up(.*)`

**Desired Behavior:**
- User lands on homepage and sees company input field WITHOUT authentication
- User enters company name (one of 4 valid options)
- On valid company entry, Clerk authentication modal triggers
- On invalid entry, nothing happens (silent fail)
- After authentication, user proceeds to `/upload` with company context

## Acceptance Criteria

**Functional Requirements:**

1. Homepage (/) loads without automatic Clerk authentication redirect
2. Company input field is visible and functional for unauthenticated users
3. When user enters a valid company name (lactalis, columbia, decathlon, mccormick) and submits, Clerk authentication modal appears
4. When user enters invalid company name, form does nothing (no error message, no modal)
5. After successful authentication, user is redirected to /upload with company context preserved

**Integration Requirements:**

6. Existing `/upload`, `/pipeline/*`, and API routes continue to require authentication
7. CompanyInput validation logic remains unchanged (same 4 company mappings)
8. Post-authentication flow to `/api/onboarding/set-company` maintains current behavior
9. Clerk modal mode continues to work as currently implemented

**Quality Requirements:**

10. No breaking changes to existing authentication protection on other routes
11. Company validation continues to use existing `companyMapping` object
12. Error handling for invalid company names is subtle (silent fail or minimal feedback)
13. All existing tests pass (if any exist)

## Technical Notes

**Integration Approach:**

1. **Middleware Update** (`middleware.ts`):
   - Add "/" to `isPublicRoute` matcher
   - Keep all other routes protected
   - Ensure API routes remain protected

2. **Homepage Component** (`app/page.tsx`):
   - Remove `<SignedOut>` wrapper around authentication prompt
   - Remove `<SignedIn>` wrapper around CompanyInput
   - Show CompanyInput to ALL users (authenticated and unauthenticated)
   - Keep UserButton visible for signed-in users (in header/corner)

3. **CompanyInput Logic** (`components/CompanyInput.tsx`):
   - Add conditional check: if user is NOT authenticated AND company is valid, trigger `openSignIn()` from Clerk
   - Use `useAuth()` hook from `@clerk/nextjs` to check authentication state
   - If user IS authenticated, proceed directly to `/api/onboarding/set-company`
   - Maintain silent fail behavior for invalid company names

4. **Clerk Integration**:
   - Use `openSignIn()` method from `@clerk/nextjs` to programmatically trigger modal
   - Ensure modal configuration allows redirect back to homepage or directly to `/upload`
   - After authentication, resume company validation flow

**Existing Pattern Reference:**
- Current modal authentication pattern: `<SignInButton mode="modal">`
- Use Clerk's `openSignIn()` function for programmatic triggering
- Reference: https://clerk.com/docs/components/authentication/sign-in-button

**Key Constraints:**
- Must maintain security on all non-homepage routes
- Cannot break existing authentication flow for already-signed-in users
- Must preserve company validation logic exactly (4 valid companies)
- Silent fail for invalid company names (no prominent error messages)

## Definition of Done

- [x] Middleware allows unauthenticated access to homepage (/)
- [x] CompanyInput renders for all users (authenticated and unauthenticated)
- [x] Valid company name triggers Clerk authentication modal for unauthenticated users
- [x] Valid company name proceeds directly to upload for authenticated users
- [x] Invalid company name results in no action (silent fail)
- [x] All protected routes continue to require authentication
- [x] Post-authentication redirect to /upload works correctly
- [x] No regression in existing authentication flows
- [x] Code follows existing Clerk integration patterns

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Opening homepage to unauthenticated users could expose company name mapping to public, but this is acceptable as company names are not sensitive
- **Mitigation:** All other routes remain protected; company validation only reveals valid/invalid status through behavior (no explicit error messages)
- **Rollback:** Revert middleware change to remove "/" from public routes; restore `<SignedIn>` wrapper around CompanyInput

**Compatibility Verification:**

- [x] No breaking changes to existing APIs (only client-side component logic)
- [x] No database changes (file-based system, no schema changes)
- [x] UI changes follow existing design patterns (Clerk modal, existing CompanyInput styling)
- [x] Performance impact is negligible (one additional hook call in CompanyInput)

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (estimated 2-3 hours)
- [x] Integration approach is straightforward (middleware config + component logic)
- [x] Follows existing patterns exactly (Clerk modal, existing validation)
- [x] No design or architecture work required

**Clarity Check:**

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified (3 files to modify)
- [x] Success criteria are testable (can verify behavior manually)
- [x] Rollback approach is simple (revert middleware + remove conditional logic)

## Files to Modify

1. `innovation-web/middleware.ts` - Add "/" to public routes
2. `innovation-web/app/page.tsx` - Remove auth wrappers around CompanyInput
3. `innovation-web/components/CompanyInput.tsx` - Add conditional auth triggering logic
