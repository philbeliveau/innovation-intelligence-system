# Story 8.1: Pipeline State Machine Foundation

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P0
**Estimated Time:** 3-4 hours

---

## Status

**Draft**

---

## Story

**As a** CPG Innovation Manager using the Innovation Intelligence Pipeline,
**I want** the pipeline visualization page to display progressive UI states in-page without redirecting,
**so that** I can see my extracted insights and opportunity cards evolve in real-time within a single immersive experience.

---

## Acceptance Criteria

### 1. Auto-Redirect to `/results` Removed
- Current auto-redirect logic (lines 108-110 in `app/pipeline/[runId]/page.tsx`) deleted
- Pipeline page remains active when `status === "COMPLETED"`
- No navigation occurs when pipeline completes
- User stays on `/pipeline/[runId]` throughout entire pipeline lifecycle

### 2. PipelineStateMachine Component Created
- File created: `innovation-web/components/pipeline/PipelineStateMachine.tsx`
- Component accepts props: `currentStage`, `status`, `pipelineData`
- Component conditionally renders 4 state views based on pipeline progress
- TypeScript interfaces defined for all props and state data
- Component is default export for clean imports

### 3. State Transition Logic Implemented
- State 1 triggers when: `currentStage === 1 && status === "PROCESSING"`
- State 2 triggers when: `currentStage >= 2 && status === "PROCESSING"`
- State 3 triggers when: `status === "COMPLETED"` (initial grid view)
- State 4 triggers when: `status === "COMPLETED" && selectedCardId !== null`
- State transitions are smooth with 300ms CSS transitions
- No flickering or layout shifts during state changes

### 4. Feature Flag Added for Safe Deployment
- Environment variable: `NEXT_PUBLIC_NEW_PIPELINE_UI` (default: `false`)
- When `true`, renders `PipelineStateMachine`
- When `false`, renders current implementation
- Feature flag documented in `.env.example`
- Deployment process updated in CLAUDE.md with flag instructions

### 5. Main Content Area Updated
- Current `DetailPanel` component usage removed from `app/pipeline/[runId]/page.tsx`
- Main content area (lines 213-276) now renders `PipelineStateMachine`
- Polling logic remains unchanged (continues to poll status endpoint)
- Error handling preserved from current implementation
- Loading states handled gracefully during state transitions

### 6. TypeScript Type Safety
- All component props properly typed
- No `any` types used in state machine
- Pipeline data interfaces match API response structure
- Type guards used for state-dependent rendering
- No TypeScript compilation errors

### 7. Responsive Layout Maintained
- State machine components use existing Tailwind responsive classes
- Mobile (< 768px): Single column layout
- Tablet (768px - 1024px): Responsive grid adjustments
- Desktop (> 1024px): Full multi-column layouts
- No horizontal scrolling on any breakpoint

---

## Tasks / Subtasks

- [ ] Remove auto-redirect logic (AC: #1)
  - [ ] Delete redirect code from `app/pipeline/[runId]/page.tsx:108-110`
  - [ ] Test pipeline completion stays on same page
  - [ ] Verify browser URL doesn't change when status = "COMPLETED"

- [ ] Create feature flag environment variable (AC: #4)
  - [ ] Add `NEXT_PUBLIC_NEW_PIPELINE_UI=false` to `.env.example`
  - [ ] Add `NEXT_PUBLIC_NEW_PIPELINE_UI=false` to `.env.local`
  - [ ] Document flag in CLAUDE.md deployment section
  - [ ] Test flag toggle between old/new UI

- [ ] Create TypeScript interfaces for state machine (AC: #2, #6)
  - [ ] Create `innovation-web/types/pipeline-state.ts`
  - [ ] Define `PipelineStateMachineProps` interface
  - [ ] Define `PipelineState` enum (State1, State2, State3, State4)
  - [ ] Define `OpportunityCardData` interface
  - [ ] Define `StageData` interface
  - [ ] Export all interfaces for reuse

- [ ] Create PipelineStateMachine component (AC: #2, #3)
  - [ ] Create file `innovation-web/components/pipeline/PipelineStateMachine.tsx`
  - [ ] Import TypeScript interfaces from `types/pipeline-state.ts`
  - [ ] Implement state determination logic (currentStage + status)
  - [ ] Add state-dependent conditional rendering structure
  - [ ] Add placeholder divs for each state (State 1-4)
  - [ ] Add CSS transitions for state changes (300ms ease-in-out)
  - [ ] Export component as default

- [ ] Update main pipeline page to use state machine (AC: #5)
  - [ ] Import `PipelineStateMachine` into `app/pipeline/[runId]/page.tsx`
  - [ ] Add feature flag check: `process.env.NEXT_PUBLIC_NEW_PIPELINE_UI === 'true'`
  - [ ] Conditionally render: `<PipelineStateMachine>` or existing `<DetailPanel>`
  - [ ] Pass required props: currentStage, status, pipelineData
  - [ ] Remove old `DetailPanel` component import when flag enabled
  - [ ] Preserve existing polling logic (no changes to useEffect)
  - [ ] Preserve existing error handling

- [ ] Add responsive Tailwind classes (AC: #7)
  - [ ] Add mobile breakpoint classes: `flex flex-col space-y-4`
  - [ ] Add tablet breakpoint classes: `md:grid md:grid-cols-2 md:gap-4`
  - [ ] Add desktop breakpoint classes: `lg:grid-cols-3`
  - [ ] Test layout on 320px, 768px, 1024px, 1920px widths
  - [ ] Verify no horizontal scrolling

- [ ] Test state transitions (AC: #3)
  - [ ] Manually test State 1 → State 2 transition (stage 1 complete)
  - [ ] Manually test State 2 → State 3 transition (pipeline complete)
  - [ ] Manually test State 3 → State 4 transition (card clicked)
  - [ ] Verify 300ms transition timing
  - [ ] Verify no layout flicker during transitions

- [ ] End-to-end integration test (AC: #1-7)
  - [ ] Run full pipeline with feature flag ON
  - [ ] Verify page doesn't redirect when complete
  - [ ] Verify all 4 states render (placeholder divs visible)
  - [ ] Switch feature flag OFF and verify old UI works
  - [ ] Test in Chrome, Safari, Firefox
  - [ ] Test on mobile device or emulator

---

## Dev Notes

### Integration Points

**Current Implementation:**
- File: `innovation-web/app/pipeline/[runId]/page.tsx`
- Lines to modify: 108-110 (redirect), 213-276 (main content area)
- Components to preserve: StatusHeader, Left Sidebar, polling logic
- Components to replace: DetailPanel → PipelineStateMachine

**Backend Integration:**
- No backend changes required
- Continue polling: `GET /api/pipeline/[runId]/status`
- API response structure unchanged
- Webhook endpoints unchanged

**Existing Polling Logic (DO NOT MODIFY):**
```typescript
// app/pipeline/[runId]/page.tsx:70-95
useEffect(() => {
  if (status === "COMPLETED" || status === "FAILED") {
    return
  }
  // Exponential backoff polling continues...
})
```

**Current Auto-Redirect to Remove:**
```typescript
// app/pipeline/[runId]/page.tsx:108-110
if (status === "COMPLETED") {
  router.push(`/results/${runId}`)
}
```

### Technical Details

**State Determination Logic:**
```typescript
const determineCurrentState = (
  currentStage: number,
  status: string,
  selectedCardId: string | null
): PipelineState => {
  if (status === "COMPLETED" && selectedCardId !== null) {
    return PipelineState.State4 // Detail view
  }
  if (status === "COMPLETED") {
    return PipelineState.State3 // Grid view
  }
  if (currentStage >= 2 && status === "PROCESSING") {
    return PipelineState.State2 // 3-column progress
  }
  return PipelineState.State1 // Extraction animation
}
```

**Component Structure:**
```
innovation-web/
├── app/pipeline/[runId]/page.tsx (modified)
├── components/pipeline/
│   └── PipelineStateMachine.tsx (new)
└── types/
    └── pipeline-state.ts (new)
```

**Props Interface:**
```typescript
interface PipelineStateMachineProps {
  currentStage: number
  status: "PROCESSING" | "COMPLETED" | "FAILED" | "CANCELLED"
  pipelineData: {
    runId: string
    stages: StageData[]
    opportunityCards?: OpportunityCardData[]
  }
  selectedCardId?: string | null
  onCardSelect?: (cardId: string) => void
}
```

**Tailwind Transition Classes:**
```tsx
<div className="transition-all duration-300 ease-in-out">
  {/* State-dependent content */}
</div>
```

### Files Referenced

- `innovation-web/app/pipeline/[runId]/page.tsx` - Main page to modify
- `docs/front-end-spec.md` - Full UI specification (lines 1-1200)
- `docs/image/MyBOI Mockup v2_compressed.pdf` - Visual mockups (6 pages)
- `CLAUDE.md` - Deployment instructions (lines 340-370)

### Deployment Strategy

**Phase 1: Deploy with Flag OFF (Safety Check)**
```bash
# In Vercel dashboard, set: NEXT_PUBLIC_NEW_PIPELINE_UI=false
vercel --prod --yes
# Test existing pipeline works end-to-end
```

**Phase 2: Enable New UI**
```bash
# In Vercel dashboard, set: NEXT_PUBLIC_NEW_PIPELINE_UI=true
vercel --prod --yes
# Test new state machine renders all states
```

**Phase 3: Rollback Plan (if needed)**
```bash
# Immediately switch flag back to false
# User experience reverts to current implementation
# No data loss, no backend impact
```

### Testing

#### Test File Location
- `innovation-web/__tests__/pipeline/state-machine.test.tsx`
- `innovation-web/__tests__/pipeline/feature-flag.test.tsx`

#### Testing Standards
- Component renders without errors for all 4 states
- Feature flag correctly toggles between old/new UI
- State transitions occur at correct triggers
- No console errors or warnings
- TypeScript compilation succeeds with strict mode

#### Testing Framework
- Jest + React Testing Library
- Playwright for end-to-end state transition testing

#### Specific Testing Requirements

1. **State Determination Test:**
   - Verify State 1 when `currentStage=1, status="PROCESSING"`
   - Verify State 2 when `currentStage=3, status="PROCESSING"`
   - Verify State 3 when `status="COMPLETED", selectedCardId=null`
   - Verify State 4 when `status="COMPLETED", selectedCardId="123"`

2. **Feature Flag Test:**
   - Mock `process.env.NEXT_PUBLIC_NEW_PIPELINE_UI=true` → renders PipelineStateMachine
   - Mock `process.env.NEXT_PUBLIC_NEW_PIPELINE_UI=false` → renders DetailPanel
   - Verify no crashes when flag undefined (defaults to false)

3. **Redirect Removal Test:**
   - Mock `router.push` function
   - Set status="COMPLETED"
   - Assert `router.push` NOT called
   - Verify page stays on `/pipeline/[runId]`

4. **Responsive Layout Test:**
   - Render component at 320px width → verify single column
   - Render component at 768px width → verify 2-column grid
   - Render component at 1920px width → verify 3-column grid
   - Assert no horizontal scrollbar at any width

5. **TypeScript Type Safety Test:**
   - Pass invalid props → should fail TypeScript compilation
   - Pass missing required props → should fail TypeScript compilation
   - Pass correct props → should compile successfully
   - Run `tsc --noEmit` and verify 0 errors

6. **Integration Test (E2E):**
   - Start mock pipeline with `currentStage=1`
   - Verify State 1 placeholder visible
   - Update to `currentStage=2` → verify State 2 visible
   - Update to `status="COMPLETED"` → verify State 3 visible
   - Click card → verify State 4 visible
   - Verify smooth transitions (no flickering)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 foundation | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
