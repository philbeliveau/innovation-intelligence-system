# Story 5.1: FastAPI Backend Directory Structure

---

## Status

**Draft**

---

## Story

**As a** Backend Developer,
**I want** a minimal FastAPI backend directory structure at the root level (`/backend`),
**so that** I can deploy the Python pipeline to Railway independently from the Vercel frontend, with room to change the architecture in the future without coupling.

---

## Acceptance Criteria

### AC 1: Root-Level Backend Directory Created
- [ ] Directory `/backend` created at repository root (sibling to `innovation-web/`)
- [ ] Separate from frontend to enable independent Railway deployment
- [ ] Git tracked with proper `.gitignore` for Python artifacts

### AC 2: Minimal FastAPI Application Structure
- [ ] `/backend/app/main.py` - FastAPI application entry point
- [ ] `/backend/app/routes.py` - Route handlers for `/run`, `/status`, `/health`
- [ ] `/backend/app/models.py` - Pydantic request/response models
- [ ] Total code: <200 lines (keep it simple, architecture TBD)

### AC 3: Pipeline Code Integration
- [ ] `/backend/pipeline/` directory created
- [ ] Copy current pipeline stages from `/pipeline/stages/`
- [ ] Copy current pipeline prompts from `/pipeline/prompts/`
- [ ] Import works: `from pipeline.stages.stage1_input_processing import run_stage1`

### AC 4: Dependencies Configuration
- [ ] `/backend/requirements.txt` created with:
  - `fastapi==0.115.0`
  - `uvicorn==0.32.0`
  - Current pipeline dependencies (langchain, openai, etc.)
- [ ] Matches existing `pipeline/` Python dependencies
- [ ] No unnecessary packages (no Celery, no SQLAlchemy yet)

### AC 5: Environment Configuration
- [ ] `/backend/.env.example` template created with:
  - `OPENROUTER_API_KEY=sk-or-v1-...`
  - `OPENROUTER_BASE_URL=https://openrouter.ai/api/v1`
  - `LLM_MODEL=anthropic/claude-sonnet-4.5`
  - `PORT=8000`
  - `VERCEL_BLOB_READ_WRITE_TOKEN=...` (for fetching PDFs)
- [ ] `/backend/.env` added to `.gitignore`

### AC 6: Temporary File Management
- [ ] `/backend/tmp/` directory for runtime temp files
- [ ] `/backend/tmp/` added to `.gitignore`
- [ ] Cleanup logic in routes (delete PDFs after processing)

### AC 7: Local Development Works
- [ ] `cd backend && pip install -r requirements.txt` succeeds
- [ ] `uvicorn app.main:app --reload` starts server on port 8000
- [ ] Health check endpoint returns 200: `GET http://localhost:8000/health`
- [ ] No import errors or missing dependencies

### AC 8: Documentation
- [ ] `/backend/README.md` created with:
  - Local development setup instructions
  - Environment variable configuration
  - How to run server locally
  - API endpoint documentation (brief)
- [ ] Instructions tested by someone other than author

### AC 9: Git Structure
- [ ] `.gitignore` entries for:
  - `backend/.env`
  - `backend/tmp/`
  - `backend/__pycache__/`
  - `backend/*.pyc`
- [ ] No sensitive data committed (API keys, tokens)

---

## Tasks / Subtasks

- [ ] Task 1: Create `/backend` directory structure (AC: 1, 2, 3)
  - [ ] Subtask 1.1: Create `/backend/app/` directory
  - [ ] Subtask 1.2: Create `/backend/app/main.py` with minimal FastAPI app
  - [ ] Subtask 1.3: Create `/backend/app/routes.py` with placeholder routes
  - [ ] Subtask 1.4: Create `/backend/app/models.py` with Pydantic models
  - [ ] Subtask 1.5: Copy `/pipeline` to `/backend/pipeline` (temporary)

- [ ] Task 2: Configure dependencies and environment (AC: 4, 5)
  - [ ] Subtask 2.1: Create `requirements.txt` with FastAPI + current pipeline deps
  - [ ] Subtask 2.2: Create `.env.example` with required environment variables
  - [ ] Subtask 2.3: Add `.env` to `.gitignore`

- [ ] Task 3: Implement core API endpoints (AC: 2, 7)
  - [ ] Subtask 3.1: Implement `GET /health` endpoint (returns {"status": "ok"})
  - [ ] Subtask 3.2: Implement `POST /run` endpoint (placeholder - returns 501 Not Implemented)
  - [ ] Subtask 3.3: Implement `GET /status/{run_id}` endpoint (placeholder - returns 501)

- [ ] Task 4: Setup temporary file management (AC: 6)
  - [ ] Subtask 4.1: Create `/backend/tmp/` directory
  - [ ] Subtask 4.2: Add `/backend/tmp/` to `.gitignore`
  - [ ] Subtask 4.3: Add cleanup utility function in `app/utils.py`

- [ ] Task 5: Local development testing (AC: 7)
  - [ ] Subtask 5.1: Test `pip install -r requirements.txt` in fresh venv
  - [ ] Subtask 5.2: Test `uvicorn app.main:app --reload` starts without errors
  - [ ] Subtask 5.3: Test `curl http://localhost:8000/health` returns 200
  - [ ] Subtask 5.4: Verify no import errors in pipeline code

- [ ] Task 6: Documentation (AC: 8)
  - [ ] Subtask 6.1: Write `/backend/README.md` with setup instructions
  - [ ] Subtask 6.2: Document API endpoints (OpenAPI auto-generated)
  - [ ] Subtask 6.3: Add troubleshooting section for common issues

- [ ] Task 7: Git hygiene (AC: 9)
  - [ ] Subtask 7.1: Update root `.gitignore` with backend-specific entries
  - [ ] Subtask 7.2: Verify no `.env` or `tmp/` files in git status
  - [ ] Subtask 7.3: Commit only source code, not runtime artifacts

---

## Dev Notes

### Relevant Source Tree Info

**Current Pipeline Structure (to copy):**
```
/pipeline/
├── stages/
│   ├── __init__.py
│   ├── stage1_input_processing.py
│   ├── stage2_signal_amplification.py
│   ├── stage3_general_translation.py
│   ├── stage4_brand_contextualization.py
│   └── stage5_opportunity_generation.py
├── prompts/
│   ├── __init__.py
│   ├── stage1_prompt.py
│   ├── stage2_prompt.py
│   ├── stage3_prompt.py
│   ├── stage4_prompt.py
│   └── stage5_prompt.py
└── utils.py
```

**New Backend Structure:**
```
/backend/
├── app/
│   ├── __init__.py
│   ├── main.py          # FastAPI app
│   ├── routes.py        # Endpoint handlers
│   ├── models.py        # Pydantic schemas
│   └── utils.py         # Helper functions
├── pipeline/            # Copy of /pipeline (temporary)
│   ├── stages/
│   └── prompts/
├── tmp/                 # Runtime temp files (gitignored)
├── requirements.txt     # Python dependencies
├── .env.example         # Environment template
└── README.md            # Setup documentation
```

**Key Design Principles:**
1. **Minimal coupling** - Do not refactor pipeline code yet (architecture TBD)
2. **Copy, don't symlink** - Easier for Railway deployment
3. **No database** - File-based state for now (JSON in `/tmp`)
4. **No async workers** - Synchronous execution for MVP
5. **Railway-ready** - But deployment config is Story 5.2

**Important Notes from Previous Stories:**
- Current pipeline uses LangChain + OpenRouter (API key required)
- Pipeline expects PDF files as input (from Vercel Blob)
- Output files written to `data/output/runs/{run_id}/stage_{N}_output.json`
- Brand profiles loaded from `/data/brand-profiles/{brand_id}.yaml`

**Frontend Integration Points (Story 5.3):**
- Currently: `innovation-web/app/api/run/route.ts` calls `execFile()` locally
- Future: Will call `POST http://railway-backend.com/run` via fetch
- Status polling: `GET http://railway-backend.com/status/{run_id}`

### Testing

**Manual Testing Steps:**
1. Create backend directory and install dependencies
2. Start FastAPI server: `uvicorn app.main:app --reload`
3. Test health endpoint: `curl http://localhost:8000/health`
4. Verify OpenAPI docs: Visit `http://localhost:8000/docs`
5. Check import works: `python -c "from pipeline.stages.stage1_input_processing import run_stage1"`

**Test Checklist:**
- [ ] Server starts without errors
- [ ] `/health` returns `{"status": "ok"}`
- [ ] OpenAPI docs accessible at `/docs`
- [ ] Pipeline imports work (no ModuleNotFoundError)
- [ ] Environment variables loaded from `.env`

**Testing Frameworks:**
- No formal testing for MVP (Story 5.1 is infrastructure setup)
- Story 5.2 will test Railway deployment
- Story 5.3 will test E2E frontend → backend flow

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation for Epic 5 | PM Agent (John) |

---

## Dev Agent Record

### Agent Model Used
*Populated during implementation*

### Debug Log References
*Populated during implementation*

### Completion Notes List
*Populated during implementation*

### File List
*Populated during implementation*

---

## QA Results

*Results from QA Agent review of completed story implementation*
