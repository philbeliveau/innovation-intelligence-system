# Story 10.10: backward-compatibility-fallback

## Status
Approved

## Story
**As a** user viewing an old pipeline run without persisted stage outputs,
**I want** to see a clear message explaining why detailed analysis is unavailable,
**so that** I understand the limitation and know what to expect from older runs

## Acceptance Criteria

1. ThreeColumnLayout detects when stage outputs are null/empty
2. Displays informative fallback message instead of empty columns
3. Fallback message explains that detailed analysis wasn't persisted for older runs
4. State 3 (SparksGrid) still displays opportunity cards for old runs
5. Users can still download opportunity cards PDF for old runs
6. No error states or crashes when viewing old runs
7. Fallback UI styled consistently with design system

## Tasks / Subtasks

- [ ] Add detection logic in ThreeColumnLayout (AC: 1)
  - [ ] Check if `stage1Output`, `stage2Output`, `stage3Output`, `stage4Output` are all null
  - [ ] Return early with fallback UI if no stage outputs exist
  - [ ] Keep rendering normal layout if any stage outputs exist (partial data ok)
- [ ] Design fallback message UI (AC: 2, 3, 7)
  - [ ] Create FallbackMessage component
  - [ ] Add icon (info or alert-circle)
  - [ ] Style with border and background (subtle blue/gray)
  - [ ] Include clear explanation text
  - [ ] Add link to create new pipeline
- [ ] Implement fallback message (AC: 3)
  - [ ] Primary text: "Detailed Analysis Not Available"
  - [ ] Secondary text: "This pipeline run was completed before detailed stage outputs were persisted. Only the final opportunity cards are available."
  - [ ] Optional: "Run a new pipeline to see full analysis visualization"
  - [ ] Button: "Create New Pipeline" → `/upload`
- [ ] Verify State 3 still works (AC: 4, 5)
  - [ ] Test that SparksGrid displays opportunity cards for old runs
  - [ ] Verify "Download All Cards" button works
  - [ ] Verify cards can be clicked to view detail (State 4)
- [ ] Error handling (AC: 6)
  - [ ] No console errors when stage outputs null
  - [ ] No React crashes or render errors
  - [ ] Graceful degradation for partial data
- [ ] Testing (AC: 1-7)
  - [ ] Test with old runs (all stage outputs null)
  - [ ] Test with new runs (stage outputs present)
  - [ ] Test with partial data (some outputs null)
  - [ ] Verify fallback message displays correctly
  - [ ] Verify State 3 and State 4 still work for old runs

## Dev Notes

**Relevant Source Tree:**
- `innovation-web/components/pipeline/ThreeColumnLayout.tsx` - State 2 component needing fallback
- `innovation-web/components/pipeline/FallbackMessage.tsx` - New fallback UI component
- `innovation-web/components/pipeline/SparksGrid.tsx` - State 3 (should work regardless)

**Problem Context:**
- Old pipeline runs (before Story 10.1 schema update) have null stage outputs
- Users navigating to `/pipeline/[runId]` for old runs would see empty State 2
- Need graceful degradation to explain limitation without breaking UX

**Detection Logic:**
```typescript
// innovation-web/components/pipeline/ThreeColumnLayout.tsx

type ThreeColumnLayoutProps = {
  status: PipelineStatusResponse
  mode: 'live' | 'retrospective'
}

export function ThreeColumnLayout({ status, mode }: ThreeColumnLayoutProps) {
  // Check if this is an old run without stage outputs
  const hasStageOutputs = !!(
    status.stage1Output ||
    status.stage2Output ||
    status.stage3Output ||
    status.stage4Output
  )

  // Show fallback for old runs in retrospective mode
  if (mode === 'retrospective' && !hasStageOutputs) {
    return <FallbackMessage runId={status.runId} />
  }

  // Normal rendering for new runs or live mode
  const signals = status.stage2Output?.signals || []
  const insights = status.stage3Output?.insights || []
  const preliminary = status.stage4Output?.preliminary || []

  return (
    <div className="grid grid-cols-3 gap-4">
      <SignalColumn signals={signals} animate={mode === 'live'} />
      <InsightColumn insights={insights} animate={mode === 'live'} />
      <PreliminaryColumn items={preliminary} animate={mode === 'live'} />
    </div>
  )
}
```

**Fallback Message Component:**
```typescript
// innovation-web/components/pipeline/FallbackMessage.tsx

import { InfoIcon } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { useRouter } from 'next/navigation'

type FallbackMessageProps = {
  runId: string
}

export function FallbackMessage({ runId }: FallbackMessageProps) {
  const router = useRouter()

  return (
    <div className="flex items-center justify-center min-h-[400px]">
      <div className="max-w-md text-center space-y-4">
        {/* Icon */}
        <div className="flex justify-center">
          <div className="rounded-full bg-blue-100 p-3">
            <InfoIcon className="h-8 w-8 text-blue-600" />
          </div>
        </div>

        {/* Primary message */}
        <div>
          <h3 className="text-lg font-semibold text-gray-900">
            Detailed Analysis Not Available
          </h3>
          <p className="mt-2 text-sm text-gray-600">
            This pipeline run was completed before detailed stage outputs were persisted.
            Only the final opportunity cards are available.
          </p>
        </div>

        {/* Actions */}
        <div className="flex flex-col gap-2 sm:flex-row sm:justify-center">
          <Button
            variant="outline"
            onClick={() => router.push(`/pipeline/${runId}#sparks`)}
          >
            View Opportunity Cards
          </Button>
          <Button
            className="bg-[#5B9A99] hover:bg-[#4A7B7A]"
            onClick={() => router.push('/upload')}
          >
            Create New Pipeline
          </Button>
        </div>

        {/* Additional info */}
        <p className="text-xs text-gray-500">
          Run a new pipeline to see the full analysis visualization with signals,
          insights, and detailed transformation steps.
        </p>
      </div>
    </div>
  )
}
```

**Important Constraints:**
- Fallback ONLY shows in retrospective mode (not live mode)
- State 3 (SparksGrid) MUST still work for old runs (opportunity cards always persisted)
- State 4 (ExpandedSparkDetail) MUST still work for old runs
- No error states or crashes (graceful degradation)
- Fallback message should be helpful, not apologetic

**User Experience:**
- User navigates to old pipeline run → `/pipeline/[runId]`
- Pipeline page loads in retrospective mode (status=COMPLETED)
- State machine tries to render State 2 (ThreeColumnLayout)
- ThreeColumnLayout detects no stage outputs → shows fallback message
- User can click "View Opportunity Cards" → scroll to State 3
- OR click "Create New Pipeline" → navigate to upload page

**Edge Cases:**
1. **Partial data**: If some stage outputs exist but not all, show what's available
2. **Failed runs**: Show error state, not fallback (different use case)
3. **Cancelled runs**: Show cancelled state, not fallback
4. **Live runs without outputs yet**: Show loading/animation, not fallback

**State Transition Behavior:**
- Old run in retrospective mode:
  - State 1: Skip (no extraction animation)
  - State 2: Show fallback message
  - State 3: Show SparksGrid with opportunity cards ✓
  - State 4: Show ExpandedSparkDetail ✓

**Dependencies:**
- Requires Story 10.5 (status endpoint) to return stage outputs
- Requires Story 10.7 (state machine) for retrospective mode
- Completes the backward compatibility story for pipeline persistence

### Testing

**Test File Location:**
- `innovation-web/components/pipeline/ThreeColumnLayout.test.tsx` (update)
- `innovation-web/components/pipeline/FallbackMessage.test.tsx` (NEW)

**Testing Standards:**
- Use Jest with React Testing Library
- Mock PipelineStatusResponse with null stage outputs
- Test rendering and user interactions

**Testing Frameworks:**
- Jest for unit testing
- React Testing Library for component testing

**Specific Testing Requirements:**

1. **ThreeColumnLayout Tests:**
   ```typescript
   // Test: Shows fallback when all stage outputs null (retrospective mode)
   // Test: Shows normal layout when stage outputs present
   // Test: Shows normal layout in live mode (even with null outputs)
   // Test: Handles partial data gracefully (some outputs null)
   ```

2. **FallbackMessage Tests:**
   ```typescript
   // Test: Renders fallback message with correct text
   // Test: "View Opportunity Cards" button scrolls to State 3
   // Test: "Create New Pipeline" button navigates to /upload
   // Test: Icon and styling render correctly
   ```

3. **Integration Testing:**
   - Navigate to old pipeline run (before schema update)
   - Verify fallback message displays in State 2
   - Click "View Opportunity Cards"
   - Verify State 3 displays opportunity cards
   - Click on card thumbnail
   - Verify State 4 displays card detail
   - Test with new run (stage outputs present)
   - Verify normal State 2 displays

**Manual Testing Checklist:**
- [ ] Find old pipeline run (created before Story 10.1)
- [ ] Navigate to `/pipeline/[runId]`
- [ ] Verify fallback message displays in State 2 area
- [ ] Verify message text is clear and helpful
- [ ] Click "View Opportunity Cards" button
- [ ] Verify scrolls/navigates to State 3
- [ ] Verify opportunity cards display correctly
- [ ] Click card thumbnail
- [ ] Verify State 4 displays card detail
- [ ] Test "Create New Pipeline" button
- [ ] Verify navigates to upload page
- [ ] Test with new run (stage outputs present)
- [ ] Verify normal State 2 displays (no fallback)

**Fallback Message Content Testing:**
- Primary heading clear and concise ✓
- Explanation text helpful and informative ✓
- Call-to-action buttons clear ✓
- No blame/apology language ✓
- Consistent with design system ✓

**Success Metrics:**
- Old runs display fallback message instead of empty State 2
- Fallback message explains limitation clearly
- Users can still access opportunity cards (State 3)
- Users can still view card details (State 4)
- No errors or crashes when viewing old runs
- Fallback UI styled consistently with design system

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation from Pipeline Persistence Epic | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
