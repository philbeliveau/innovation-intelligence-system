# Story 8.3: State 2 - Three-Column Progress Layout

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P1
**Estimated Time:** 4-5 hours

---

## Status

**Draft**

---

## Story

**As a** CPG Innovation Manager watching my pipeline process insights,
**I want** to see the transformation from original signals → transferable insights → generated sparks in real-time,
**so that** I understand how the system is converting trend data into actionable opportunities for my brand.

---

## Acceptance Criteria

### 1. Three-Column Layout Component Created
- File created: `innovation-web/components/pipeline/ThreeColumnLayout.tsx`
- Desktop (>1024px): 3 equal columns (33.33% width each)
- Tablet (768-1024px): 3 columns with adjusted spacing
- Mobile (<768px): Single column, stacked vertically
- Column gap: 24px horizontal, 16px vertical (mobile)
- Background: Light gray (#F9FAFB) to distinguish from sidebar

### 2. SignalsColumn Component Created
- File created: `innovation-web/components/pipeline/SignalsColumn.tsx`
- Header: Signal icon (antenna/radar) + "Signals" label
- Displays original trend image from uploaded document
- Shows trend title (truncated to 2 lines with ellipsis)
- White card background with subtle shadow
- Responsive image: Uses Next.js Image component
- Fallback placeholder if no image available

### 3. TransferableInsightsColumn Component Created
- File created: `innovation-web/components/pipeline/TransferableInsightsColumn.tsx`
- Header: Lightbulb icon + "Transferable Insights" label
- Displays extracted mechanism with 3 sections:
  - "Core Mechanism" - Main transferable pattern
  - "Business Impact" - ROI/value proposition
  - "Pattern Transfers To" - Applicable industries
- Link at bottom: "View/download extraction report" (blue text, underlined)
- Scrollable content if text exceeds container height
- Download triggers: `GET /api/pipeline/[runId]/download/stage1`

### 4. SparksPreviewColumn Component Created
- File created: `innovation-web/components/pipeline/SparksPreviewColumn.tsx`
- Header: Rocket icon + "Sparks" label
- Shows 2 preview cards of generated opportunities (first 2 only)
- Each preview card displays:
  - Large number badge (1, 2) in top-left corner
  - Small hero image thumbnail (16:9 aspect ratio)
  - Title (1 line, truncated)
  - Brief summary (2 lines, truncated)
- Preview cards NOT clickable (just visual preview)
- "More sparks generating..." text if pipeline still running

### 5. State 2 Integrated into PipelineStateMachine
- `PipelineStateMachine.tsx` renders State 2 when `currentStage >= 2 && status === "PROCESSING"`
- Three-column layout replaces State 1 two-box layout
- Smooth transition from State 1 → State 2 (800ms fade + slide)
- Columns populate progressively as data becomes available
- BOI branding maintained (badge visible in insights column)

### 6. Real-Time Data Updates During Processing
- Signals column shows immediately when Stage 1 completes
- Insights column populates when Stage 2 data available
- Sparks preview updates as Stage 5 generates opportunities
- Each column has loading skeleton before data arrives
- Polling continues every 5 seconds for status updates

### 7. Icon Set Implementation
- Signal icon: Antenna/radar SVG (teal #5B9A99)
- Insights icon: Lightbulb SVG (teal #5B9A99)
- Sparks icon: Rocket SVG (teal #5B9A99)
- Icons created as reusable components in `innovation-web/components/icons/`
- Icon size: 24px × 24px
- Icons accessible: `aria-hidden="true"` (decorative)

---

## Tasks / Subtasks

- [ ] Create icon components (AC: #7)
  - [ ] Create `innovation-web/components/icons/SignalIcon.tsx`
  - [ ] Create `innovation-web/components/icons/InsightsIcon.tsx`
  - [ ] Create `innovation-web/components/icons/SparksIcon.tsx`
  - [ ] Implement SVG antenna/radar for Signal icon (24×24px, teal)
  - [ ] Implement SVG lightbulb for Insights icon (24×24px, teal)
  - [ ] Implement SVG rocket for Sparks icon (24×24px, teal)
  - [ ] Add `aria-hidden="true"` to all icons (decorative)
  - [ ] Export all icons from index file

- [ ] Create SignalsColumn component (AC: #2)
  - [ ] Create `innovation-web/components/pipeline/SignalsColumn.tsx`
  - [ ] Import SignalIcon component
  - [ ] Add header section with icon + "Signals" label
  - [ ] Implement trend image display (Next.js Image component)
  - [ ] Add trend title with 2-line truncation
  - [ ] Style white card with shadow and rounded corners
  - [ ] Add placeholder for missing image
  - [ ] Implement TypeScript interface: `SignalsColumnProps`

- [ ] Create TransferableInsightsColumn component (AC: #3)
  - [ ] Create `innovation-web/components/pipeline/TransferableInsightsColumn.tsx`
  - [ ] Import InsightsIcon and BOIBadge components
  - [ ] Add header section with icon + "Transferable Insights" label
  - [ ] Implement 3-section layout:
    - [ ] "Core Mechanism" section with mechanism text
    - [ ] "Business Impact" section with ROI/value text
    - [ ] "Pattern Transfers To" section with industry list
  - [ ] Add scrollable container with max-height constraint
  - [ ] Add "View/download extraction report" link at bottom
  - [ ] Wire download link to `/api/pipeline/[runId]/download/stage1`
  - [ ] Style with appropriate spacing and typography

- [ ] Create SparksPreviewColumn component (AC: #4)
  - [ ] Create `innovation-web/components/pipeline/SparksPreviewColumn.tsx`
  - [ ] Import SparksIcon component
  - [ ] Add header section with icon + "Sparks" label
  - [ ] Create SparkPreviewCard sub-component:
    - [ ] Number badge overlay (1, 2) in top-left
    - [ ] Hero image thumbnail (16:9 aspect ratio, rounded)
    - [ ] Title text (1 line truncation)
    - [ ] Summary text (2 lines truncation)
  - [ ] Display first 2 sparks only
  - [ ] Add "More sparks generating..." text if currentStage < 5
  - [ ] Add loading skeleton for preview cards

- [ ] Create ThreeColumnLayout container (AC: #1)
  - [ ] Create `innovation-web/components/pipeline/ThreeColumnLayout.tsx`
  - [ ] Implement responsive grid:
    - [ ] Desktop: `lg:grid-cols-3`
    - [ ] Tablet: `md:grid-cols-3`
    - [ ] Mobile: `grid-cols-1`
  - [ ] Add gap classes: `gap-6 lg:gap-6 md:gap-4`
  - [ ] Add background: `bg-gray-50`
  - [ ] Add padding: `p-6`
  - [ ] Implement TypeScript interface: `ThreeColumnLayoutProps`
  - [ ] Accept children or specific column components as props

- [ ] Integrate State 2 into PipelineStateMachine (AC: #5)
  - [ ] Open `innovation-web/components/pipeline/PipelineStateMachine.tsx`
  - [ ] Import ThreeColumnLayout and all column components
  - [ ] Add conditional render: `currentStage >= 2 && status === "PROCESSING"`
  - [ ] Pass stage data to each column component:
    - [ ] Stage 1 output → SignalsColumn
    - [ ] Stage 2 output → TransferableInsightsColumn
    - [ ] Stage 5 output → SparksPreviewColumn
  - [ ] Add State 1 → State 2 transition: `transition-all duration-800 ease-in-out`
  - [ ] Handle missing data with loading skeletons

- [ ] Implement real-time data updates (AC: #6)
  - [ ] Create loading skeleton for SignalsColumn
  - [ ] Create loading skeleton for TransferableInsightsColumn
  - [ ] Create loading skeleton for SparksPreviewColumn
  - [ ] Show skeleton until stage data available
  - [ ] Update columns as polling receives new stage outputs
  - [ ] Test progressive population (Stage 2 → 3 → 4 → 5)

- [ ] Add download functionality (AC: #3)
  - [ ] Create download handler in pipeline page
  - [ ] Wire to API endpoint: `GET /api/pipeline/[runId]/download/stage1`
  - [ ] Trigger browser download on link click
  - [ ] Show loading spinner during download
  - [ ] Handle download errors gracefully (toast notification)

- [ ] Test State 1 → State 2 transition (AC: #5)
  - [ ] Mock Stage 1 completion
  - [ ] Verify State 1 fades out smoothly
  - [ ] Verify State 2 slides in from right
  - [ ] Verify 800ms transition duration
  - [ ] Test on Chrome, Safari, Firefox
  - [ ] Verify no layout flicker

- [ ] Test responsive layout (AC: #1)
  - [ ] Test on 320px width (mobile) - verify single column stack
  - [ ] Test on 768px width (tablet) - verify 3 columns maintained
  - [ ] Test on 1920px width (desktop) - verify 3 equal columns
  - [ ] Verify column gap spacing consistent
  - [ ] Verify no horizontal scrolling
  - [ ] Test on iOS Safari, Android Chrome

- [ ] Visual QA against mockup (AC: #2, #3, #4)
  - [ ] Compare with `docs/image/MyBOI Mockup v2_compressed.pdf` Page 5
  - [ ] Verify icon styles match mockup
  - [ ] Verify column header typography matches
  - [ ] Verify card spacing and shadows match
  - [ ] Verify teal color (#5B9A99) consistent
  - [ ] Get design approval from UX expert

---

## Dev Notes

### Integration Points

**Parent Component:**
- `innovation-web/components/pipeline/PipelineStateMachine.tsx`
- State 2 renders when: `currentStage >= 2 && status === "PROCESSING"`
- Replaces State 1 when Stage 1 completes

**Data Source:**
- Pipeline page polls: `GET /api/pipeline/[runId]/status`
- Response structure:
  ```typescript
  {
    currentStage: number
    status: "PROCESSING" | "COMPLETED" | "FAILED"
    stages: [
      { stageNumber: 1, output: {...} },
      { stageNumber: 2, output: {...} },
      // ...
    ]
  }
  ```

**Backend Integration:**
- Stage 1 output: Contains extracted mechanisms and trend data
- Stage 2-4 outputs: Currently processing (show in insights)
- Stage 5 output: Generated opportunity cards (preview first 2)
- Download endpoint: `/api/pipeline/[runId]/download/stage1` (returns PDF)

**Design Reference:**
- Mockup: `docs/image/MyBOI Mockup v2_compressed.pdf` - Page 5
- Specification: `docs/front-end-spec.md` - Lines 552-636
- Color palette: Teal #5B9A99, Gray #F9FAFB, White #FFFFFF

### Technical Details

**Component File Structure:**
```
innovation-web/
├── components/
│   ├── icons/
│   │   ├── SignalIcon.tsx (NEW)
│   │   ├── InsightsIcon.tsx (NEW)
│   │   ├── SparksIcon.tsx (NEW)
│   │   └── index.ts (NEW - export all icons)
│   └── pipeline/
│       ├── ThreeColumnLayout.tsx (NEW)
│       ├── SignalsColumn.tsx (NEW)
│       ├── TransferableInsightsColumn.tsx (NEW)
│       ├── SparksPreviewColumn.tsx (NEW)
│       └── PipelineStateMachine.tsx (MODIFY)
```

**TypeScript Interfaces:**
```typescript
// ThreeColumnLayout.tsx
interface ThreeColumnLayoutProps {
  children: React.ReactNode
  className?: string
}

// SignalsColumn.tsx
interface SignalsColumnProps {
  trendImage?: string
  trendTitle: string
  trendDescription?: string
}

// TransferableInsightsColumn.tsx
interface TransferableInsightsColumnProps {
  coreMechanism: string
  businessImpact: string
  patternTransfersTo: string[]
  runId: string
  onDownload: () => void
}

// SparksPreviewColumn.tsx
interface SparksPreviewColumnProps {
  sparks: SparkPreview[]
  isGenerating: boolean
}

interface SparkPreview {
  number: number
  title: string
  summary: string
  heroImageUrl?: string
}
```

**Three-Column Layout Implementation:**
```tsx
// ThreeColumnLayout.tsx
const ThreeColumnLayout: React.FC<ThreeColumnLayoutProps> = ({ children, className = '' }) => {
  return (
    <div className={`
      grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3
      gap-4 md:gap-4 lg:gap-6
      bg-gray-50 p-6
      transition-all duration-800 ease-in-out
      ${className}
    `}>
      {children}
    </div>
  )
}
```

**Icon SVG Examples:**
```tsx
// SignalIcon.tsx
export const SignalIcon: React.FC<{ className?: string }> = ({ className = '' }) => (
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    className={className}
    aria-hidden="true"
  >
    <path
      d="M12 2L12 22M6 8L12 2L18 8M6 16L12 22L18 16"
      stroke="#5B9A99"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
)

// InsightsIcon.tsx (Lightbulb)
export const InsightsIcon: React.FC<{ className?: string }> = ({ className = '' }) => (
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    className={className}
    aria-hidden="true"
  >
    <path
      d="M9 21H15M12 3C8.13 3 5 6.13 5 10C5 13.17 7 15.92 10 17V19C10 19.55 10.45 20 11 20H13C13.55 20 14 19.55 14 19V17C17 15.92 19 13.17 19 10C19 6.13 15.87 3 12 3Z"
      stroke="#5B9A99"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
)

// SparksIcon.tsx (Rocket)
export const SparksIcon: React.FC<{ className?: string }> = ({ className = '' }) => (
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    className={className}
    aria-hidden="true"
  >
    <path
      d="M12 3L14 8L19 10L14 12L12 17L10 12L5 10L10 8L12 3Z"
      stroke="#5B9A99"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      fill="#5B9A99"
      fillOpacity="0.2"
    />
  </svg>
)
```

**Column Header Pattern:**
```tsx
// Reusable header for all columns
const ColumnHeader: React.FC<{ icon: React.ReactNode; title: string }> = ({ icon, title }) => (
  <div className="flex items-center gap-2 mb-4">
    {icon}
    <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
  </div>
)
```

**Spark Preview Card:**
```tsx
// Sub-component within SparksPreviewColumn
const SparkPreviewCard: React.FC<SparkPreview> = ({ number, title, summary, heroImageUrl }) => (
  <div className="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
    <div className="relative aspect-video">
      {heroImageUrl ? (
        <Image src={heroImageUrl} alt={title} fill className="object-cover" />
      ) : (
        <div className="w-full h-full bg-gray-200" />
      )}
      <div className="absolute top-2 left-2 w-8 h-8 bg-white rounded-full flex items-center justify-center font-bold text-sm">
        {number}
      </div>
    </div>
    <div className="p-3">
      <h4 className="font-semibold text-sm line-clamp-1">{title}</h4>
      <p className="text-xs text-gray-600 line-clamp-2 mt-1">{summary}</p>
    </div>
  </div>
)
```

**State Transition Animation:**
```tsx
// PipelineStateMachine.tsx - State 1 to State 2 transition
const [isTransitioning, setIsTransitioning] = useState(false)

useEffect(() => {
  if (currentStage >= 2 && previousStage === 1) {
    setIsTransitioning(true)
    setTimeout(() => setIsTransitioning(false), 800)
  }
}, [currentStage])

return (
  <>
    {/* State 1 - Fade out */}
    <div className={`
      transition-opacity duration-800
      ${currentStage >= 2 ? 'opacity-0 pointer-events-none absolute' : 'opacity-100'}
    `}>
      {/* State 1 content */}
    </div>

    {/* State 2 - Slide in */}
    <div className={`
      transition-all duration-800 ease-in-out
      ${currentStage >= 2 ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-8'}
    `}>
      <ThreeColumnLayout>
        <SignalsColumn {...signalsData} />
        <TransferableInsightsColumn {...insightsData} />
        <SparksPreviewColumn {...sparksData} />
      </ThreeColumnLayout>
    </div>
  </>
)
```

### Files Referenced

- `docs/front-end-spec.md` - Lines 552-636 (State 2 component specs)
- `docs/image/MyBOI Mockup v2_compressed.pdf` - Page 5 (visual reference)
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Parent component
- `innovation-web/app/api/pipeline/[runId]/download/stage1/route.ts` - Download endpoint

### Design Specifications

**Column Layout:**
- Desktop: 3 columns × 33.33% width
- Tablet: 3 columns with tighter spacing
- Mobile: 1 column, stacked
- Gap: 24px (desktop), 16px (tablet/mobile)
- Background: #F9FAFB
- Padding: 24px

**Typography:**
- Column header: 1.125rem (18px), font-semibold
- Card title: 1rem (16px), font-semibold
- Card body: 0.875rem (14px), font-normal
- Link: 0.875rem (14px), font-medium, teal color

**Colors:**
- Primary teal: `#5B9A99`
- Background gray: `#F9FAFB`
- Card background: `#FFFFFF`
- Text dark: `#1F2937`
- Text gray: `#6B7280`

**Spacing:**
- Column padding: 1.5rem (24px)
- Card margin-bottom: 1rem (16px)
- Header margin-bottom: 1rem (16px)
- Icon-text gap: 0.5rem (8px)

**Shadows:**
- Card shadow: `shadow-sm` (Tailwind)
- Hover shadow: `shadow-md` (Tailwind)

### Testing

#### Test File Location
- `innovation-web/__tests__/pipeline/ThreeColumnLayout.test.tsx`
- `innovation-web/__tests__/pipeline/SignalsColumn.test.tsx`
- `innovation-web/__tests__/pipeline/TransferableInsightsColumn.test.tsx`
- `innovation-web/__tests__/pipeline/SparksPreviewColumn.test.tsx`
- `innovation-web/__tests__/pipeline/state-2-integration.test.tsx`
- `innovation-web/__tests__/icons/pipeline-icons.test.tsx`

#### Testing Standards
- All components render without errors
- Responsive layout works at all breakpoints
- State transition animates smoothly
- Download functionality triggers correctly
- Icons render with proper accessibility
- No console warnings or errors

#### Testing Framework
- Jest + React Testing Library
- Playwright for state transition testing

#### Specific Testing Requirements

1. **Icon Components Test:**
   - Render SignalIcon → verify SVG path present
   - Render InsightsIcon → verify SVG path present
   - Render SparksIcon → verify SVG path present
   - Verify all icons have `aria-hidden="true"`
   - Verify teal color (#5B9A99) applied
   - Verify 24×24px dimensions

2. **SignalsColumn Test:**
   - Render with trend data → verify image displays
   - Render without image → verify placeholder shown
   - Verify title truncates to 2 lines
   - Verify SignalIcon renders in header
   - Test Next.js Image optimization working

3. **TransferableInsightsColumn Test:**
   - Render with mechanism data → verify 3 sections display
   - Verify "Core Mechanism" section renders
   - Verify "Business Impact" section renders
   - Verify "Pattern Transfers To" section renders
   - Verify download link present and clickable
   - Mock download handler → verify called on click
   - Test scrollable container if content exceeds height

4. **SparksPreviewColumn Test:**
   - Render with 2 sparks → verify both preview cards shown
   - Verify number badges (1, 2) display correctly
   - Verify titles truncate to 1 line
   - Verify summaries truncate to 2 lines
   - Render with `isGenerating=true` → verify "More sparks generating..." text
   - Test with missing hero images → verify fallback placeholder

5. **ThreeColumnLayout Test:**
   - Render with 3 children → verify grid layout
   - Test at 320px width → verify single column
   - Test at 768px width → verify 3 columns
   - Test at 1920px width → verify 3 equal columns
   - Verify gap spacing correct
   - Verify background color #F9FAFB applied

6. **State 2 Integration Test:**
   - Mock `currentStage=2, status="PROCESSING"`
   - Verify ThreeColumnLayout renders
   - Verify all 3 columns populated
   - Verify icons render in column headers
   - Test progressive data loading (skeletons → real data)
   - Test State 1 → State 2 transition (800ms fade + slide)

7. **Download Functionality Test:**
   - Mock download handler function
   - Click "View/download extraction report" link
   - Verify download handler called with correct runId
   - Mock API response → verify browser download triggered
   - Mock API error → verify error toast shown

8. **Responsive Layout Test:**
   - Render at 320px width → verify 1 column stack
   - Render at 768px width → verify 3 columns maintained
   - Render at 1024px width → verify 3 equal columns
   - Verify column gap adjusts responsively
   - Verify no horizontal scrollbar
   - Test on iOS Safari, Android Chrome

9. **Real-Time Update Test:**
   - Mock Stage 1 complete → verify SignalsColumn populates
   - Mock Stage 2 complete → verify InsightsColumn updates
   - Mock Stage 5 partial → verify SparksPreview shows 1 card
   - Mock Stage 5 complete → verify SparksPreview shows 2 cards
   - Verify loading skeletons display before data arrives
   - Verify smooth updates without layout flicker

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 State 2 | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
