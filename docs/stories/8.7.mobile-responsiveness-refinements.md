# Story 8.7: Mobile Responsiveness Refinements

**Epic:** Epic 8 - Pipeline Visualization Refactor
**Priority:** P2
**Estimated Time:** 2-3 hours

---

## Status

**Approved**

---

## Story

**As a** CPG Innovation Manager using the Innovation Intelligence Pipeline on mobile devices,
**I want** all 4 pipeline states to adapt seamlessly to smaller screens,
**so that** I can review insights and opportunity cards effectively from my phone or tablet without losing functionality.

---

## Acceptance Criteria

### 1. Mobile Breakpoint Strategy Defined
- Mobile: < 768px (phones in portrait/landscape)
- Tablet: 768px - 1023px (tablets)
- Desktop: 1024px - 1439px (laptops)
- Wide: ≥ 1440px (large screens)
- All layouts use mobile-first Tailwind breakpoints (`sm:`, `md:`, `lg:`, `xl:`)
- Tested on iPhone SE (375px), iPhone 14 (390px), iPad (768px), iPad Pro (1024px)

### 2. State 1 Mobile Layout (Extraction Animation)
- Two-box layout stacks vertically on mobile (< 768px)
- Extraction animation box: Full width, height auto (min 300px)
- Workflow illustration box: Full width, below animation
- BOI badge: Scales down to 80% on mobile, maintains legibility
- Touch targets: Minimum 44x44px for all interactive elements
- Skeleton boxes: Maintain 16:9 aspect ratio

### 3. State 2 Mobile Layout (Three-Column Progress)
- Desktop (≥1024px): 3 columns side-by-side
- Tablet (768-1023px): 2 columns (Signals + Insights top, Sparks bottom full-width)
- Mobile (<768px): Single column stack (Signals → Insights → Sparks)
- Icon navigation: Switches to horizontal scroll on mobile
- Mechanism cards: Full width on mobile, maintain padding
- Stage boxes: Stack vertically, full width

### 4. State 3 Mobile Layout (Sparks Grid)
- Desktop (≥1024px): 2-column grid
- Tablet (768-1023px): 2-column grid
- Mobile (<768px): 1-column stack
- Spark cards: Full width on mobile, maintain aspect ratio (16:9 hero image)
- Icon navigation: Remains visible, switches to compact mode (icons only, no labels)
- Action bar (Download All + New Pipeline): Stacks vertically on mobile
- Fixed bottom bar: 60px height on mobile (thumb-friendly)

### 5. State 4 Mobile Layout (Detail View)
- Desktop (≥1024px): Sidebar (120px) + Detail (remaining width)
- Tablet (768-1023px): Sidebar (120px) + Detail (remaining width)
- Mobile (<768px): Sidebar hidden, hamburger menu top-left
- Mobile detail view: Full width, full height
- Mobile navigation: Top bar with Prev/Next arrows (44x44px touch targets)
- Hamburger menu: Slides in from left (80% width overlay)
- Thumbnail grid in menu: 2 columns, scrollable

### 6. Touch Interaction Enhancements
- All interactive elements: ≥44x44px touch targets (WCAG AAA)
- Hover states on desktop → Active states on mobile (tap feedback)
- Spark cards: Tap to expand (no hover preview on mobile)
- Sidebar thumbnails: Tap to select, visual feedback (teal border)
- Swipe gestures: Left/right swipe to navigate between sparks (State 4)
- Pull-to-refresh: Disabled (conflicts with scroll)

### 7. Typography and Spacing Scaling
- Base font size: 16px (mobile), 18px (desktop)
- Headings: Scale down 10% on mobile (h1: 28px → 32px)
- Line height: 1.5 (mobile), 1.6 (desktop)
- Padding/margins: Scale using Tailwind spacing (4, 6, 8 → 6, 8, 12)
- Card padding: 16px (mobile), 24px (desktop)
- Grid gaps: 16px (mobile), 24px (desktop)

---

## Tasks / Subtasks

- [ ] Define responsive breakpoint constants (AC: #1)
  - [ ] Document breakpoints in `tailwind.config.js`
  - [ ] Create `innovation-web/lib/breakpoints.ts` with pixel values
  - [ ] Export `useBreakpoint()` hook for JS-based responsive logic
  - [ ] Test breakpoint detection on real devices (iPhone, iPad)
  - [ ] Verify Tailwind classes: `sm:`, `md:`, `lg:`, `xl:`, `2xl:`

- [ ] Refactor State 1 for mobile (AC: #2)
  - [ ] Update `ExtractionAnimation.tsx`: Add `flex flex-col md:flex-row`
  - [ ] Update `WorkflowIllustration.tsx`: Full width on mobile
  - [ ] Scale BOI badge: `scale-80 md:scale-100`
  - [ ] Test on 375px (iPhone SE): Verify no horizontal scroll
  - [ ] Test on 768px (iPad portrait): Verify layout switches to 2-column
  - [ ] Add min-height constraints to prevent collapsing

- [ ] Refactor State 2 for mobile (AC: #3)
  - [ ] Update `ThreeColumnLayout.tsx`:
    - Mobile: `flex flex-col space-y-4`
    - Tablet: `md:grid md:grid-cols-2 md:gap-6`
    - Desktop: `lg:grid-cols-3`
  - [ ] Update `SignalsColumn.tsx`: Full width on mobile
  - [ ] Update `InsightsColumn.tsx`: Full width on mobile
  - [ ] Update `SparksPreviewColumn.tsx`: Full width on mobile
  - [ ] Test icon navigation horizontal scroll on 375px
  - [ ] Verify stage boxes stack vertically on mobile

- [ ] Refactor State 3 for mobile (AC: #4)
  - [ ] Update `SparksGrid.tsx`:
    - Mobile: `grid grid-cols-1 gap-4`
    - Tablet: `md:grid-cols-2 md:gap-6`
    - Desktop: `lg:grid-cols-2 lg:gap-6`
  - [ ] Update `IconNavigation.tsx`: Compact mode (icons only) on mobile
  - [ ] Update `ActionBar.tsx`: Stack buttons vertically on mobile
  - [ ] Test fixed bottom bar: 60px height, thumb zone
  - [ ] Verify spark card aspect ratio maintained at 375px
  - [ ] Test Download All button: Full width on mobile

- [ ] Implement State 4 mobile navigation (AC: #5)
  - [ ] Create hamburger menu component: `MobileSparkNavigationMenu.tsx`
  - [ ] Sidebar: Hidden on mobile (`hidden lg:block`)
  - [ ] Top navigation bar: Show on mobile only (`block lg:hidden`)
  - [ ] Prev/Next buttons: 44x44px, left/right corners
  - [ ] Hamburger icon: Top-left, 44x44px, animated (☰ ↔ ✕)
  - [ ] Slide-in menu: 80% width, overlay with backdrop blur
  - [ ] Thumbnail grid in menu: 2 columns, 8px gap, scrollable
  - [ ] Test menu open/close animation: 300ms slide from left

- [ ] Add touch interaction enhancements (AC: #6)
  - [ ] Verify all buttons/cards ≥44x44px touch targets
  - [ ] Add `active:` states for tap feedback (scale 0.98)
  - [ ] Implement swipe gestures in `ExpandedSparkDetail.tsx`:
    - Use `useSwipeable` hook or `TouchEvent` listeners
    - Swipe left: Next spark
    - Swipe right: Previous spark
  - [ ] Add haptic feedback (iOS): `navigator.vibrate(10)`
  - [ ] Test swipe sensitivity: 50px min distance, 300ms max duration
  - [ ] Disable pull-to-refresh: `overscroll-behavior-y: contain`

- [ ] Scale typography and spacing (AC: #7)
  - [ ] Update base font size in `tailwind.config.js`:
    - Mobile: `fontSize: '16px'`
    - Desktop: `lg:fontSize: '18px'`
  - [ ] Scale headings:
    - h1: `text-2xl md:text-4xl` (24px → 36px)
    - h2: `text-xl md:text-3xl` (20px → 30px)
    - h3: `text-lg md:text-2xl` (18px → 24px)
  - [ ] Update card padding: `p-4 md:p-6` (16px → 24px)
  - [ ] Update grid gaps: `gap-4 md:gap-6` (16px → 24px)
  - [ ] Test readability on iPhone SE (smallest screen)

- [ ] Viewport meta tag and safe areas (AC: #1)
  - [ ] Verify `<meta name="viewport" content="width=device-width, initial-scale=1">` in layout
  - [ ] Add safe area support for iPhone notch:
    - `padding-top: env(safe-area-inset-top)`
    - `padding-bottom: env(safe-area-inset-bottom)`
  - [ ] Test on iPhone 14 Pro (notch) and iPhone SE (no notch)
  - [ ] Verify no content hidden behind notch or home indicator

- [ ] Cross-device testing (AC: #1-7)
  - [ ] Test on iPhone SE (375x667): All states, all interactions
  - [ ] Test on iPhone 14 (390x844): Landscape and portrait
  - [ ] Test on iPad (768x1024): Portrait and landscape
  - [ ] Test on iPad Pro (1024x1366): Desktop layout
  - [ ] Test on Android (Chrome DevTools device emulation)
  - [ ] Test on Samsung Galaxy S21 (360x800) if available
  - [ ] Verify no horizontal scrolling on any device

- [ ] Performance on mobile devices (AC: #1-7)
  - [ ] Test on real device (not just emulator)
  - [ ] Measure FPS during state transitions (target 60fps)
  - [ ] Measure Time to Interactive (TTI < 3s on 3G)
  - [ ] Test with throttled network (DevTools: Slow 3G)
  - [ ] Optimize images: WebP format, responsive sizes
  - [ ] Test animation performance (no jank on iPhone 12)

---

## Dev Notes

### Integration Points

**Components to Update:**
- `innovation-web/components/pipeline/PipelineStateMachine.tsx` - Add responsive container classes
- `innovation-web/components/pipeline/ExtractionAnimation.tsx` - Stack layout on mobile
- `innovation-web/components/pipeline/ThreeColumnLayout.tsx` - Responsive grid
- `innovation-web/components/pipeline/SparksGrid.tsx` - 1-column on mobile
- `innovation-web/components/pipeline/CollapsedSidebar.tsx` - Hide on mobile
- `innovation-web/components/pipeline/ExpandedSparkDetail.tsx` - Full width on mobile
- `innovation-web/components/pipeline/IconNavigation.tsx` - Compact mode
- `innovation-web/components/pipeline/ActionBar.tsx` - Stack buttons

**New Files to Create:**
- `innovation-web/components/pipeline/MobileSparkNavigationMenu.tsx` - Mobile hamburger menu
- `innovation-web/hooks/useBreakpoint.ts` - Responsive breakpoint detection
- `innovation-web/hooks/useSwipeable.ts` - Touch swipe gesture handler
- `innovation-web/lib/breakpoints.ts` - Breakpoint constants

**Tailwind Configuration:**
- Update `tailwind.config.js` with custom breakpoints if needed
- Ensure default breakpoints match design specs

**No Backend Changes Required**

### Technical Details

**Breakpoint Hook:**
```typescript
// hooks/useBreakpoint.ts
import { useEffect, useState } from 'react'

export const BREAKPOINTS = {
  mobile: 0,
  tablet: 768,
  desktop: 1024,
  wide: 1440
} as const

export type Breakpoint = keyof typeof BREAKPOINTS

export const useBreakpoint = (): Breakpoint => {
  const [breakpoint, setBreakpoint] = useState<Breakpoint>('desktop')

  useEffect(() => {
    const updateBreakpoint = () => {
      const width = window.innerWidth
      if (width >= BREAKPOINTS.wide) setBreakpoint('wide')
      else if (width >= BREAKPOINTS.desktop) setBreakpoint('desktop')
      else if (width >= BREAKPOINTS.tablet) setBreakpoint('tablet')
      else setBreakpoint('mobile')
    }

    updateBreakpoint()
    window.addEventListener('resize', updateBreakpoint)
    return () => window.removeEventListener('resize', updateBreakpoint)
  }, [])

  return breakpoint
}
```

**Responsive ThreeColumnLayout:**
```typescript
// components/pipeline/ThreeColumnLayout.tsx
export const ThreeColumnLayout = ({ signals, insights, sparks }: Props) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 p-4 md:p-6">
      <SignalsColumn data={signals} />
      <InsightsColumn data={insights} />
      <SparksPreviewColumn data={sparks} className="md:col-span-2 lg:col-span-1" />
    </div>
  )
}
```

**Mobile Navigation Menu:**
```typescript
// components/pipeline/MobileSparkNavigationMenu.tsx
import { useState } from 'react'
import { SparkCard } from './SparkCard'

interface Props {
  sparks: Spark[]
  selectedId: string
  onSelect: (id: string) => void
}

export const MobileSparkNavigationMenu = ({ sparks, selectedId, onSelect }: Props) => {
  const [isOpen, setIsOpen] = useState(false)

  return (
    <>
      {/* Hamburger Button */}
      <button
        className="fixed top-4 left-4 z-50 w-11 h-11 bg-white rounded-lg shadow-lg flex items-center justify-center lg:hidden"
        onClick={() => setIsOpen(!isOpen)}
        aria-label="Toggle navigation menu"
      >
        <span className={`hamburger-icon ${isOpen ? 'open' : ''}`}>☰</span>
      </button>

      {/* Slide-in Menu */}
      <div
        className={`fixed inset-0 z-40 lg:hidden transition-transform duration-300 ${
          isOpen ? 'translate-x-0' : '-translate-x-full'
        }`}
      >
        {/* Backdrop */}
        <div
          className="absolute inset-0 bg-black/50 backdrop-blur-sm"
          onClick={() => setIsOpen(false)}
        />

        {/* Menu Content */}
        <div className="absolute left-0 top-0 h-full w-4/5 bg-white shadow-xl overflow-y-auto">
          <div className="p-4 pt-16">
            <h2 className="text-xl font-bold mb-4">Sparks</h2>
            <div className="grid grid-cols-2 gap-2">
              {sparks.map((spark) => (
                <button
                  key={spark.id}
                  onClick={() => {
                    onSelect(spark.id)
                    setIsOpen(false)
                  }}
                  className={`aspect-video rounded-lg overflow-hidden border-2 ${
                    selectedId === spark.id ? 'border-[#5B9A99]' : 'border-gray-200'
                  }`}
                >
                  <img
                    src={spark.heroImageUrl}
                    alt={spark.title}
                    className="w-full h-full object-cover"
                  />
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>
    </>
  )
}
```

**Swipe Gesture Hook:**
```typescript
// hooks/useSwipeable.ts
import { useRef, TouchEvent } from 'react'

interface SwipeHandlers {
  onSwipeLeft?: () => void
  onSwipeRight?: () => void
  threshold?: number // Minimum distance in pixels (default: 50)
  timeThreshold?: number // Maximum duration in ms (default: 300)
}

export const useSwipeable = ({
  onSwipeLeft,
  onSwipeRight,
  threshold = 50,
  timeThreshold = 300
}: SwipeHandlers) => {
  const touchStart = useRef<{ x: number; y: number; time: number } | null>(null)

  const handleTouchStart = (e: TouchEvent) => {
    touchStart.current = {
      x: e.touches[0].clientX,
      y: e.touches[0].clientY,
      time: Date.now()
    }
  }

  const handleTouchEnd = (e: TouchEvent) => {
    if (!touchStart.current) return

    const deltaX = e.changedTouches[0].clientX - touchStart.current.x
    const deltaY = e.changedTouches[0].clientY - touchStart.current.y
    const deltaTime = Date.now() - touchStart.current.time

    // Ignore if too slow or vertical swipe
    if (deltaTime > timeThreshold || Math.abs(deltaY) > Math.abs(deltaX)) {
      touchStart.current = null
      return
    }

    // Detect horizontal swipe
    if (Math.abs(deltaX) > threshold) {
      if (deltaX > 0 && onSwipeRight) {
        onSwipeRight()
      } else if (deltaX < 0 && onSwipeLeft) {
        onSwipeLeft()
      }
    }

    touchStart.current = null
  }

  return {
    onTouchStart: handleTouchStart,
    onTouchEnd: handleTouchEnd
  }
}
```

**Safe Area Insets (iOS Notch):**
```css
/* In global CSS or Tailwind plugin */
.safe-top {
  padding-top: env(safe-area-inset-top);
}

.safe-bottom {
  padding-bottom: env(safe-area-inset-bottom);
}

.safe-left {
  padding-left: env(safe-area-inset-left);
}

.safe-right {
  padding-right: env(safe-area-inset-right);
}
```

**Tailwind Configuration Updates:**
```javascript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      screens: {
        'xs': '375px', // iPhone SE
        'sm': '640px', // Default Tailwind
        'md': '768px', // Tablets
        'lg': '1024px', // Laptops
        'xl': '1280px', // Desktops
        '2xl': '1440px', // Wide screens
      },
      fontSize: {
        'base': ['16px', '1.5'], // Mobile base
        'lg-base': ['18px', '1.6'], // Desktop base
      }
    }
  }
}
```

### Files Referenced

- `docs/front-end-spec.md` (lines 1117-1131) - Responsive breakpoints and state-specific behavior
- `innovation-web/tailwind.config.js` - Breakpoint configuration
- `innovation-web/app/layout.tsx` - Viewport meta tag

### Dependencies

**NPM Packages:**
- No new dependencies required (use native `TouchEvent` for swipes)
- Optional: `react-swipeable` (if preferred over custom hook)

**Depends On:**
- Story 8.1: Pipeline State Machine Foundation
- Story 8.2-8.5: All state components (must exist to make responsive)

### Testing

#### Test File Location
- `innovation-web/__tests__/responsive/breakpoints.test.tsx`
- `innovation-web/__tests__/responsive/mobile-layouts.test.tsx`
- `innovation-web/__tests__/interactions/swipe-gestures.test.tsx`

#### Testing Standards

**1. Breakpoint Detection Tests:**
- Resize window to 375px → `useBreakpoint()` returns 'mobile'
- Resize to 768px → returns 'tablet'
- Resize to 1024px → returns 'desktop'
- Resize to 1440px → returns 'wide'

**2. Layout Tests per State:**
- State 1 (375px): Two boxes stack vertically
- State 2 (375px): Three columns stack vertically
- State 3 (375px): Grid shows 1 column
- State 4 (375px): Sidebar hidden, hamburger visible

**3. Touch Target Size Tests:**
- All buttons ≥44x44px (use `toHaveStyle` with width/height)
- Spark cards clickable area ≥44x44px
- Navigation arrows ≥44x44px

**4. Typography Scaling:**
- Mobile (375px): Base font 16px
- Desktop (1024px): Base font 18px
- Headings scale correctly at each breakpoint

**5. Swipe Gesture Tests:**
- Swipe left 100px → `onSwipeLeft` called
- Swipe right 100px → `onSwipeRight` called
- Swipe <50px → No callback
- Swipe >300ms → No callback (too slow)
- Vertical swipe → No callback

**6. Safe Area Insets:**
- iPhone notch: Content not hidden behind notch
- Home indicator: Bottom bar above indicator

**7. Horizontal Scroll Prevention:**
- All states at 375px: No horizontal scrollbar
- Test with `window.scrollX === 0` after render

**8. Cross-Browser Mobile:**
- Chrome Android: All layouts correct
- Safari iOS: All layouts correct
- Firefox Android: All layouts correct

#### Testing Framework
- Jest + React Testing Library for component tests
- Playwright for end-to-end mobile testing (device emulation)
- Real device testing: iPhone SE, iPad, Android

#### Specific Testing Requirements

**Test: Mobile Layout State 3**
```typescript
test('State 3 shows 1-column grid on mobile', () => {
  window.innerWidth = 375

  const { container } = render(
    <SparksGrid sparks={mockSparks} onCardClick={jest.fn()} />
  )

  const grid = container.querySelector('.grid')
  expect(grid).toHaveClass('grid-cols-1')
  expect(grid).not.toHaveClass('md:grid-cols-2')
})
```

**Test: Swipe Gestures**
```typescript
test('swipe left navigates to next spark', () => {
  const onSwipeLeft = jest.fn()
  const { container } = render(
    <ExpandedSparkDetail spark={mockSpark} onSwipeLeft={onSwipeLeft} />
  )

  const element = container.firstChild as HTMLElement

  // Simulate swipe left
  fireEvent.touchStart(element, { touches: [{ clientX: 200, clientY: 100 }] })
  fireEvent.touchEnd(element, { changedTouches: [{ clientX: 50, clientY: 100 }] })

  expect(onSwipeLeft).toHaveBeenCalledTimes(1)
})
```

**Test: Hamburger Menu Opens**
```typescript
test('hamburger menu slides in on button click', async () => {
  const { getByLabelText, getByText } = render(
    <MobileSparkNavigationMenu sparks={mockSparks} selectedId="1" onSelect={jest.fn()} />
  )

  const hamburgerButton = getByLabelText('Toggle navigation menu')
  fireEvent.click(hamburgerButton)

  await waitFor(() => {
    const menu = getByText('Sparks').closest('div')
    expect(menu).not.toHaveClass('-translate-x-full')
  })
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation for Epic 8 polish phase | John (PM) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
