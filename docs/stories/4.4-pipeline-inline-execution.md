# Story 4.4: Pipeline In-Page Execution with Dynamic Track Movement

**Status:** Draft
**Priority:** High
**Estimated Effort:** 4-6 hours

## Problem Statement

When users click "Launch" on the analyze page (`/analyze/[uploadId]`), the application currently:
1. Navigates to a new page (`/pipeline/${runId}`) - causing tab switching
2. Loses the context of the intermediary card and track selection
3. Doesn't provide a smooth, dynamic transition for the non-selected track

**Expected Behavior:**
- Pipeline should start executing directly under the intermediary card on the same page
- Non-selected track should animate/slide dynamically to a left sidebar position
- Selected track should remain prominent in the main content area
- User stays on the same tab/page throughout the pipeline execution

## Root Cause Analysis

### Current Implementation Issues

1. **Tab Switching** (`app/analyze/[uploadId]/page.tsx:157`)
   ```typescript
   // Line 157 - causes navigation away from analyze page
   router.push(`/pipeline/${runId}`)
   ```

2. **Missing Dynamic Track Behavior**
   - Non-selected track is stored in sessionStorage
   - Only displayed AFTER navigation to pipeline page
   - No animation or transition on the analyze page itself

3. **Architecture Mismatch**
   - **Current Flow:** Analyze page → Navigate → Pipeline page → Show sidebar
   - **Desired Flow:** Analyze page → Execute inline → Dynamic layout transformation

## Solution Architecture

### High-Level Approach

Transform the analyze page into a stateful component that can display both:
- **Pre-launch state:** Document card + Track selection interface
- **Pipeline execution state:** Document card + Selected track (main) + Non-selected track (sidebar) + Pipeline stages

### Layout Transformation

**Before Launch:**
```
┌─────────────┬──────────────────────────┐
│  Document   │   Ideation Tracks        │
│   Card      │   ┌──────────────────┐   │
│             │   │ Track 1 (select) │   │
│             │   └──────────────────┘   │
│             │   ┌──────────────────┐   │
│             │   │ Track 2          │   │
│             │   └──────────────────┘   │
└─────────────┴──────────────────────────┘
           [Launch Button]
```

**After Launch (Dynamic Transition):**
```
┌────┬─────────────┬────────────────────────┐
│ N  │  Document   │  Selected Track        │
│ o  │   Card      │  (Track 1)             │
│ n  │             │                        │
│ -  │             │  ┌──────────────────┐  │
│ S  │             │  │ Stage Progress   │  │
│ e  │             │  │ Stage 1: ✓       │  │
│ l  │             │  │ Stage 2: ⏳      │  │
│ e  │             │  │ ...              │  │
│ c  │             │  └──────────────────┘  │
│ t  │             │                        │
│    │             │  [Detail Panel]        │
└────┴─────────────┴────────────────────────┘
```

## Implementation Plan

### 1. Create Reusable PipelineViewer Component

**File:** `components/pipeline/PipelineViewer.tsx` (new)

**Purpose:** Extract pipeline polling and visualization logic from `app/pipeline/[runId]/page.tsx` into a reusable component.

**Props:**
```typescript
interface PipelineViewerProps {
  runId: string
  onComplete?: (runId: string) => void
  onError?: (error: string) => void
  inlineMode?: boolean // Controls layout for embedded vs full-page
}
```

**Responsibilities:**
- Poll `/api/status/${runId}` for pipeline progress
- Display stage progress indicators
- Render detail panels for each stage
- Handle auto-redirect on completion (optional)
- Emit events for parent component state management

### 2. Modify Analyze Page State Management

**File:** `app/analyze/[uploadId]/page.tsx`

**State Additions:**
```typescript
const [isPipelineRunning, setIsPipelineRunning] = useState(false)
const [runId, setRunId] = useState<string | null>(null)
const [showSidebar, setShowSidebar] = useState(false)
```

**handleLaunch Modification:**
```typescript
const handleLaunch = async () => {
  // ... existing API call to /api/run

  const data = await response.json()
  const runId = data.run_id

  // REMOVE: router.push(`/pipeline/${runId}`)

  // ADD: Set local state instead
  setRunId(runId)
  setIsPipelineRunning(true)
  setShowSidebar(true)
  setLaunching(false)
}
```

### 3. Implement Dynamic Layout Rendering

**File:** `app/analyze/[uploadId]/page.tsx`

**Layout Logic:**
```typescript
// Conditional layout based on pipeline state
{!isPipelineRunning ? (
  // Original 2-column layout
  <div className="grid grid-cols-1 gap-8 lg:grid-cols-[280px_1fr]">
    {/* Document card + Tracks */}
  </div>
) : (
  // 3-column layout with sidebar
  <div className="grid grid-cols-1 gap-6 lg:grid-cols-[200px_280px_1fr]">
    {/* Non-selected track sidebar */}
    <AnimatedTrackSidebar track={nonSelectedTrack} />

    {/* Document card (unchanged) */}
    <DocumentCard {...} />

    {/* Selected track + Pipeline viewer */}
    <div>
      <PipelineTrackCard track={selectedTrack} />
      <PipelineViewer runId={runId} inlineMode />
    </div>
  </div>
)}
```

### 4. Add Track Movement Animation

**File:** `components/AnimatedTrackSidebar.tsx` (new)

**Approach Options:**

**Option A: Framer Motion**
```typescript
import { motion } from 'framer-motion'

<motion.div
  initial={{ x: 300, opacity: 0, scale: 1 }}
  animate={{ x: 0, opacity: 0.6, scale: 0.85 }}
  transition={{ duration: 0.6, ease: 'easeOut' }}
>
  <TrackCard {...} compactMode />
</motion.div>
```

**Option B: CSS Transitions** (lighter weight)
```typescript
<div className={cn(
  "transition-all duration-500 ease-out",
  showSidebar && "opacity-60 scale-90"
)}>
  <TrackCard {...} />
</div>
```

### 5. Update TrackCard Component (Optional Enhancement)

**File:** `components/TrackCard.tsx`

**Add compact mode support:**
```typescript
interface TrackCardProps {
  // ... existing props
  compactMode?: boolean
}

// Adjust styling for sidebar display
className={cn(
  'rounded-xl bg-white p-4',
  compactMode && 'p-2 text-sm'
)}
```

## Technical Considerations

### State Management
- Use local component state (no Redux needed for MVP)
- sessionStorage remains for cross-page navigation fallback
- Pipeline status polling reused from existing implementation

### Responsive Design
- Mobile: Stack layout vertically (no sidebar)
- Tablet: Sidebar collapses or hides
- Desktop: Full 3-column layout with animations

### Performance
- Polling interval: 5s (existing implementation)
- Debounce layout transitions
- Lazy load pipeline components

### Error Handling
- Pipeline failures show inline alerts
- Maintain ability to navigate to full pipeline page if needed
- Retry mechanisms for API failures

## Acceptance Criteria

- [ ] Clicking "Launch" does NOT navigate to new page/tab
- [ ] Pipeline visualization appears below tracks on analyze page
- [ ] Non-selected track animates smoothly to left sidebar position
- [ ] Selected track remains in main content area during execution
- [ ] Stage progress updates in real-time without page refresh
- [ ] Layout is responsive on mobile/tablet/desktop
- [ ] Animation performance is smooth (60fps target)
- [ ] Error states display inline without breaking layout
- [ ] Pipeline completion auto-navigates to results page
- [ ] Existing pipeline page (`/pipeline/[runId]`) still works for direct access

## Testing Strategy

### Unit Tests
- PipelineViewer component state management
- handleLaunch state updates (no navigation)

### Integration Tests
- Full launch → execution → completion flow on analyze page
- Layout transformations at each stage
- API polling and state updates

### Visual Regression Tests
- Animation smoothness
- Layout breakpoints (mobile/tablet/desktop)
- Track positioning before/during/after animation

### Manual Testing Checklist
1. Upload document → Analyze → See tracks
2. Click "Launch" → Verify stays on same page
3. Observe non-selected track slide to sidebar
4. Watch pipeline stages progress inline
5. Verify stage detail panels appear correctly
6. Complete pipeline → Auto-redirect to results
7. Test on mobile, tablet, desktop viewports

## Migration Notes

### Backward Compatibility
- Existing `/pipeline/[runId]` route remains functional
- Direct links to pipeline page still work
- sessionStorage logic preserved for fallback

### Deployment Strategy
1. Create new PipelineViewer component (non-breaking)
2. Update analyze page with feature flag (optional)
3. Test in staging environment
4. Deploy to production
5. Monitor for layout/animation issues

## Dependencies

### New Dependencies (Optional)
- `framer-motion` (if using Option A for animations) - 87KB gzipped
- OR use CSS-only transitions (Option B) - 0KB

### Existing Dependencies (Reuse)
- All pipeline polling logic
- Stage status calculations
- Detail panel components
- API routes (no changes needed)

## Time Estimates

| Task | Estimated Time |
|------|----------------|
| Create PipelineViewer component | 1.5 hours |
| Modify analyze page state/layout | 1.5 hours |
| Implement track animations | 1 hour |
| Responsive design adjustments | 1 hour |
| Testing and bug fixes | 1 hour |
| **Total** | **6 hours** |

## Future Enhancements

- Add "View Full Pipeline" button to expand to dedicated page
- Persist pipeline state in URL params for refresh handling
- Add keyboard shortcuts for navigation
- Implement WebSocket for real-time updates (replace polling)
- Add sound/notification on pipeline completion
- Track animation customization (speed, easing)

## Related Stories

- **Story 2.3:** Intermediary card implementation
- **Story 3.2:** Pipeline viewer implementation
- **Story 4.1:** Vertical pipeline viewer UI refinements
- **Story 4.2:** Results page opportunity cards

## References

### Current Implementation Files
- `app/analyze/[uploadId]/page.tsx:157` - Navigation issue location
- `app/pipeline/[runId]/page.tsx` - Source for pipeline logic
- `components/pipeline/IdeationTracksSidebar.tsx` - Sidebar track display
- `components/TrackCard.tsx` - Track card component
- `components/LeftSidebar.tsx` - Global sidebar (reference)

### API Endpoints (No Changes)
- `POST /api/run` - Launch pipeline
- `GET /api/status/[runId]` - Poll pipeline status

---

**Created:** 2025-10-19
**Last Updated:** 2025-10-19
**Author:** Development Team
**Reviewer:** Pending
