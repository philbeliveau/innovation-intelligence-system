# Pipeline Completion Race Condition - Opportunities Not Saving

**Date:** October 25, 2025
**Status:** ✅ RESOLVED
**Severity:** Critical - Data Loss Issue
**Component:** Pipeline Webhook System

## Summary

Opportunity cards generated by Stage 5 were not being saved to the database, causing the sidebar to show empty runs and the results page to have no data. This was caused by a race condition between the stage-update webhook and the completion webhook.

## Symptoms

1. **Sidebar Issues:**
   - Completed pipeline runs appeared in sidebar
   - But no opportunity cards were displayed
   - Run appeared "empty" despite successful completion

2. **Results Page Issues:**
   - `/results/[runId]` page had no opportunity data
   - No inspiration report data available
   - Stage outputs were saved, but opportunities missing

3. **Backend Logs:**
   - Stage 5 completed successfully: "5 opportunities generated"
   - Completion webhook called successfully (200 OK)
   - But frontend logs showed: "Run already completed (idempotent)"

## Root Cause Analysis

### The Race Condition

**Problematic Sequence:**

```
1. Backend completes Stage 5
   ↓
2. Backend calls POST /api/pipeline/{runId}/stage-update
   - Updates StageOutput[5] to COMPLETED ✅
   - ALSO marks PipelineRun.status = 'COMPLETED' ✅
   ↓
3. Backend calls POST /api/pipeline/{runId}/complete
   - Includes opportunities data
   - Checks: if (existingRun.status === 'COMPLETED') return early
   - Status IS already 'COMPLETED' from step 2
   - Returns: "Run already completed (idempotent)" ❌
   - SKIPS saving opportunities ❌
   ↓
4. Result: Opportunities never saved to database
```

### Code Location

**File:** `innovation-web/app/api/pipeline/[runId]/stage-update/route.ts`

**Problem Code (Lines 116-126):**
```typescript
// 6. If stage 5 is completed, update PipelineRun status to COMPLETED
if (stageNumber === 5 && status === 'COMPLETED') {
  await prisma.pipelineRun.update({
    where: { id: runId },
    data: {
      status: 'COMPLETED',
      completedAt: new Date()
    }
  })
  console.log(`[StageUpdate] Pipeline ${runId} marked as COMPLETED`)
}
```

This premature status update caused the `/complete` webhook to think it was a duplicate call.

## The Fix

### Solution

Remove the automatic `PipelineRun.status = 'COMPLETED'` update from the stage-update webhook. Let ONLY the completion webhook set the final status, which happens AFTER saving opportunities.

### Code Changes

**File:** `innovation-web/app/api/pipeline/[runId]/stage-update/route.ts`

**Before:**
```typescript
// 6. If stage 5 is completed, update PipelineRun status to COMPLETED
if (stageNumber === 5 && status === 'COMPLETED') {
  await prisma.pipelineRun.update({
    where: { id: runId },
    data: {
      status: 'COMPLETED',
      completedAt: new Date()
    }
  })
  console.log(`[StageUpdate] Pipeline ${runId} marked as COMPLETED`)
}
```

**After:**
```typescript
// 6. NOTE: Do NOT mark PipelineRun as COMPLETED here when stage 5 completes
//    The /complete webhook will handle final status update AND save opportunities
//    Marking as COMPLETED here creates a race condition where /complete sees
//    status=COMPLETED and skips saving opportunities (idempotent check)
```

### New Correct Sequence

```
1. Backend completes Stage 5
   ↓
2. Backend calls POST /api/pipeline/{runId}/stage-update
   - Updates StageOutput[5] to COMPLETED ✅
   - Does NOT mark PipelineRun as COMPLETED ✅
   ↓
3. Backend calls POST /api/pipeline/{runId}/complete
   - Checks: if (existingRun.status === 'COMPLETED') return early
   - Status is still 'PROCESSING' ✅
   - Continues to save opportunities ✅
   - THEN marks PipelineRun.status = 'COMPLETED' ✅
   ↓
4. Result: Opportunities saved successfully ✅
```

## Verification Steps

### Test the Fix

1. **Start a new pipeline run:**
   ```bash
   # Navigate to frontend
   # Upload a PDF
   # Click "Start Pipeline"
   ```

2. **Wait for completion:**
   - All 5 stages should complete
   - Check Railway logs for: "Successfully notified frontend of completion"

3. **Verify opportunities saved:**
   ```bash
   # Check Vercel logs:
   [Webhook] Validated 5/5 opportunities for database insertion
   [Webhook] Created 5/5 opportunity cards
   ```

4. **Check frontend:**
   - Sidebar shows run with opportunity count
   - Click run → opportunities display
   - Navigate to `/results/[runId]` → data loads

### Database Verification

Query to check opportunities were saved:
```sql
SELECT * FROM "OpportunityCard" WHERE "runId" = 'run-...' ORDER BY "number";
```

Should return 5 rows with:
- `title` populated
- `content` (markdown) populated
- `number` 1-5

## Related Issues

This fix also resolved:

1. **Empty Results Page:** `/results/[runId]` now loads opportunity data
2. **Sidebar Data Loss:** Completed runs now show opportunity counts
3. **Report Generation:** `InspirationReport` records now save correctly

## Context: Earlier Related Fix

This issue was discovered after fixing the **webhook authentication failure** (also Oct 25, 2025):

**Previous Issue:** Backend webhooks returned 401 Unauthorized
- **Cause:** `WEBHOOK_SECRET` mismatch between Railway and Vercel
- **Fix:** Updated Vercel production env var to match Railway

**This Issue:** Webhooks authenticated but opportunities still not saving
- **Cause:** Race condition between stage-update and complete webhooks
- **Fix:** Removed premature COMPLETED status update from stage-update

Both fixes were required for the pipeline to work end-to-end.

## Deployment

**Commit:** `9af4bec`
```
fix(pipeline): prevent race condition causing opportunities not to save
```

**Branch:** `architecture-cleanup-prisma`

**Deployed:** October 25, 2025, 18:10 UTC

**Production URL:** https://innovation-web-rho.vercel.app

## Testing Checklist

- [x] Webhook authentication works (no 401 errors)
- [x] Stage updates save correctly (all 5 stages)
- [x] Completion webhook called after stage 5
- [x] Opportunities saved to database (5/5 cards)
- [x] InspirationReport created with stage outputs
- [x] Sidebar displays runs with opportunity counts
- [x] Results page loads opportunity data
- [x] No "Run already completed (idempotent)" false positives

## Lessons Learned

1. **Webhook Order Matters:** When multiple webhooks update the same entity, ensure they don't conflict
2. **Idempotency Checks:** Be careful with idempotent checks - they can prevent legitimate operations
3. **Single Source of Truth:** Only one webhook should be responsible for final status updates
4. **Race Conditions:** Even with proper authentication, webhook timing can cause data loss
5. **Logging is Critical:** Detailed logs helped identify the "already completed" false positive

## Future Improvements

Consider these architectural improvements:

1. **Transaction-Based Completion:**
   - Wrap opportunity saving + status update in single database transaction
   - Ensures atomicity (all-or-nothing)

2. **Completion Lock:**
   - Use database lock to prevent duplicate completion calls
   - More robust than status-based idempotency check

3. **Retry Logic:**
   - If `/complete` webhook fails, backend should retry
   - Track completion attempts in database

4. **Monitoring:**
   - Add alert if opportunities.length > 0 but no cards saved
   - Track completion webhook success rate

## References

- **Pipeline Runner:** `backend/app/pipeline_runner.py`
- **Stage Update API:** `innovation-web/app/api/pipeline/[runId]/stage-update/route.ts`
- **Complete Webhook:** `innovation-web/app/api/pipeline/[runId]/complete/route.ts`
- **Related Docs:** `webhook-authentication-fix.md` (prerequisite)

---

**Resolution Status:** ✅ Fixed and Deployed
**Verified By:** Testing on production deployment
**Date Closed:** October 25, 2025
