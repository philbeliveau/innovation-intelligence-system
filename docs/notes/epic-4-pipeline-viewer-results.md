# Epic 4: Pipeline Viewer & Results - Brownfield Enhancement

## Epic Goal

Create a real-time horizontal pipeline visualization interface and results display system that enables users to watch the 5-stage innovation intelligence pipeline execute and view the generated opportunity cards, completing the end-to-end user experience for the Innovation Intelligence web application.

## Epic Description

### Existing System Context

**Current relevant functionality:**
- Existing Python pipeline processes documents through 5 stages (Input Processing, Signal Amplification, Universal Translation, Brand Contextualization, Opportunity Generation)
- Pipeline outputs markdown files and JSON data to `data/test-outputs/{run_id}/` filesystem structure
- Stage 1 outputs `inspirations.json` with 2 selected tracks
- Stage 5 outputs 5 markdown files (`opportunity-1.md` through `opportunity-5.md`)
- Pipeline logs execution progress to `pipeline.log`

**Technology stack:**
- Next.js 15 with App Router (React Server Components and Client Components)
- shadcn/ui component library (Card, Button, Badge, Progress, Separator)
- TypeScript with strict mode
- Tailwind CSS for styling
- Python 3.10+ backend pipeline (LangChain, OpenRouter API)

**Integration points:**
- Frontend polls `/api/status/[runId]` endpoint (created in Epic 3)
- Frontend reads pipeline output files from filesystem via API routes
- Stage 1 JSON output for track visualization
- Stage 5 markdown files for opportunity cards

### Enhancement Details

**What's being added/changed:**

This epic adds the final two pages of the user journey:

1. **Horizontal Pipeline Viewer (`/pipeline/[runId]`):**
   - Real-time visualization of 5-stage pipeline execution flowing left-to-right
   - Horizontal row of stage boxes showing status (pending ⌛, running ⏳, complete ✓)
   - Stage 1 displays 2 selected tracks matching `docs/image/track-division.png` UI
   - Current stage detail panel with progress updates
   - 5-second polling interval for status updates
   - Automatic redirect to results page when complete

2. **Results Page (`/app/results/[runId]`):**
   - Display 5 opportunity cards generated by Stage 5
   - Render markdown content with proper formatting (react-markdown)
   - XSS protection for markdown rendering
   - "New Pipeline" button to return to homepage
   - "Download PDF" button (initially disabled/placeholder)

**How it integrates:**

- **From Intermediary Card:** "Launch" button redirects to `/pipeline/[runId]`
- **Status Polling:** Frontend polls `/api/status/[runId]` every 5 seconds
- **Data Reading:**
  - Stage 1: Reads `inspirations.json` for track display
  - Stages 2-5: Parses `pipeline.log` for current stage detection
  - Results: Reads 5 markdown files from Stage 5 output
- **Navigation:** Automatic redirect to `/results/[runId]` when pipeline completes
- **Left Sidebar:** Collapsible home menu allows navigation back to upload page

**Success criteria:**

- ✅ Horizontal pipeline visualization displays all 5 stages
- ✅ Stage 1 shows 2 tracks in side-by-side layout matching reference design
- ✅ Status icons update in real-time (pending → running → complete)
- ✅ Current stage detail panel shows progress and descriptions
- ✅ Automatic redirect to results page when Stage 5 completes
- ✅ All 5 opportunity cards render with proper markdown formatting
- ✅ Navigation buttons work (New Pipeline, Download PDF)
- ✅ Left sidebar provides home navigation from any page
- ✅ No regression in existing upload/analysis flow

## Stories

### Story 4.1: Horizontal Pipeline Viewer UI

Build the `/pipeline/[runId]` page with real-time horizontal stage visualization, displaying Stage 1's 2 selected tracks and providing live progress updates through all 5 pipeline stages.

**Key components:**
- Horizontal stage indicator row (5 boxes with status icons)
- Stage 1 two-track card display (matching track-division.png)
- Current stage detail panel with progress bar
- Status polling logic (5-second interval with timeout protection)
- Stage transition animations

**Integration:**
- Polls `/api/status/[runId]` endpoint
- Reads `stage1/inspirations.json` for track data
- Detects current stage from log file
- Redirects to results page on completion

### Story 4.2: Results Page with Opportunity Cards

Create the `/results/[runId]` page that displays the 5 generated opportunity cards with properly formatted markdown content and navigation options.

**Key components:**
- Server component to read markdown files
- Markdown rendering with react-markdown
- XSS protection (disallow script, iframe, object, embed)
- Opportunity card layout (5 cards in vertical scroll)
- Action buttons (New Pipeline, Download PDF)

**Integration:**
- Reads files from `data/test-outputs/{runId}/stage5/opportunity-{1-5}.md`
- "New Pipeline" button redirects to `/` (homepage)
- "Download PDF" button (disabled placeholder for Phase 2)
- Error handling for missing files

### Story 4.3: Left Sidebar & Deployment Testing

Add a collapsible left sidebar for navigation and perform end-to-end deployment testing to validate the complete user journey.

**Key components:**
- Collapsible left sidebar with hover trigger
- Home button navigation
- Error boundary components
- End-to-end testing (upload → analyze → pipeline → results)
- Vercel deployment with environment variables

**Integration:**
- Sidebar accessible from all pages
- Click "Home" → navigate to `/upload`
- Error boundaries catch and display failures gracefully
- Full deployment on Vercel with production environment

## Compatibility Requirements

- [x] Existing APIs remain unchanged (`/api/upload`, `/api/analyze-document`, `/api/run`, `/api/status/[runId]`)
- [x] Python pipeline output formats unchanged (JSON for Stage 1, markdown for Stage 5)
- [x] File-based state storage pattern maintained (no database)
- [x] Company context from cookie preserved across navigation
- [x] UI patterns follow existing shadcn/ui component library
- [x] Performance: Status polling interval = 5 seconds (no server overload)

## Risk Mitigation

**Primary Risk:** Pipeline execution timeout (Vercel has 300s function limit, pipeline takes 15-30 minutes)

**Mitigation:**
- Pipeline runs in background via `exec()` (not synchronous `execSync()`)
- Frontend implements 35-minute timeout protection
- Status polling route is stateless and fast (< 1s response)
- Log parsing detects errors and sets status to "error"

**Rollback Plan:**
- Remove polling logic and display static "Processing..." message
- Provide manual refresh button to check status
- Add email notification when pipeline completes (Phase 2)

**Secondary Risk:** Stage 1 JSON parsing failure (malformed LLM output)

**Mitigation:**
- Fallback to displaying full markdown if JSON parse fails
- Show single card instead of two-track layout
- Log parsing errors for debugging

**Rollback Plan:**
- Disable track division UI
- Display Stage 1 output as plain text markdown

## Definition of Done

- [x] All 3 stories completed with acceptance criteria met
- [x] Horizontal pipeline viewer displays all 5 stages correctly
- [x] Stage 1 two-track UI matches `docs/image/track-division.png` reference
- [x] Status polling updates every 5 seconds with timeout protection
- [x] Results page displays 5 opportunity cards with formatted markdown
- [x] XSS protection implemented (react-markdown with disallowedElements)
- [x] Left sidebar navigation functional
- [x] Existing upload/analysis flow verified through testing
- [x] End-to-end test passes (upload → analyze → pipeline → results)
- [x] Deployed to Vercel with public URL
- [x] No console errors during demo
- [x] Mobile responsiveness (basic Tailwind responsive classes)

---

## Story Manager Handoff

**Please develop detailed user stories for this brownfield epic. Key considerations:**

**Existing System Context:**
- Enhancement to Innovation Intelligence web app running Next.js 15 + Python pipeline
- Integration points: API routes (`/api/status/[runId]`), filesystem output (`data/test-outputs/{run_id}/`)
- Existing patterns: shadcn/ui components, file-based state, polling architecture

**Critical Compatibility Requirements:**
- Must maintain 5-second polling interval (no server overload)
- Status detection via log file parsing (existing `/api/status` endpoint)
- Python pipeline output formats unchanged (JSON + markdown)
- Background execution pattern (no synchronous blocking)

**UI Reference Designs:**
- Horizontal pipeline layout: Flow left-to-right with status indicators
- Stage 1 tracks: Must match `docs/image/track-division.png` exactly
- Results cards: Clean markdown rendering with professional spacing

**Each story must include:**
- Verification that existing upload/analysis flow remains intact
- Error handling for missing files, malformed data, and timeouts
- Accessibility (keyboard navigation, screen reader support)
- Performance checks (polling frequency, markdown rendering speed)

**Epic Goal:** Complete the end-to-end user experience by enabling real-time pipeline observation and opportunity card review, maintaining system integrity while delivering a visually engaging demo-ready interface.

---

## Implementation Notes

**Hour Allocation (from Implementation Roadmap):**
- Hour 6-8: Pipeline Viewer UI (Story 4.1)
- Hour 8-9: Results Page (Story 4.2)
- Hour 9-10: Left Sidebar & Polish (Story 4.3)
- Hour 10-11: Deployment Testing (Story 4.3 continued)

**MCP Tool Usage:**
```typescript
// For Story 4.1 - Use mcp__magic__21st_magic_component_builder
// Prompt: "Create two side-by-side cards for displaying inspiration tracks,
// each with a title, content area, bullet points, and loading skeleton state"

// For Story 4.2 - Use shadcn/ui Card component
// Ensure XSS protection with react-markdown configuration
```

**Critical Dependencies:**
- Epic 3 must be complete (API routes for `/api/status/[runId]` functional)
- Python pipeline modified to output Stage 1 JSON (Epic 3)
- Vercel Blob integration working (Epic 1)
- Company context cookie mechanism functional (Epic 1)

**Testing Strategy:**
1. Manual testing with `savannah-bananas.pdf` + Lactalis brand
2. Verify all 5 stages complete successfully
3. Check markdown rendering for all 5 opportunity cards
4. Test timeout handling (kill pipeline mid-execution)
5. Test error scenarios (missing files, malformed JSON)

**Success Metrics:**
- Pipeline visualization updates smoothly (no UI freezing)
- All 5 opportunity cards render without errors
- End-to-end completion time: 15-30 minutes
- Demo-ready presentation quality achieved
