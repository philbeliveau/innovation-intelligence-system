generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Document {
  id         String   @id @default(uuid())
  userId     String
  fileName   String
  fileSize   Int
  blobUrl    String
  uploadedAt DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model InspirationReport {
  id               String      @id @default(uuid())
  runId            String      @unique
  selectedTrack    String
  nonSelectedTrack String
  stage1Output     String
  stage2Output     String
  stage3Output     String
  stage4Output     String
  stage5Output     String
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  run              PipelineRun @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model OpportunityCard {
  id        String      @id @default(uuid())
  runId     String
  number    Int
  title     String
  content   String
  isStarred Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  run       PipelineRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, number])
  @@index([runId, number])
  @@index([isStarred])
}

model PipelineRun {
  id                String             @id @default(uuid())
  userId            String
  documentName      String
  documentUrl       String?
  companyName       String
  status            RunStatus          @default(PROCESSING)
  pipelineVersion   String
  createdAt         DateTime           @default(now())
  completedAt       DateTime?
  duration          Int?

  // Stage Outputs - JSON storage for pipeline analysis data
  stage1Output       Json?              // { extractedText: string, mechanisms: array }
  stage2Output       Json?              // { signals: array }
  stage3Output       Json?              // { insights: array }
  stage4Output       Json?              // { preliminary: array }

  // Full Report - Complete markdown report
  fullReportMarkdown String?            @db.Text

  inspirationReport InspirationReport?
  opportunityCards  OpportunityCard[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  stageOutputs      StageOutput[]

  @@index([userId, createdAt])
  @@index([status])
}

model StageOutput {
  id          String      @id @default(uuid())
  runId       String
  stageNumber Int
  stageName   String
  status      RunStatus
  output      String
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  run         PipelineRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, stageNumber])
  @@index([runId, stageNumber])
}

model User {
  id           String        @id @default(uuid())
  clerkId      String        @unique
  email        String        @unique
  name         String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  documents    Document[]
  pipelineRuns PipelineRun[]

  @@index([clerkId])
}

enum RunStatus {
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
